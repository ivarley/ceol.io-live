<!DOCTYPE html>
<html lang="en"> 
<head>
    <title>{{ tune_name }} in {{ session_name }} - Irish Music Session Details</title>
    <style>
        .tune-info-section {
            margin: 20px 0;
        }
        .tune-info-section h3 {
            margin-bottom: 10px;
            color: #333;
        }
        .info-table {
            width: 100%;
            max-width: 600px;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .info-table th, .info-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        .info-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            width: 40%;
        }
        .instance-list {
            list-style: none;
            padding: 0;
        }
        .instance-list li {
            margin: 8px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .instance-date {
            font-weight: bold;
            color: #007bff;
        }
        .instance-details {
            font-size: 0.9em;
            color: #666;
            margin-top: 4px;
        }
        .override-info {
            font-style: italic;
            color: #856404;
        }
        .highlighted-instance {
            background-color: #fff3cd !important;
            border-left: 4px solid #ffc107;
        }
    </style>

    <!-- Meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="description" content="Tune Information">
    <link rel="shortcut icon" href="{{ url_for('static', filename='images/ceol.io.1.ico') }}" >
    
    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700&display=swap" rel="stylesheet">
    
    <!-- Theme CSS -->  
    <link id="theme-style" rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">

</head> 

<header class="header fixed-top">	    
    <div class="branding docs-branding">
        <div class="container-fluid position-relative py-2">
            <div class="docs-logo-wrapper">
                <div class="site-logo"><a class="navbar-brand" href="{{ url_for('hello_world') }}"><img width="150" src="{{ url_for('static', filename='images/logo1.png') }}" alt="logo"><span class="logo-text" style="font-weight: 50;">Traditional Irish Session Logs</span></a></div>
            </div><!--//docs-logo-wrapper-->
            <div class="docs-top-utilities d-flex justify-content-end align-items-center">
                <ul class="list-inline mx-md-3 mb-0 d-none d-lg-flex">
                    <!-- <li class="list-inline-item"><a href="#"><i class="fab fa-product-hunt fa-fw"></i></a></li> -->
                </ul><!--//social-list-->
            </div><!--//docs-top-utilities-->
        </div><!--//container-->
    </div><!--//branding-->
</header><!--//header-->

<body class="docs-page">    
    <div class="docs-wrapper">
	    <div class="docs-content">
        <div class="landing-page" style="display: block;">

    {% if session_instance_date %}
    <div style="margin-bottom: 20px;">
        <p><a href="/sessions/{{ session_path }}/{{ session_instance_date }}">← Back to {{ session_name }} on {{ session_instance_date }}</a></p>
    </div>
    {% endif %}

    <h1>Information about {{ alias or tune_name }} as played in {{ session_name }}</h1>
    
    {% if not session_instance_date %}
    <div style="margin-bottom: 20px;">
        <p><a href="/sessions/{{ session_path }}/tunes">← Back to tunes for {{ session_name }}</a></p>
    </div>
    {% endif %}
    
    <div class="tune-info-section">
        <h3>Tune Information</h3>
        <table class="info-table">
            <tr>
                <th>Tune Name</th>
                <td>
                    <a href="https://thesession.org/tunes/{{ tune_id }}" target="_blank">{{ tune_name }}</a>
                </td>
            </tr>
            {% if alias and alias != tune_name %}
            <tr>
                <th>Session Alias</th>
                <td>{{ alias }}</td>
            </tr>
            {% endif %}
            <tr>
                <th>Type</th>
                <td>{{ tune_type or 'Unknown' }}</td>
            </tr>
            <tr>
                <th>TheSession.org Popularity</th>
                <td>
                    <span id="tunebook-count">{{ tunebook_count }} tunebook{{ 's' if tunebook_count != 1 else '' }}</span>
                    <button id="refresh-tunebook" onclick="refreshTunebookCount()" style="margin-left: 10px; padding: 2px 6px; font-size: 0.8em; cursor: pointer;">refresh</button>
                </td>
            </tr>
        </table>
    </div>
    
    <div class="tune-info-section">
        <h3>Session-Specific Settings</h3>
        <table class="info-table">
            {% if setting_id %}
            <tr>
                <th>Preferred Setting</th>
                <td>
                    <a href="https://thesession.org/tunes/{{ tune_id }}#setting{{ setting_id }}" target="_blank">Setting #{{ setting_id }}</a>
                </td>
            </tr>
            {% endif %}
            {% if overridden_key %}
            <tr>
                <th>Preferred Key</th>
                <td>{{ overridden_key }}</td>
            </tr>
            {% endif %}
            {% if not setting_id and not overridden_key %}
            <tr>
                <td colspan="2" style="color: #666; font-style: italic;">No specific session preferences set</td>
            </tr>
            {% endif %}
        </table>
    </div>
    
    <div class="tune-info-section">
        <h3>Play History</h3>
        <p><strong>Total times played in this session:</strong> {{ play_count }}</p>
        
        {% if play_instances %}
        <h4>Session Instances:</h4>
        <ul class="instance-list">
            {% for instance in play_instances %}
            <li {% if session_instance_date and instance[0]|string == session_instance_date %}class="highlighted-instance"{% endif %}>
                <div class="instance-date">
                    <a href="/sessions/{{ session_path }}/{{ instance[0] }}">{{ instance[0] }}</a>
                </div>
                <div class="instance-details">
                    Position in set: #{{ instance[1] }}
                    {% if instance[2] or instance[3] or instance[4] %}
                        <div class="override-info">
                            {% if instance[2] %}
                                • Name: "{{ instance[2] }}"
                            {% endif %}
                            {% if instance[3] %}
                                • Key: {{ instance[3] }}
                            {% endif %}
                            {% if instance[4] %}
                                • Setting: #{{ instance[4] }}
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p style="color: #666; font-style: italic;">No instances recorded yet.</p>
        {% endif %}
    </div>
    
    <div style="margin-top: 30px;">
        <p><a href="/sessions/{{ session_path }}">← Back to {{ session_name }}</a></p>
        <p><a href="/sessions/{{ session_path }}/tunes">← Back to all tunes for this session</a></p>
    </div>

<!-- end landing page -->
</div>

</div>
</div>

<script>
function refreshTunebookCount() {
    const button = document.getElementById('refresh-tunebook');
    const countSpan = document.getElementById('tunebook-count');
    
    // Disable button and show loading state
    button.disabled = true;
    button.textContent = 'refreshing...';
    
    // Make API call
    fetch(`/api/sessions/{{ session_path }}/tunes/{{ tune_id }}/refresh_tunebook_count`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the display with new count
            const newCount = data.new_count;
            const suffix = newCount === 1 ? '' : 's';
            countSpan.textContent = `${newCount} tunebook${suffix}`;
            
            // Show a temporary success message
            if (data.old_count !== data.new_count) {
                button.textContent = 'updated!';
                button.style.backgroundColor = '#28a745';
                button.style.color = 'white';
            } else {
                button.textContent = 'unchanged';
                button.style.backgroundColor = '#6c757d';
                button.style.color = 'white';
            }
        } else {
            // Show error message
            button.textContent = 'error';
            button.style.backgroundColor = '#dc3545';
            button.style.color = 'white';
            console.error('Error:', data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        button.textContent = 'error';
        button.style.backgroundColor = '#dc3545';
        button.style.color = 'white';
    })
    .finally(() => {
        // Reset button after 2 seconds
        setTimeout(() => {
            button.disabled = false;
            button.textContent = 'refresh';
            button.style.backgroundColor = '';
            button.style.color = '';
        }, 2000);
    });
}
</script>

</body>
</html>