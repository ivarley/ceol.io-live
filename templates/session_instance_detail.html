<!DOCTYPE html>
<html lang="en"> 
<head>
    <title>{{ session_instance.session_name }} - {{ session_instance.date }} - Irish Music Session Details</title>
    <style>
        .message {
            position: fixed;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            border-radius: 6px;
            z-index: 1100;
            min-width: 300px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: top 0.3s ease-in-out;
        }
        .message.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .message.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .message.show {
            top: 20px;
        }
        .hidden {
            display: none;
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .loading-ellipsis {
            display: inline-block;
            color: #666;
        }
        .loading-ellipsis:after {
            content: '...';
            animation: ellipsis 1.5s infinite;
            width: 1em;
            text-align: left;
            display: inline-block;
        }
        @keyframes ellipsis {
            0% { content: ''; }
            25% { content: '.'; }
            50% { content: '..'; }
            75% { content: '...'; }
            100% { content: ''; }
        }
    </style>

    <!-- Meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="description" content="Index">
    <link rel="shortcut icon" href="{{ url_for('static', filename='images/ceol.io.1.ico') }}" >
    <!-- <link rel="shortcut icon" href="favicon.ico"> -->
    
    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700&display=swap" rel="stylesheet">
    
    <!-- Theme CSS -->  
    <link id="theme-style" rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">

</head> 

<header class="header fixed-top">	    
    <div class="branding docs-branding">
        <div class="container-fluid position-relative py-2">
            <div class="docs-logo-wrapper">
                <div class="site-logo"><a class="navbar-brand" href="{{ url_for('hello_world') }}"><img width="150" src="{{ url_for('static', filename='images/logo1.png') }}" alt="logo"><span class="logo-text" style="font-weight: 50;">Traditional Irish Session Logs</span></a></div>
            </div><!--//docs-logo-wrapper-->
            <div class="docs-top-utilities d-flex justify-content-end align-items-center">

                <ul class="list-inline mx-md-3 mb-0 d-none d-lg-flex">
                    <!-- <li class="list-inline-item"><a href="#"><i class="fab fa-product-hunt fa-fw"></i></a></li> -->
                </ul><!--//social-list-->
                
            </div><!--//docs-top-utilities-->
        </div><!--//container-->
    </div><!--//branding-->
</header><!--//header-->

<body class="docs-page">    
    <div class="docs-wrapper">
	    <div class="docs-content">
        <div class="landing-page" style="display: block;">

    <h1>{{ session_instance.session_name }}</h1>
    <h2>{{ session_instance.date }}</h2>
    
    <div id="message-container">
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                <div class="message success">
                    {% for message in messages %}
                        <p>{{ message }}</p>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
    </div>
    
    {% if session_instance.comments %}
    <div class="session-instance-comments">
        <h3>Notes from this session:</h3>
        <p>{{ session_instance.comments }}</p>
    </div>
    {% endif %}
    
    <div id="tunes-container">
        <h3>Tunes Played:</h3>
        <div id="tune-sets">
            <p>Loading tunes<span class="loading-ellipsis"></span></p>
        </div>
        
        <div id="add-tune-form" class="hidden" style="margin-top: 20px;">
            <form id="tune-form">
                <label for="tune_name_input">Add tune(s) by name:</label>
                <input type="text" id="tune_name_input" placeholder="Enter tune name or comma-separated names (e.g., Cooley's Reel or Cooley's, The Tarbolton)" required style="margin: 0 10px; width: 400px;">
                <button type="submit">Add</button>
            </form>
        </div>
    </div>
    
    <div style="margin-top: 30px;">
        <button id="toggle-edit-btn" style="background-color: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">Edit</button>
    </div>
    
    <p><a href="/sessions/{{ session_instance.session_path }}">‚Üê Back to this session</a></p>

    <script>
        const sessionPath = '{{ session_instance.session_path }}';
        const sessionDate = '{{ session_instance.date }}';
        let editMode = false;
        
        // Load tunes on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadTunes();
            updateUI();
        });
        
        // Toggle edit mode
        document.getElementById('toggle-edit-btn').addEventListener('click', function() {
            editMode = !editMode;
            updateUI();
        });
        
        // Handle add tune form submission
        document.getElementById('tune-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const tuneName = document.getElementById('tune_name_input').value.trim();
            if (tuneName) {
                addTune(tuneName);
            }
        });
        
        function updateUI() {
            const toggleBtn = document.getElementById('toggle-edit-btn');
            const addForm = document.getElementById('add-tune-form');
            
            if (editMode) {
                toggleBtn.textContent = 'View';
                toggleBtn.style.backgroundColor = '#007bff';
                addForm.classList.remove('hidden');
            } else {
                toggleBtn.textContent = 'Edit';
                toggleBtn.style.backgroundColor = '#28a745';
                addForm.classList.add('hidden');
            }
            
            loadTunes(); // Reload tunes to show/hide delete buttons
        }
        
        function showMessage(message, type = 'success') {
            const container = document.getElementById('message-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            
            container.innerHTML = '';
            container.appendChild(messageDiv);
            
            // Trigger animation by adding show class after a brief delay
            setTimeout(() => {
                messageDiv.classList.add('show');
            }, 10);
            
            // Auto-hide message after 3 seconds
            setTimeout(() => {
                messageDiv.classList.remove('show');
                // Remove from DOM after animation completes
                setTimeout(() => {
                    if (container.contains(messageDiv)) {
                        container.removeChild(messageDiv);
                    }
                }, 300);
            }, 3000);
        }
        
        function loadTunes() {
            const container = document.getElementById('tune-sets');
            container.classList.add('loading');
            
            fetch(`/api/sessions/${sessionPath}/${sessionDate}/tunes`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderTunes(data.tune_sets);
                    } else {
                        showMessage(data.message, 'error');
                    }
                })
                .catch(error => {
                    showMessage('Failed to load tunes', 'error');
                    console.error('Error:', error);
                })
                .finally(() => {
                    container.classList.remove('loading');
                });
        }
        
        function renderTunes(tuneSets) {
            const container = document.getElementById('tune-sets');
            
            if (!tuneSets || tuneSets.length === 0) {
                container.innerHTML = '<p>No tunes recorded for this session yet.</p>';
                return;
            }
            
            const ul = document.createElement('ul');
            
            tuneSets.forEach(tuneSet => {
                const li = document.createElement('li');
                
                tuneSet.forEach((tune, index) => {
                    const [orderNumber, continuesSet, tuneId, tuneName, setting] = tune;
                    
                    if (tuneId) {
                        let link = `https://thesession.org/tunes/${tuneId}`;
                        if (setting) {
                            link += `#setting${setting}`;
                        }
                        
                        const a = document.createElement('a');
                        a.href = link;
                        a.target = '_blank';
                        a.textContent = tuneName;
                        li.appendChild(a);
                    } else {
                        li.appendChild(document.createTextNode(tuneName));
                    }
                    
                    if (editMode) {
                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = '[x]';
                        deleteBtn.style.cssText = 'background: none; border: none; color: #dc3545; font-size: 0.8em; cursor: pointer; text-decoration: underline; margin-left: 5px;';
                        deleteBtn.onclick = function() {
                            if (confirm(`Delete ${tuneName}?`)) {
                                deleteTune(orderNumber);
                            }
                        };
                        li.appendChild(deleteBtn);
                    }
                    
                    if (index < tuneSet.length - 1) {
                        li.appendChild(document.createTextNode(', '));
                    }
                });
                
                ul.appendChild(li);
            });
            
            container.innerHTML = '';
            container.appendChild(ul);
        }
        
        function addTune(tuneName) {
            const form = document.getElementById('tune-form');
            form.classList.add('loading');
            
            fetch(`/api/sessions/${sessionPath}/${sessionDate}/add_tune`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ tune_name: tuneName })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message);
                    document.getElementById('tune_name_input').value = '';
                    loadTunes();
                } else {
                    showMessage(data.message, 'error');
                }
            })
            .catch(error => {
                showMessage('Failed to add tune', 'error');
                console.error('Error:', error);
            })
            .finally(() => {
                form.classList.remove('loading');
            });
        }
        
        function deleteTune(orderNumber) {
            const container = document.getElementById('tune-sets');
            container.classList.add('loading');
            
            fetch(`/api/sessions/${sessionPath}/${sessionDate}/delete_tune_by_order/${orderNumber}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message);
                    loadTunes();
                } else {
                    showMessage(data.message, 'error');
                }
            })
            .catch(error => {
                showMessage('Failed to delete tune', 'error');
                console.error('Error:', error);
            })
            .finally(() => {
                container.classList.remove('loading');
            });
        }
    </script>

<!-- end landing page -->
</div>

</div>
</div>

</body>
</html>