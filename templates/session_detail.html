{% extends "base.html" %}

{% block title %}{{ session.name }} - Irish Music Session Details{% endblock %}

{% block extra_css %}
<style>
        .session-details {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .session-details p {
            margin-bottom: 6px;
        }

        [data-theme="dark"] .session-details {
            background-color: #2a2a2a;
        }

        /* Tab styles */
        .tabs-container {
            margin-top: 20px;
        }

        .tab-buttons {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 10px;
        }

        .tab-button {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: var(--secondary-text);
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }

        .tab-button:hover {
            color: var(--text-color);
        }

        .tab-button.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            font-weight: 500;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Tunes tab styles */
        .tunes-container {
            width: 100%;
            margin: 0;
            padding: 20px;
        }

        .filters-container {
            padding: 6px;
            margin-bottom: 10px;
        }

        .filter-row {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: nowrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            min-width: 0;
        }

        .filter-group:first-child {
            flex: 1;
            min-width: 0;
        }

        .filter-input {
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            background-color: var(--bg-color);
            color: var(--text-color);
            width: 100%;
            min-width: 0;
            max-width: 200px;
        }

        .filter-select {
            padding: 8px 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            background-color: var(--bg-color);
            color: var(--text-color);
            cursor: pointer;
            width: 110px;
            flex-shrink: 0;
        }

        .results-count {
            margin-bottom: 15px;
            color: var(--text-muted, #6c757d);
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .sort-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sort-label {
            color: var(--text-color);
            font-size: 14px;
            white-space: nowrap;
        }

        .sort-toggle {
            padding: 4px 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--bg-color);
            color: var(--text-color);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
            user-select: none;
        }

        .sort-toggle:hover {
            background-color: var(--hover-bg);
        }

        .sort-toggle-text {
            display: none;
        }

        #sort-icon {
            filter: grayscale(100%);
        }

        .tunes-list {
            display: block;
            margin-bottom: 30px;
        }

        .tune-row {
            background-color: var(--bg-color);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 8px;
            transition: background-color 0.1s;
            cursor: pointer;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 12px;
            align-items: center;
        }

        .tune-row:first-child {
            border-top: 1px solid var(--border-color);
        }

        .tune-row:hover {
            background-color: var(--hover-bg);
        }

        .tune-row-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 0;
            grid-column: 1;
            min-width: 0;
        }

        .tune-name {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-color);
            margin: 0;
            flex: 0 0 auto;
            max-width: 275px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .tune-type {
            font-size: 11px;
            padding: 3px 6px;
            background-color: var(--primary);
            color: white;
            border-radius: 3px;
            text-transform: capitalize;
            white-space: nowrap;
            margin-left: 0;
        }

        .tune-meta {
            display: flex;
            flex-direction: row;
            gap: 8px;
            margin-bottom: 0;
            font-size: 13px;
            align-items: center;
            grid-column: 2;
            justify-content: flex-end;
        }

        .tune-count-badge {
            font-size: 11px;
            padding: 3px 6px;
            background-color: var(--secondary-text, #6c757d);
            color: white;
            border-radius: 3px;
            white-space: nowrap;
        }

        /* Loading dots animation */
        .loading-dots {
            font-weight: bold;
            display: inline-block;
            animation: pulse-dots 1.5s ease-in-out infinite;
        }

        @keyframes pulse-dots {
            0%, 100% {
                opacity: 0.3;
            }
            50% {
                opacity: 1;
            }
        }

        /* TheSession link icon */
        .thesession-link-icon {
            font-size: 18px;
            text-decoration: none;
            color: var(--primary);
            opacity: 0.8;
        }

        .thesession-link-icon:hover {
            opacity: 1;
        }

        .modal-tune-link {
            display: inline-block;
            color: var(--primary);
            text-decoration: none;
            margin-top: 12px;
            padding: 6px 12px;
            border: 1px solid var(--primary);
            border-radius: 4px;
            font-size: 14px;
        }

        .modal-tune-link:hover {
            background-color: var(--primary);
            color: white;
            text-decoration: none;
        }

        .modal-tune-title {
            margin: 0 32px 12px 0;
            color: var(--text-color);
            font-size: 22px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-info-line {
            color: var(--text-muted, #6c757d);
            font-size: 16px;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .modal-info-line strong {
            color: var(--text-color);
            font-weight: 600;
        }

        .modal-dialog {
            background: var(--bg-color, white);
            border-radius: 8px;
            padding: 0;
            max-width: 600px;
            width: 90%;
            height: calc(100vh - 80px);
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            color: var(--text-color);
            position: relative;
            pointer-events: auto;
            z-index: 1;
            overflow: hidden;
        }

        #tune-detail-content {
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .modal-info-section {
            flex-shrink: 0;
        }

        .modal-play-history {
            flex: 1;
            overflow-y: auto;
            margin-top: 12px;
            padding-right: 8px;
        }

        .modal-play-history::-webkit-scrollbar {
            width: 8px;
        }

        .modal-play-history::-webkit-scrollbar-track {
            background: var(--hover-bg, #f8f9fa);
            border-radius: 4px;
        }

        .modal-play-history::-webkit-scrollbar-thumb {
            background: var(--border-color, #dee2e6);
            border-radius: 4px;
        }

        .modal-play-history::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-text, #6c757d);
        }

        .modal-close-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            font-size: 28px;
            color: var(--text-muted, #999);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }

        .modal-close-btn:hover {
            color: var(--text-color);
        }

        @media (max-width: 768px) {
            .tunes-container {
                padding: 0;
                max-width: 100%;
                margin: 0;
            }

            .filters-container {
                padding: 8px;
            }

            .filter-input {
                font-size: 16px;
                padding: 8px 6px;
                max-width: none;
                height: 40px;
                box-sizing: border-box;
            }

            .filter-select {
                font-size: 13px;
                padding: 8px 4px;
                width: 85px;
                height: 40px;
                box-sizing: border-box;
            }

            .results-count {
                margin-bottom: 4px;
                padding: 0 8px;
                font-size: 12px;
                gap: 6px;
            }

            .sort-toggle {
                font-size: 11px;
                padding: 3px 6px;
            }

            .tune-row {
                border-radius: 0;
                border-left: none;
                border-right: none;
                border-top: none;
                padding: 8px 8px;
                margin: 0;
            }

            .tune-name {
                font-size: 18px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                min-width: 0;
                max-width: calc(100vw - 100px);
            }

            .tune-type {
                font-size: 12px;
                padding: 2px 6px;
            }

            .modal-dialog {
                width: 100%;
                max-width: 100%;
                height: calc(100vh - 40px);
                margin: 0;
                margin-top: 40px;
                border-radius: 0;
                position: fixed;
                right: 0;
                top: 0;
                transform: translateX(100%);
                transition: transform 0.3s ease-out;
                box-shadow: -4px 0 12px rgba(0,0,0,0.2);
                pointer-events: auto;
                padding-left: 16px;
                padding-right: 16px;
                box-sizing: border-box;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }

            .modal-overlay.show .modal-dialog {
                transform: translateX(0);
            }

            #tune-detail-content {
                padding: 16px 0;
                box-sizing: border-box;
                display: flex;
                flex-direction: column;
                height: 100%;
                overflow: hidden;
            }

            .modal-close-btn {
                position: fixed;
                top: 8px;
                right: 8px;
                font-size: 0;
                width: 40px;
                height: 40px;
                background-color: var(--bg-color);
                border: 1px solid var(--border-color);
                border-radius: 4px;
                z-index: 10001;
            }

            .modal-close-btn::before {
                content: '>';
                font-size: 24px;
                font-weight: bold;
                color: var(--text-color);
            }
        }

        @media (min-width: 769px) {
            .sort-label {
                display: block;
            }

            .sort-toggle-text {
                display: inline;
            }
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--dropdown-shadow);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: var(--bg-color, white);
            border-radius: 8px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 8px 24px var(--dropdown-shadow);
            color: var(--text-color);
        }
        .modal-header {
            margin-bottom: 16px;
        }
        .modal-header h3 {
            margin: 0;
            color: var(--text-color);
        }
        .modal-body {
            margin-bottom: 20px;
        }
        .modal-body label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--text-color);
        }
        .modal-body input[type="date"],
        .modal-body input[type="text"],
        .modal-body textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
            font-family: inherit;
        }
        .modal-footer {
            text-align: right;
        }
        .modal-footer button {
            margin-left: 8px;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .modal-footer .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        .modal-footer .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }
        .modal-footer button:hover {
            opacity: 0.9;
        }
        .add-link {
            color: var(--primary);
            text-decoration: none;
            margin-left: 10px;
            font-size: 0.9em;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            cursor: pointer;
        }
        .add-link:hover {
            text-decoration: underline;
        }
        .session-logs-heading:hover .add-link,
        .session-title-heading:hover .add-link {
            opacity: 1;
        }
        .modal-body form {
            max-height: 70vh;
            overflow-y: auto;
        }
        .modal-body input:focus,
        .modal-body textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        
        /* Dark mode styles for modal form elements */
        [data-theme="dark"] .modal-body input[type="date"],
        [data-theme="dark"] .modal-body input[type="text"],
        [data-theme="dark"] .modal-body textarea {
            background-color: var(--dropdown-bg);
            border-color: var(--border-color);
            color: var(--text-color);
        }
        
        [data-theme="dark"] .modal-body input:focus,
        [data-theme="dark"] .modal-body textarea:focus {
            background-color: var(--dropdown-bg);
            border-color: var(--primary);
            color: var(--text-color);
        }
        
        [data-theme="dark"] .modal-body label {
            color: var(--text-color);
        }
        @media (max-width: 767.98px) {
            .popular-tunes div[style*="display: flex"] {
                gap: 0 !important;
            }
            .popular-tunes div[style*="flex: 1"] {
                margin-top: 0 !important;
                margin-bottom: 0 !important;
            }
            .popular-tunes ol {
                margin-bottom: 0 !important;
            }
        }
        
        /* Year section toggle styles */
        .year-section {
            margin-bottom: 1.5rem;
        }
        
        .year-header {
            display: flex;
            align-items: center;
            cursor: pointer;
            margin-bottom: 0.5rem;
            user-select: none;
        }
        
        .year-header:hover {
            opacity: 0.8;
        }
        
        .year-header-left {
            display: flex;
            align-items: center;
        }
        
        .year-toggle {
            display: inline-block;
            margin-right: 0.5rem;
            transition: transform 0.2s ease;
            font-size: 0.85rem;
            color: var(--disabled-text);
            font-weight: bold;
        }
        
        .year-toggle.collapsed {
            transform: rotate(-90deg);
        }
        
        .year-title {
            margin: 0;
            font-size: 1.17rem;
            font-weight: bold;
            color: var(--text-color);
        }
        
        .year-view-link {
            font-size: 0.9rem;
            color: var(--primary);
            text-decoration: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
            margin-left: 0.5rem;
        }
        
        .year-view-link.visible {
            opacity: 1;
            pointer-events: auto;
        }
        
        .year-view-link:hover {
            text-decoration: underline;
        }
        
        .year-content {
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            max-height: 1000px;
            opacity: 1;
        }
        
        .year-content.collapsed {
            max-height: 0;
            opacity: 0;
            margin-bottom: 0;
        }
        
        .year-content ul {
            margin-bottom: 0;
        }
    </style>
{% endblock %}

{% block content %}
<div class="landing-page" style="display: block;">

    <h1 class="session-title-heading">{{ session.name }} <a href="/sessions" style="color: var(--border-color, #dee2e6); text-decoration: none; margin-left: 10px; font-size: 0.6em; transition: color 0.2s ease;" onmouseover="this.style.color='var(--primary, #007bff)'" onmouseout="this.style.color='var(--border-color, #dee2e6)'">‚Æê</a>{% if is_session_admin %}<a href="/admin/sessions/{{ session.path }}" class="add-link">Admin</a>{% endif %}</h1>

    <div class="session-details">
        {% if session.location_name and session.location_name != session.name %}
        <p><strong>Location:</strong> {{ session.location_name }}</p>
        {% endif %}

        <p>{% if session.unlisted_address %}(unlisted address), {% else %}{% if session.location_street %}{{ session.location_street }}, {% endif %}{% endif %}{{ session.city }}, {{ session.state }}, {{ session.country }}{% if session.location_phone %} ‚Ä¢ {{ session.location_phone }}{% endif %}{% if session.location_website %} ‚Ä¢ <a href="{{ session.location_website }}" target="_blank">Web</a>{% endif %}{% if session.thesession_id %} ‚Ä¢ <a href="https://thesession.org/sessions/{{ session.thesession_id }}" target="_blank">thesession.org</a>{% endif %}</p>

        {% if session.recurrence_readable %}
        <p><strong>Schedule:</strong> {{ session.recurrence_readable }}</p>
        {% endif %}

        {% if session.comments %}
        <p><strong>About this session:</strong> {{ session.comments }}</p>
        {% endif %}
    </div>

    <div id="message-container">
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                <div class="message success">
                    {% for message in messages %}
                        <p>{{ message }}</p>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
    </div>

    <!-- Tabbed Interface -->
    <div class="tabs-container">
        <div class="tab-buttons">
            <button class="tab-button active" data-tab="tunes">Tunes</button>
            <button class="tab-button" data-tab="logs">Logs</button>
        </div>

        <!-- Tunes Tab Content -->
        <div class="tab-content active" id="tunes-tab">
            <div class="tunes-container">
                <div class="filters-container">
                    <div class="filter-row">
                        <div class="filter-group">
                            <input type="text" id="tune-search" class="filter-input" placeholder="Search" autocomplete="off">
                        </div>
                        <div class="filter-group">
                            <select id="type-filter" class="filter-select" title="Tune type">
                                <option value="">All Types</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="results-count">
                    <span id="results-count-text"></span>
                    <div class="sort-controls">
                        <span class="sort-label">Sort by:</span>
                        <button id="sort-toggle" class="sort-toggle" title="Toggle sort order">
                            <span id="sort-icon">üëÇ</span>
                            <span id="sort-text" class="sort-toggle-text"></span>
                            <span id="sort-arrow"></span>
                        </button>
                    </div>
                </div>

                <div class="tunes-list" id="tunes-list">
                    <!-- Tune rows will be inserted here by JavaScript -->
                </div>
            </div>

            <!-- Tune Detail Modal -->
            <div id="tune-detail-modal" class="modal-overlay">
                <div class="modal-dialog">
                    <div id="tune-detail-content">
                        <!-- Content will be inserted by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs Tab Content -->
        <div class="tab-content" id="logs-tab">
            {% if instances_by_year %}
            <div class="past-instances">
                <h2 class="session-logs-heading">Session Logs:{% if is_logged_in %}<span class="add-link" id="add-session-btn">Add</span>{% endif %}</h2>
        {% if sorted_years|length > 1 %}
            {% for year in sorted_years %}
            <div class="year-section">
                <div class="year-header" data-year="{{ year }}">
                    <div class="year-header-left">
                        <span class="year-toggle" data-year="{{ year }}">‚ñº</span>
                        <h3 class="year-title">{{ year }}</h3>
                        <a href="#" class="year-view-link" data-year="{{ year }}">view {{ instances_by_year[year]|length }} log{{ 's' if instances_by_year[year]|length != 1 else '' }}</a>
                    </div>
                </div>
                <div class="year-content" data-year="{{ year }}">
                    <ul>
                    {% for date in instances_by_year[year] %}
                        <li><a href="/sessions/{{ session.path }}/{{ date }}">{{ date }}</a></li>
                    {% endfor %}
                    </ul>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <ul>
            {% for year in sorted_years %}
                {% for date in instances_by_year[year] %}
                <li><a href="/sessions/{{ session.path }}/{{ date }}">{{ date }}</a></li>
                {% endfor %}
            {% endfor %}
            </ul>
        {% endif %}
    </div>
    {% else %}
    <div class="past-instances">
        <h2>Session Logs:</h2>
        <p><a href="#" id="add-first-session-btn" style="color: var(--primary); text-decoration: none;">Add your first session log</a></p>
    </div>
    {% endif %}
        </div>
    </div>

    <!-- Add Session Instance Modal -->
    <div id="add-session-instance-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Session Instance</h3>
            </div>
            <div class="modal-body">
                <label for="session-date-input">Session Date:</label>
                <input type="date" id="session-date-input" required>
                
                <label for="session-location-input" style="margin-top: 16px;">Location:</label>
                <input type="text" id="session-location-input" placeholder="The usual: {{ session.location_name }}">
                
                <label for="session-comments-input" style="margin-top: 16px;">Comments:</label>
                <textarea id="session-comments-input" placeholder="Notes about this session" rows="3" style="resize: vertical;"></textarea>
                
                <div style="margin-top: 16px;">
                    <label style="display: flex; align-items: center; font-weight: normal;">
                        <input type="checkbox" id="session-cancelled-input" style="margin-right: 8px; width: auto;">
                        Cancelled?
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="add-session-cancel-btn">Cancel</button>
                <button type="button" class="btn-primary" id="add-session-confirm-btn">Add Session</button>
            </div>
        </div>
    </div>


<!-- end landing page -->
</div>

</div>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/dist/modalManager.js"></script>
<script>
    const sessionPath = '{{ session.path }}';
    const sessionRecurrence = {{ session.recurrence|tojson if session.recurrence else 'null' }};
    const isLoggedIn = {{ 'true' if is_logged_in else 'false' }};
    
    // Get most recent session date
    const recentDates = [
        {% if instances_by_year %}
            {% for year in sorted_years %}
                {% for date in instances_by_year[year] %}
                    '{{ date }}',
                {% endfor %}
            {% endfor %}
        {% endif %}
    ];
    
    
    function calculateNextSessionDate() {
        if (recentDates.length === 0) {
            return new Date().toISOString().split('T')[0];
        }

        // Parse the date string properly - dates from the template are in 'YYYY-MM-DD' format
        const mostRecentDateStr = recentDates[0];
        const mostRecentDate = new Date(mostRecentDateStr + 'T00:00:00');

        if (!sessionRecurrence) {
            // No recurrence info, suggest one week from most recent
            const nextDate = new Date(mostRecentDate);
            nextDate.setDate(nextDate.getDate() + 7);
            return nextDate.toISOString().split('T')[0];
        }

        // Try to parse as JSON first
        if (typeof sessionRecurrence === 'object' && sessionRecurrence.schedules) {
            // JSON format - find next occurrence based on schedules
            const schedules = sessionRecurrence.schedules;
            if (schedules && schedules.length > 0) {
                // Start from the day after the most recent session
                let candidateDate = new Date(mostRecentDate);
                candidateDate.setDate(candidateDate.getDate() + 1);

                const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];

                // Find the next date that matches any schedule (within the next 90 days)
                const maxDaysToCheck = 90;
                for (let i = 0; i < maxDaysToCheck; i++) {
                    const dayOfWeek = candidateDate.getDay();
                    const dayName = dayNames[dayOfWeek];

                    // Check if this day matches any schedule
                    for (const schedule of schedules) {
                        if (schedule.weekday === dayName) {
                            if (schedule.type === 'weekly') {
                                // For weekly schedules, check if it matches the interval
                                if (schedule.every_n_weeks === 1) {
                                    // Every week - always matches
                                    return candidateDate.toISOString().split('T')[0];
                                } else {
                                    // Every N weeks - we can't determine without reference date
                                    // So we conservatively assume it matches
                                    return candidateDate.toISOString().split('T')[0];
                                }
                            } else if (schedule.type === 'monthly_nth_weekday') {
                                // Check if this is the correct nth occurrence
                                const dayOfMonth = candidateDate.getDate();
                                const firstDayOfMonth = new Date(candidateDate.getFullYear(), candidateDate.getMonth(), 1);
                                const firstWeekdayOfMonth = firstDayOfMonth.getDay();

                                // Calculate which occurrence this is
                                let occurrenceNum = Math.floor((dayOfMonth - 1 + firstWeekdayOfMonth) / 7) + 1;

                                // Check for last occurrence
                                const lastDayOfMonth = new Date(candidateDate.getFullYear(), candidateDate.getMonth() + 1, 0);
                                const isLastOccurrence = dayOfMonth + 7 > lastDayOfMonth.getDate();

                                if (schedule.which && Array.isArray(schedule.which)) {
                                    if (schedule.which.includes(occurrenceNum) ||
                                        (isLastOccurrence && schedule.which.includes(-1))) {
                                        return candidateDate.toISOString().split('T')[0];
                                    }
                                }
                            }
                        }
                    }

                    // Move to next day
                    candidateDate.setDate(candidateDate.getDate() + 1);
                }

                // If no match found in 90 days, default to 7 days from most recent
                const nextDate = new Date(mostRecentDate);
                nextDate.setDate(nextDate.getDate() + 7);
                return nextDate.toISOString().split('T')[0];
            }
        }

        // Legacy text parsing fallback
        const recurrence = typeof sessionRecurrence === 'string'
            ? sessionRecurrence.toLowerCase()
            : '';
        const nextDate = new Date(mostRecentDate);

        if (recurrence.includes('weekly') || recurrence.includes('every week')) {
            nextDate.setDate(nextDate.getDate() + 7);
        } else if (recurrence.includes('biweekly') || recurrence.includes('every other week') || recurrence.includes('every 2 weeks')) {
            nextDate.setDate(nextDate.getDate() + 14);
        } else if (recurrence.includes('monthly') || recurrence.includes('every month')) {
            nextDate.setMonth(nextDate.getMonth() + 1);
        } else if (recurrence.includes('tuesday') || recurrence.includes('tues')) {
            // Find next Tuesday after the most recent session date
            nextDate.setDate(nextDate.getDate() + 1); // Start from the day after the last session
            while (nextDate.getDay() !== 2) { // 2 = Tuesday
                nextDate.setDate(nextDate.getDate() + 1);
            }
        } else if (recurrence.includes('wednesday') || recurrence.includes('wed')) {
            nextDate.setDate(nextDate.getDate() + 1);
            while (nextDate.getDay() !== 3) { // 3 = Wednesday
                nextDate.setDate(nextDate.getDate() + 1);
            }
        } else if (recurrence.includes('thursday') || recurrence.includes('thurs')) {
            nextDate.setDate(nextDate.getDate() + 1);
            while (nextDate.getDay() !== 4) { // 4 = Thursday
                nextDate.setDate(nextDate.getDate() + 1);
            }
        } else if (recurrence.includes('friday') || recurrence.includes('fri')) {
            nextDate.setDate(nextDate.getDate() + 1);
            while (nextDate.getDate() !== 5) { // 5 = Friday
                nextDate.setDate(nextDate.getDate() + 1);
            }
        } else if (recurrence.includes('saturday') || recurrence.includes('sat')) {
            nextDate.setDate(nextDate.getDate() + 1);
            while (nextDate.getDay() !== 6) { // 6 = Saturday
                nextDate.setDate(nextDate.getDate() + 1);
            }
        } else if (recurrence.includes('sunday') || recurrence.includes('sun')) {
            nextDate.setDate(nextDate.getDate() + 1);
            while (nextDate.getDay() !== 0) { // 0 = Sunday
                nextDate.setDate(nextDate.getDate() + 1);
            }
        } else if (recurrence.includes('monday') || recurrence.includes('mon')) {
            nextDate.setDate(nextDate.getDate() + 1);
            while (nextDate.getDay() !== 1) { // 1 = Monday
                nextDate.setDate(nextDate.getDate() + 1);
            }
        } else {
            // Default: one week from most recent
            nextDate.setDate(nextDate.getDate() + 7);
        }

        return nextDate.toISOString().split('T')[0];
    }
    
    function showAddSessionModal() {
        // Prepare form fields (page-specific business logic)
        const dateInput = document.getElementById('session-date-input');
        const locationInput = document.getElementById('session-location-input');
        const commentsInput = document.getElementById('session-comments-input');
        const cancelledInput = document.getElementById('session-cancelled-input');
        
        // Pre-fill the date input with suggested next session date
        dateInput.value = calculateNextSessionDate();
        
        // Clear other fields
        locationInput.value = '';
        commentsInput.value = '';
        cancelledInput.checked = false;
        
        // Show modal using ModalManager
        ModalManager.showModal('add-session-instance-modal', {
            autoFocus: false // We'll focus manually
        });
        
        dateInput.focus();
    }
    
    function hideAddSessionModal() {
        ModalManager.hideModal('add-session-instance-modal');
    }
    
    function addSessionInstance() {
        const dateInput = document.getElementById('session-date-input');
        const locationInput = document.getElementById('session-location-input');
        const commentsInput = document.getElementById('session-comments-input');
        const cancelledInput = document.getElementById('session-cancelled-input');
        
        const date = dateInput.value.trim();
        const location = locationInput.value.trim();
        const comments = commentsInput.value.trim();
        const cancelled = cancelledInput.checked;
        
        if (!date) {
            showMessage('Please enter a session date', 'error');
            return;
        }
        
        // Prepare request data
        const requestData = { 
            date: date,
            cancelled: cancelled
        };
        
        // Only include location if it's provided
        if (location) {
            requestData.location = location;
        }
        
        // Only include comments if provided
        if (comments) {
            requestData.comments = comments;
        }
        
        // Call API to create the session instance
        fetch(`/api/sessions/${sessionPath}/add_instance`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage(data.message);
                hideAddSessionModal();
                // Redirect to the new session instance with edit mode parameter
                window.location.href = `/sessions/${sessionPath}/${date}?edit=true`;
            } else {
                showMessage(data.message, 'error');
            }
        })
        .catch(error => {
            showMessage('Failed to add session instance', 'error');
            console.error('Error:', error);
        });
    }
    

    
    // Close modals on escape key
    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
            // Check if tune detail modal is open
            const tuneModal = document.getElementById('tune-detail-modal');
            if (tuneModal && tuneModal.style.display === 'flex') {
                closeTuneDetailModal();
                return;
            }

            // Otherwise check for add session modal
            hideAddSessionModal();
        }
    });
    
    // Close modal when clicking outside
    document.getElementById('add-session-instance-modal').addEventListener('click', (event) => {
        if (event.target === event.currentTarget) {
            hideAddSessionModal();
        }
    });
    
    // Year section toggle functionality
    function toggleYearSection(year) {
        const toggle = document.querySelector(`.year-toggle[data-year="${year}"]`);
        const content = document.querySelector(`.year-content[data-year="${year}"]`);
        const viewLink = document.querySelector(`.year-view-link[data-year="${year}"]`);
        
        if (!toggle || !content || !viewLink) return;
        
        const isCollapsed = content.classList.contains('collapsed');
        
        if (isCollapsed) {
            // Expand
            content.classList.remove('collapsed');
            toggle.classList.remove('collapsed');
            viewLink.classList.remove('visible');
        } else {
            // Collapse
            content.classList.add('collapsed');
            toggle.classList.add('collapsed');
            viewLink.classList.add('visible');
        }
    }
    
    function expandYearSection(year) {
        const toggle = document.querySelector(`.year-toggle[data-year="${year}"]`);
        const content = document.querySelector(`.year-content[data-year="${year}"]`);
        const viewLink = document.querySelector(`.year-view-link[data-year="${year}"]`);
        
        if (!toggle || !content || !viewLink) return;
        
        content.classList.remove('collapsed');
        toggle.classList.remove('collapsed');
        viewLink.classList.remove('visible');
    }

    // Tab switching functionality
    function switchTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`.tab-button[data-tab="${tabName}"]`).classList.add('active');

        // Update tab content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(`${tabName}-tab`).classList.add('active');
    }

    // Tunes tab functionality
    const allTunes = {{ tunes|tojson }};
    let filteredTunes = [];
    let currentFilters = {
        search: '',
        type: ''
    };
    let modalShowTime = 0;
    let isInitializing = true; // Flag to prevent URL updates during initialization

    // Sort mode cycle states (with icons and text labels)
    const sortModes = [
        { id: 'alpha-asc', label: 'Alphabetical', icon: '', arrow: '‚Üì', sortFn: (a, b) => (a[1] || '').localeCompare(b[1] || '') },
        { id: 'alpha-desc', label: 'Alphabetical', icon: '', arrow: '‚Üë', sortFn: (a, b) => (b[1] || '').localeCompare(a[1] || '') },
        { id: 'session-desc', label: 'Popularity At This Session', icon: 'üëÇ', arrow: '', sortFn: (a, b) => (b[3] || 0) - (a[3] || 0) },
        { id: 'session-asc', label: 'Popularity At This Session', icon: 'üëÇ', arrow: '‚Üë', sortFn: (a, b) => (a[3] || 0) - (b[3] || 0) },
        { id: 'tunebooks-desc', label: 'Popularity Everywhere', icon: '#', arrow: '', sortFn: (a, b) => (b[4] || 0) - (a[4] || 0) },
        { id: 'tunebooks-asc', label: 'Popularity Everywhere', icon: '#', arrow: '‚Üë', sortFn: (a, b) => (a[4] || 0) - (b[4] || 0) }
    ];
    let currentSortModeIndex = 2; // Start with session popularity descending

    // Initialize tunes tab
    function initializeTunesTab() {
        console.log('Initializing tunes tab with', allTunes.length, 'tunes');
        populateTuneTypes();
        loadStateFromURL();
        setupTunesEventListeners();
        updateSortDisplay();
        applyFilters();
        isInitializing = false; // Allow URL updates after initialization
    }

    // Load filter and sort state from URL query string
    function loadStateFromURL() {
        const urlParams = new URLSearchParams(window.location.search);

        // Load search filter
        const searchParam = urlParams.get('search');
        if (searchParam) {
            currentFilters.search = searchParam.toLowerCase().trim();
            document.getElementById('tune-search').value = searchParam;
        }

        // Load type filter
        const typeParam = urlParams.get('type');
        if (typeParam) {
            currentFilters.type = typeParam;
            document.getElementById('type-filter').value = typeParam;
        }

        // Load sort mode
        const sortParam = urlParams.get('sort');
        if (sortParam) {
            const sortIndex = sortModes.findIndex(mode => mode.id === sortParam);
            if (sortIndex !== -1) {
                currentSortModeIndex = sortIndex;
            }
        }
    }

    // Update URL with current filter and sort state
    function updateURL() {
        if (isInitializing) return; // Don't update URL during initialization

        const urlParams = new URLSearchParams(window.location.search);

        // Preserve tune parameter if present
        const tuneParam = urlParams.get('tune');

        // Update search parameter
        if (currentFilters.search) {
            urlParams.set('search', currentFilters.search);
        } else {
            urlParams.delete('search');
        }

        // Update type parameter
        if (currentFilters.type) {
            urlParams.set('type', currentFilters.type);
        } else {
            urlParams.delete('type');
        }

        // Update sort parameter (only if not default)
        const currentSort = sortModes[currentSortModeIndex].id;
        if (currentSortModeIndex !== 2) { // 2 is the default (session-desc)
            urlParams.set('sort', currentSort);
        } else {
            urlParams.delete('sort');
        }

        // Restore tune parameter if it was present
        if (tuneParam) {
            urlParams.set('tune', tuneParam);
        }

        // Update the URL without reloading the page
        const newURL = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
        window.history.replaceState({}, '', newURL);
    }

    function updateSortDisplay() {
        const mode = sortModes[currentSortModeIndex];
        const icon = document.getElementById('sort-icon');
        const text = document.getElementById('sort-text');
        const arrow = document.getElementById('sort-arrow');
        icon.textContent = mode.icon;
        text.textContent = mode.label;
        arrow.textContent = mode.arrow;
    }

    function populateTuneTypes() {
        // Extract unique tune types from the data
        const types = [...new Set(allTunes.map(tune => tune[2]).filter(Boolean))];
        types.sort();

        const typeFilter = document.getElementById('type-filter');
        types.forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = type.charAt(0).toUpperCase() + type.slice(1);
            typeFilter.appendChild(option);
        });
    }

    function setupTunesEventListeners() {
        // Search input with debounce
        let searchTimeout;
        document.getElementById('tune-search').addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentFilters.search = e.target.value.toLowerCase().trim();
                applyFilters();
                updateURL();
            }, 300);
        });

        // Type filter
        document.getElementById('type-filter').addEventListener('change', function(e) {
            currentFilters.type = e.target.value;
            applyFilters();
            updateURL();
        });

        // Sort toggle button
        document.getElementById('sort-toggle').addEventListener('click', cycleSortMode);

        // Modal overlay click handler
        const modalOverlay = document.getElementById('tune-detail-modal');
        modalOverlay.addEventListener('click', function(event) {
            const timeSinceShown = Date.now() - modalShowTime;
            if (timeSinceShown < 500) {
                return;
            }

            if (event.target === event.currentTarget && event.target.classList.contains('modal-overlay')) {
                closeTuneDetailModal();
            }
        });
    }

    function cycleSortMode() {
        currentSortModeIndex = (currentSortModeIndex + 1) % sortModes.length;
        updateSortDisplay();
        applyFilters();
        updateURL();
    }

    function applyFilters() {
        // Filter tunes based on search and type
        filteredTunes = allTunes.filter(tune => {
            // Search filter
            if (currentFilters.search) {
                const tuneName = (tune[1] || '').toLowerCase();
                if (!tuneName.includes(currentFilters.search)) {
                    return false;
                }
            }

            // Type filter
            if (currentFilters.type && tune[2] !== currentFilters.type) {
                return false;
            }

            return true;
        });

        // Apply sorting
        const sortMode = sortModes[currentSortModeIndex];
        if (sortMode && sortMode.sortFn) {
            filteredTunes.sort(sortMode.sortFn);
        }

        renderTunes();
    }

    function renderTunes() {
        const list = document.getElementById('tunes-list');
        const resultsCountText = document.getElementById('results-count-text');

        // Update results count
        const total = allTunes.length;
        const filtered = filteredTunes.length;
        if (filtered < total) {
            resultsCountText.textContent = `Showing ${filtered} of ${total} tunes`;
        } else {
            resultsCountText.textContent = `${total} tune${total !== 1 ? 's' : ''}`;
        }

        // Render tune rows or show "no results" message with add button
        if (filtered === 0 && currentFilters.search) {
            const addTuneButton = isLoggedIn
                ? `<a href="/sessions/${sessionPath}/tunes/add?q=${encodeURIComponent(currentFilters.search)}"
                       class="btn btn-primary"
                       style="padding: 12px 24px; background-color: var(--primary); color: white; text-decoration: none; border-radius: 4px; display: inline-block;">
                        Add Tune
                    </a>`
                : '';
            list.innerHTML = `
                <div style="padding: 40px 20px; text-align: center; color: var(--text-muted, #6c757d);">
                    <p style="margin-bottom: 20px;">No tunes found matching "${escapeHtml(currentFilters.search)}"</p>
                    ${addTuneButton}
                </div>
            `;
        } else {
            list.innerHTML = filteredTunes.map(tune => createTuneRow(tune)).join('');
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function createTuneRow(tune) {
        // tune is [tune_id, tune_name, tune_type, times_played, tunebook_count, setting_id]
        const tuneId = tune[0];
        const tuneName = tune[1] || 'Unknown';
        const tuneType = tune[2] || '';
        const timesPlayed = tune[3] || 0;
        const tunebookCount = tune[4] || 0;
        const settingId = tune[5];

        // Determine what to show based on sort mode
        const sortMode = sortModes[currentSortModeIndex];
        const isSessionMode = sortMode.id.startsWith('session-');
        const isTunebooksMode = sortMode.id.startsWith('tunebooks-');

        let countBadge = '';
        let typeBadge = '';

        if (isSessionMode) {
            countBadge = `<span class="tune-count-badge">${timesPlayed}</span>`;
            typeBadge = tuneType ? `<span class="tune-type">${tuneType}</span>` : '';
        } else if (isTunebooksMode) {
            countBadge = `<span class="tune-count-badge">${tunebookCount}</span>`;
            typeBadge = tuneType ? `<span class="tune-type">${tuneType}</span>` : '';
        } else {
            // Alphabetical sort - show tune type only
            typeBadge = tuneType ? `<span class="tune-type">${tuneType}</span>` : '';
        }

        return `
            <div class="tune-row" onclick="showTuneDetail(${tuneId}, '${tuneName.replace(/'/g, "\\'")}', '${tuneType}', ${timesPlayed}, ${tunebookCount}, ${settingId || 'null'})">
                <div class="tune-row-header">
                    <h3 class="tune-name">${tuneName}</h3>
                </div>
                <div class="tune-meta">
                    ${typeBadge}
                    ${countBadge}
                </div>
            </div>
        `;
    }

    function showTuneDetail(tuneId, tuneName, tuneType, timesPlayed, tunebookCount, settingId) {
        const modal = document.getElementById('tune-detail-modal');
        const modalContent = document.getElementById('tune-detail-content');

        // Update URL with tune parameter
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('tune', tuneId);
        const newURL = window.location.pathname + '?' + urlParams.toString();
        window.history.replaceState({}, '', newURL);

        // Show modal immediately with basic info
        displayTuneDetailModalBasic(tuneId, tuneName, tuneType, timesPlayed, tunebookCount, settingId);

        // Fetch full details from the API
        const apiUrl = `/api/sessions/${sessionPath}/tunes/${tuneId}`;
        console.log('Fetching tune details from:', apiUrl);

        fetch(apiUrl)
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('API response:', data);
                if (data.success) {
                    displayTuneDetailModalFull(data.session_tune);
                } else {
                    console.error('Failed to load tune details:', data.message || 'Unknown error');
                }
            })
            .catch(error => {
                console.error('Error loading tune details:', error);
            });
    }

    function displayTuneDetailModalBasic(tuneId, tuneName, tuneType, timesPlayed, tunebookCount, settingId) {
        const modal = document.getElementById('tune-detail-modal');
        const modalContent = document.getElementById('tune-detail-content');

        // Build thesession.org link
        const thesessionUrl = settingId
            ? `https://thesession.org/tunes/${tuneId}#setting${settingId}`
            : `https://thesession.org/tunes/${tuneId}`;
        const thesessionLinkIcon = `<a href="${thesessionUrl}" target="_blank" class="thesession-link-icon" title="View on TheSession.org" onclick="event.stopPropagation();">üîó</a>`;

        // Display name - will be updated with alias if available
        const displayName = tuneName || 'Unknown';

        modalContent.innerHTML = `
            <button class="modal-close-btn" onclick="closeTuneDetailModal()" title="Close">&times;</button>
            <h2 class="modal-tune-title">${displayName} ${thesessionLinkIcon}</h2>
            <div class="modal-info-line"><strong>Type:</strong> ${tuneType || 'Unknown'}</div>
            <div class="modal-info-line"><strong>We also call it:</strong> <span class="loading-dots">...</span></div>
            <div class="modal-info-line"><strong>Our Setting:</strong> <span class="loading-dots">...</span></div>
            <div class="modal-info-line"><strong>Our Key:</strong> <span class="loading-dots">...</span></div>
            <div class="modal-info-line"><strong>TheSession.org Popularity:</strong> ${tunebookCount || 0} tunebooks <span class="loading-dots">...</span></div>
            <div class="modal-info-line"><strong>Play History:</strong> Total times played in this session: ${timesPlayed}</div>
        `;

        // Show modal
        modal.style.display = 'flex';

        // Add 'show' class after a small delay to trigger slide-in animation
        setTimeout(() => {
            modal.classList.add('show');
        }, 10);

        // Record the time when modal is shown
        modalShowTime = Date.now();
    }

    function displayTuneDetailModalFull(sessionTune) {
        const modalContent = document.getElementById('tune-detail-content');

        // Build display name (alias takes precedence if it exists)
        const displayName = sessionTune.alias || sessionTune.tune_name || 'Unknown';

        // Build thesession.org link with setting if available
        const thesessionUrl = sessionTune.setting_id
            ? `https://thesession.org/tunes/${sessionTune.tune_id}#setting${sessionTune.setting_id}`
            : `https://thesession.org/tunes/${sessionTune.tune_id}`;
        const thesessionLinkIcon = `<a href="${thesessionUrl}" target="_blank" class="thesession-link-icon" title="View on TheSession.org" onclick="event.stopPropagation();">üîó</a>`;

        // Build aliases input (comma-delimited)
        const aliasesValue = sessionTune.aliases && sessionTune.aliases.length > 0
            ? sessionTune.aliases.join(', ')
            : '';

        // Build setting ID input value
        const settingIdValue = sessionTune.setting_id || '';

        // Build key input value
        const keyValue = sessionTune.key || '';

        // Build popularity display with refresh icon and cached date
        const tunebookCount = sessionTune.tunebook_count || 0;
        const cachedDate = sessionTune.tunebook_count_cached_date || '';
        const cachedDateId = 'cached-date-display';
        const cachedDateDisplay = cachedDate
            ? `<span id="${cachedDateId}" style="margin-left: 10px; color: var(--disabled-text); font-style: italic; font-size: 0.8em;">Last Updated: ${cachedDate}</span>`
            : `<span id="${cachedDateId}" style="margin-left: 10px; color: var(--disabled-text); font-style: italic; font-size: 0.8em; display: none;"></span>`;
        const popularityDisplay = `
            <span id="tunebook-count">${tunebookCount} tunebook${tunebookCount !== 1 ? 's' : ''}</span>
            <button id="refresh-tunebook" onclick="refreshTunebookCount(${sessionTune.tune_id})" style="margin-left: 10px; padding: 4px 8px; font-size: 0.9em; cursor: pointer; background-color: var(--light); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 3px; line-height: 1;" title="Refresh popularity count">‚Üª</button>
            ${cachedDateDisplay}
        `;

        // Build play history instances list
        const playCount = sessionTune.times_played || 0;
        let playInstancesHtml = '';
        if (sessionTune.play_instances && sessionTune.play_instances.length > 0) {
            playInstancesHtml = `
                <ul style="list-style: none; padding: 0; margin-top: 10px;">
                    ${sessionTune.play_instances.map(instance => {
                        const dateStr = instance.date || 'Unknown date';
                        const positionStr = instance.position_in_set ? `#${instance.position_in_set}` : '';
                        let overridesHtml = '';
                        const overrides = [];
                        if (instance.name_override) overrides.push(`Name: "${instance.name_override}"`);
                        if (instance.key_override) overrides.push(`Key: ${instance.key_override}`);
                        if (instance.setting_id_override) overrides.push(`Setting: #${instance.setting_id_override}`);
                        if (overrides.length > 0) {
                            overridesHtml = `<div style="font-style: italic; color: #856404; font-size: 0.9em; margin-top: 4px;">${overrides.join(' ‚Ä¢ ')}</div>`;
                        }
                        return `
                            <li style="margin: 8px 0; padding: 10px; background-color: var(--hover-bg, #f8f9fa); border-radius: 4px;">
                                <div style="font-weight: bold; color: var(--primary, #007bff);">
                                    <a href="/sessions/${sessionPath}/${dateStr}?tune=${sessionTune.tune_id}" style="color: var(--primary);">${dateStr}</a>
                                </div>
                                <div style="font-size: 0.9em; color: var(--disabled-text, #666); margin-top: 4px;">
                                    Position in set: ${positionStr}
                                    ${overridesHtml}
                                </div>
                            </li>
                        `;
                    }).join('')}
                </ul>
            `;
        } else {
            playInstancesHtml = `<p style="color: var(--disabled-text); font-style: italic; margin-top: 10px;">No instances recorded yet.</p>`;
        }

        modalContent.innerHTML = `
            <button class="modal-close-btn" onclick="closeTuneDetailModal()" title="Close">&times;</button>
            <div class="modal-info-section">
                <h2 class="modal-tune-title">${displayName} ${thesessionLinkIcon}</h2>
                <div class="modal-info-line">
                    <strong>Type:</strong> <span class="tune-type">${sessionTune.tune_type || 'Unknown'}</span>
                </div>
                ${isLoggedIn ? `
                <div class="modal-info-line">
                    <strong>We also call it:</strong><br>
                    <input type="text" id="aliases-input" value="${aliasesValue}" style="width: 100%; padding: 6px 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px; background-color: var(--bg-color); color: var(--text-color); margin-top: 6px;" placeholder="Comma-separated aliases">
                </div>
                <div class="modal-info-line">
                    <strong>Our Setting:</strong><br>
                    <input type="text" id="setting-id-input" value="${settingIdValue}" style="width: 100%; padding: 6px 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px; background-color: var(--bg-color); color: var(--text-color); margin-top: 6px;" placeholder="Setting ID (number)">
                </div>
                <div class="modal-info-line">
                    <strong>Our Key:</strong><br>
                    <input type="text" id="key-input" value="${keyValue}" style="width: 100%; padding: 6px 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px; background-color: var(--bg-color); color: var(--text-color); margin-top: 6px;" placeholder="Key (e.g., D, G, Am)">
                </div>
                <div style="margin-top: 12px; margin-bottom: 16px;">
                    <button id="save-tune-details-btn" onclick="saveTuneDetails(${sessionTune.tune_id})" style="padding: 8px 16px; background-color: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Save</button>
                </div>
                ` : `
                <div class="modal-info-line">
                    <strong>We also call it:</strong> ${aliasesValue || '(none)'}
                </div>
                <div class="modal-info-line">
                    <strong>Our Setting:</strong> ${settingIdValue ? '#' + settingIdValue : '(none)'}
                </div>
                <div class="modal-info-line">
                    <strong>Our Key:</strong> ${keyValue || '(none)'}
                </div>
                `}
                <div class="modal-info-line"><strong>TheSession.org Popularity:</strong> ${popularityDisplay}</div>
            </div>
            <div class="modal-play-history">
                <div class="modal-info-line">
                    <strong>Play History</strong><br>
                    <div style="margin-top: 6px;">Total times played in this session: ${playCount}</div>
                    ${playInstancesHtml}
                </div>
            </div>
        `;
    }

    function refreshTunebookCount(tuneId) {
        const button = document.getElementById('refresh-tunebook');
        const countSpan = document.getElementById('tunebook-count');
        const dateSpan = document.getElementById('cached-date-display');

        // Disable button and show loading state
        button.disabled = true;
        const originalButtonText = button.textContent;
        button.textContent = '‚ü≥';

        // Make API call
        fetch(`/api/sessions/${sessionPath}/tunes/${tuneId}/refresh_tunebook_count`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the display with new count
                const newCount = data.new_count;
                const suffix = newCount === 1 ? '' : 's';
                countSpan.textContent = `${newCount} tunebook${suffix}`;

                // Update the cached date display
                if (data.cached_date && dateSpan) {
                    dateSpan.textContent = `Last Updated: ${data.cached_date}`;
                    dateSpan.style.display = '';
                } else if (dateSpan) {
                    dateSpan.style.display = 'none';
                }

                // Show a temporary success message
                if (data.old_count !== data.new_count) {
                    button.textContent = '‚úì';
                    button.style.backgroundColor = '#28a745';
                    button.style.color = 'white';
                } else {
                    button.textContent = '‚àí';
                    button.style.backgroundColor = '#6c757d';
                    button.style.color = 'white';
                }
            } else {
                // Show error message
                button.textContent = '‚úó';
                button.style.backgroundColor = '#dc3545';
                button.style.color = 'white';
                console.error('Error:', data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            button.textContent = '‚úó';
            button.style.backgroundColor = '#dc3545';
            button.style.color = 'white';
        })
        .finally(() => {
            // Reset button after 2 seconds
            setTimeout(() => {
                button.disabled = false;
                button.textContent = originalButtonText;
                button.style.backgroundColor = '';
                button.style.color = '';
            }, 2000);
        });
    }

    function saveTuneDetails(tuneId) {
        const aliasesInput = document.getElementById('aliases-input');
        const settingIdInput = document.getElementById('setting-id-input');
        const keyInput = document.getElementById('key-input');
        const saveButton = document.getElementById('save-tune-details-btn');

        // Get values
        const aliases = aliasesInput.value.trim();
        const settingId = settingIdInput.value.trim();
        const key = keyInput.value.trim();

        // Disable button and show saving state
        saveButton.disabled = true;
        saveButton.textContent = 'Saving...';

        // Make API call to save the tune details
        fetch(`/api/sessions/${sessionPath}/tunes/${tuneId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                aliases: aliases,
                setting_id: settingId,
                key: key
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                saveButton.textContent = 'Saved!';
                saveButton.style.backgroundColor = '#28a745';

                // Update the tune list if needed (refresh setting_id in memory)
                const tuneIndex = allTunes.findIndex(t => t[0] === tuneId);
                if (tuneIndex !== -1) {
                    allTunes[tuneIndex][5] = settingId ? parseInt(settingId) : null;
                }

                setTimeout(() => {
                    saveButton.disabled = false;
                    saveButton.textContent = 'Save';
                    saveButton.style.backgroundColor = '';
                }, 1500);
            } else {
                saveButton.textContent = 'Error';
                saveButton.style.backgroundColor = '#dc3545';
                console.error('Error saving tune details:', data.message);

                setTimeout(() => {
                    saveButton.disabled = false;
                    saveButton.textContent = 'Save';
                    saveButton.style.backgroundColor = '';
                }, 2000);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            saveButton.textContent = 'Error';
            saveButton.style.backgroundColor = '#dc3545';

            setTimeout(() => {
                saveButton.disabled = false;
                saveButton.textContent = 'Save';
                saveButton.style.backgroundColor = '';
            }, 2000);
        });
    }

    function closeTuneDetailModal() {
        const modal = document.getElementById('tune-detail-modal');

        // Remove tune parameter from URL
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.delete('tune');
        const newURL = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
        window.history.replaceState({}, '', newURL);

        // Remove 'show' class to trigger slide-out animation
        modal.classList.remove('show');

        // Wait for animation to complete before hiding
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }

    // Show initial flash messages and setup event listeners when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        // Setup tab switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', function() {
                switchTab(this.getAttribute('data-tab'));
            });
        });

        // Initialize tunes tab on page load since it's the default tab
        initializeTunesTab();

        // Check for tune parameter and open tune modal if present
        const urlParams = new URLSearchParams(window.location.search);
        const tuneId = urlParams.get('tune');
        if (tuneId) {
            // Find the tune in the allTunes array
            const tuneIdNum = parseInt(tuneId);
            const tune = allTunes.find(t => t[0] === tuneIdNum);
            if (tune) {
                // Show the tune detail modal
                setTimeout(() => {
                    showTuneDetail(tune[0], tune[1], tune[2], tune[3], tune[4], tune[5]);
                }, 100);
            }
        }

        // Event listeners for buttons and modals
        const addSessionBtn = document.getElementById('add-session-btn');
        if (addSessionBtn) {
            addSessionBtn.addEventListener('click', showAddSessionModal);
        }
        
        const addFirstSessionBtn = document.getElementById('add-first-session-btn');
        if (addFirstSessionBtn) {
            addFirstSessionBtn.addEventListener('click', showAddSessionModal);
        }
        
        document.getElementById('add-session-cancel-btn').addEventListener('click', hideAddSessionModal);
        document.getElementById('add-session-confirm-btn').addEventListener('click', addSessionInstance);
        
        
        // Handle enter key in date input (only for add session instance modal)
        document.getElementById('session-date-input').addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                const addModal = document.getElementById('add-session-instance-modal');
                if (addModal.style.display === 'flex') {
                    addSessionInstance();
                }
            }
        });
        
        // Setup year section toggle functionality
        document.querySelectorAll('.year-header').forEach(header => {
            header.addEventListener('click', function(e) {
                e.preventDefault();
                const year = this.getAttribute('data-year');
                toggleYearSection(year);
            });
        });
        
        // Setup view links
        document.querySelectorAll('.year-view-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const year = this.getAttribute('data-year');
                expandYearSection(year);
            });
        });
        
        // Collapse all years except the latest one by default
        const yearHeaders = document.querySelectorAll('.year-header');
        if (yearHeaders.length > 1) {
            // Get all years and find the latest (first in the list since they're sorted newest first)
            const years = Array.from(yearHeaders).map(header => header.getAttribute('data-year'));
            const latestYear = years[0];
            
            // Collapse all years except the latest
            years.forEach(year => {
                if (year !== latestYear) {
                    const content = document.querySelector(`.year-content[data-year="${year}"]`);
                    const toggle = document.querySelector(`.year-toggle[data-year="${year}"]`);
                    const viewLink = document.querySelector(`.year-view-link[data-year="${year}"]`);
                    
                    if (content && toggle && viewLink) {
                        content.classList.add('collapsed');
                        toggle.classList.add('collapsed');
                        viewLink.classList.add('visible');
                    }
                }
            });
        }
        
        // Show initial flash messages if any
        const existingMessage = document.querySelector('.message');
        if (existingMessage) {
            setTimeout(() => {
                existingMessage.classList.add('show');
            }, 10);
        }
    });
</script>
{% endblock %}