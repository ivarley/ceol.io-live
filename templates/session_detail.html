{% extends "base.html" %}

{% block title %}{{ session.name }} - Irish Music Session Details{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<style>
        .session-details {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .session-details p {
            margin-bottom: 6px;
        }

        [data-theme="dark"] .session-details {
            background-color: #2a2a2a;
        }

        /* Tab styles */
        .tabs-container {
            margin-top: 0;
        }

        .tab-buttons {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 10px;
        }

        .tab-button {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            color: var(--secondary-text);
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }

        .tab-button:hover {
            color: var(--text-color);
        }

        .tab-button.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            font-weight: 500;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Tunes tab styles */
        .tunes-container {
            width: 100%;
            margin: 0;
            padding: 20px;
        }

        /* Mobile: zero padding for tunes container and parent docs-content */
        @media (max-width: 768px) {
            /* Override parent container padding */
            .docs-content {
                padding: 0 !important;
                margin-left: 0 !important;
                margin-right: 0 !important;
            }

            .tunes-container {
                padding: 0 !important;
                margin-left: 0 !important;
                margin-right: 0 !important;
            }
        }

        .filters-container {
            padding: 6px;
            margin-bottom: 10px;
        }

        .filter-row {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: nowrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            min-width: 0;
        }

        .filter-group:first-child {
            flex: 1;
            min-width: 0;
        }

        .filter-input {
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            background-color: var(--bg-color);
            color: var(--text-color);
            width: 100%;
            min-width: 0;
            max-width: 200px;
        }

        .filter-select {
            padding: 8px 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            background-color: var(--bg-color);
            color: var(--text-color);
            cursor: pointer;
            width: 110px;
            flex-shrink: 0;
        }

        .results-count {
            margin-bottom: 15px;
            color: var(--text-muted, #6c757d);
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .sort-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sort-label {
            color: var(--text-color);
            font-size: 14px;
            white-space: nowrap;
        }

        .sort-toggle {
            padding: 4px 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--bg-color);
            color: var(--text-color);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
            user-select: none;
        }

        .sort-toggle:hover {
            background-color: var(--hover-bg);
        }

        .sort-toggle-text {
            display: none;
        }

        #sort-icon {
            filter: grayscale(100%);
        }

        .tunes-list {
            display: block;
            margin-bottom: 30px;
        }

        .tune-row {
            background-color: var(--bg-color);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 8px;
            transition: background-color 0.1s;
            cursor: pointer;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 12px;
            align-items: center;
        }

        .tune-row:first-child {
            border-top: 1px solid var(--border-color);
        }

        .tune-row:hover {
            background-color: var(--hover-bg);
        }

        .tune-row-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 0;
            grid-column: 1;
            min-width: 0;
        }

        .tune-name {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-color);
            margin: 0;
            flex: 0 0 auto;
            max-width: 275px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .tune-type {
            font-size: 11px;
            padding: 3px 6px;
            background-color: var(--primary);
            color: white;
            border-radius: 3px;
            text-transform: capitalize;
            white-space: nowrap;
            margin-left: 0;
        }

        .tune-meta {
            display: flex;
            flex-direction: row;
            gap: 8px;
            margin-bottom: 0;
            font-size: 13px;
            align-items: center;
            grid-column: 2;
            justify-content: flex-end;
        }

        .tune-count-badge {
            font-size: 11px;
            padding: 3px 6px;
            background-color: var(--secondary-text, #6c757d);
            color: white;
            border-radius: 3px;
            white-space: nowrap;
        }

        /* Loading dots animation */
        .loading-dots {
            font-weight: bold;
            display: inline-block;
            animation: pulse-dots 1.5s ease-in-out infinite;
        }

        @keyframes pulse-dots {
            0%, 100% {
                opacity: 0.3;
            }
            50% {
                opacity: 1;
            }
        }

        /* TheSession link icon */
        .thesession-link-icon {
            font-size: 18px;
            text-decoration: none;
            color: var(--primary);
            opacity: 0.8;
        }

        .thesession-link-icon:hover {
            opacity: 1;
        }

        .modal-tune-link {
            display: inline-block;
            color: var(--primary);
            text-decoration: none;
            margin-top: 12px;
            padding: 6px 12px;
            border: 1px solid var(--primary);
            border-radius: 4px;
            font-size: 14px;
        }

        .modal-tune-link:hover {
            background-color: var(--primary);
            color: white;
            text-decoration: none;
        }

        .modal-tune-title {
            margin: 0 32px 12px 0;
            color: var(--text-color);
            font-size: 22px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-info-line {
            color: var(--text-muted, #6c757d);
            font-size: 16px;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .modal-info-line strong {
            color: var(--text-color);
            font-weight: 600;
        }

        .modal-dialog {
            background: var(--bg-color, white);
            border-radius: 8px;
            padding: 0;
            max-width: 600px;
            width: 90%;
            height: calc(100vh - 80px);
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            color: var(--text-color);
            position: relative;
            pointer-events: auto;
            z-index: 1;
            overflow: hidden;
        }

        #tune-detail-content {
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .modal-info-section {
            flex-shrink: 0;
        }

        .modal-play-history {
            flex: 1;
            overflow-y: auto;
            margin-top: 12px;
            padding-right: 8px;
        }

        .modal-play-history::-webkit-scrollbar {
            width: 8px;
        }

        .modal-play-history::-webkit-scrollbar-track {
            background: var(--hover-bg, #f8f9fa);
            border-radius: 4px;
        }

        .modal-play-history::-webkit-scrollbar-thumb {
            background: var(--border-color, #dee2e6);
            border-radius: 4px;
        }

        .modal-play-history::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-text, #6c757d);
        }

        .modal-close-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            font-size: 28px;
            color: var(--text-muted, #999);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }

        .modal-close-btn:hover {
            color: var(--text-color);
        }

        @media (max-width: 768px) {
            .tunes-container {
                padding: 0;
                max-width: 100%;
                margin: 0;
            }

            .filters-container {
                padding: 8px;
            }

            .filter-input {
                font-size: 16px;
                padding: 8px 6px;
                max-width: none;
                height: 40px;
                box-sizing: border-box;
            }

            .filter-select {
                font-size: 13px;
                padding: 8px 4px;
                width: 85px;
                height: 40px;
                box-sizing: border-box;
            }

            .results-count {
                margin-bottom: 4px;
                padding: 0 8px;
                font-size: 12px;
                gap: 6px;
            }

            .sort-toggle {
                font-size: 11px;
                padding: 3px 6px;
            }

            .tune-row {
                border-radius: 0;
                border-left: none;
                border-right: none;
                border-top: none;
                padding: 8px 8px;
                margin: 0;
            }

            .tune-name {
                font-size: 18px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                min-width: 0;
                max-width: calc(100vw - 100px);
            }

            .tune-type {
                font-size: 12px;
                padding: 2px 6px;
            }

            .modal-dialog {
                width: 100%;
                max-width: 100%;
                height: calc(100vh - 40px);
                margin: 0;
                margin-top: 40px;
                border-radius: 0;
                position: fixed;
                right: 0;
                top: 0;
                transform: translateX(100%);
                transition: transform 0.3s ease-out;
                box-shadow: -4px 0 12px rgba(0,0,0,0.2);
                pointer-events: auto;
                padding-left: 16px;
                padding-right: 16px;
                box-sizing: border-box;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }

            .modal-overlay.show .modal-dialog {
                transform: translateX(0);
            }

            #tune-detail-content {
                padding: 16px 0;
                box-sizing: border-box;
                display: flex;
                flex-direction: column;
                height: 100%;
                overflow: hidden;
            }

            .modal-close-btn {
                position: fixed;
                top: 8px;
                right: 8px;
                font-size: 0;
                width: 40px;
                height: 40px;
                background-color: var(--bg-color);
                border: 1px solid var(--border-color);
                border-radius: 4px;
                z-index: 10001;
            }

            .modal-close-btn::before {
                content: '>';
                font-size: 24px;
                font-weight: bold;
                color: var(--text-color);
            }
        }

        @media (min-width: 769px) {
            .sort-label {
                display: block;
            }

            .sort-toggle-text {
                display: inline;
            }
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--dropdown-shadow);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: var(--bg-color, white);
            border-radius: 8px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 8px 24px var(--dropdown-shadow);
            color: var(--text-color);
        }
        .modal-header {
            margin-bottom: 16px;
        }
        .modal-header h3 {
            margin: 0;
            color: var(--text-color);
        }
        .modal-body {
            margin-bottom: 20px;
        }
        .modal-body label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--text-color);
        }
        .modal-body input[type="date"],
        .modal-body input[type="time"],
        .modal-body input[type="text"],
        .modal-body textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
            font-family: inherit;
        }
        .modal-footer {
            text-align: right;
        }
        .modal-footer button {
            margin-left: 8px;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .modal-footer .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        .modal-footer .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }
        .modal-footer button:hover {
            opacity: 0.9;
        }
        .add-link {
            color: var(--primary);
            text-decoration: none;
            margin-left: 10px;
            font-size: 0.9em;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            cursor: pointer;
        }
        .add-link:hover {
            text-decoration: underline;
        }
        .session-logs-heading:hover .add-link,
        .session-title-heading:hover .add-link {
            opacity: 1;
        }
        .modal-body form {
            max-height: 70vh;
            overflow-y: auto;
        }
        .modal-body input:focus,
        .modal-body textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        
        /* Dark mode styles for modal form elements */
        [data-theme="dark"] .modal-body input[type="date"],
        [data-theme="dark"] .modal-body input[type="time"],
        [data-theme="dark"] .modal-body input[type="text"],
        [data-theme="dark"] .modal-body textarea {
            background-color: var(--dropdown-bg);
            border-color: var(--border-color);
            color: var(--text-color);
        }
        
        [data-theme="dark"] .modal-body input:focus,
        [data-theme="dark"] .modal-body textarea:focus {
            background-color: var(--dropdown-bg);
            border-color: var(--primary);
            color: var(--text-color);
        }
        
        [data-theme="dark"] .modal-body label {
            color: var(--text-color);
        }
        @media (max-width: 767.98px) {
            .popular-tunes div[style*="display: flex"] {
                gap: 0 !important;
            }
            .popular-tunes div[style*="flex: 1"] {
                margin-top: 0 !important;
                margin-bottom: 0 !important;
            }
            .popular-tunes ol {
                margin-bottom: 0 !important;
            }
        }
        
        /* Year section toggle styles */
        .year-section {
            margin-bottom: 1.5rem;
        }
        
        .year-header {
            display: flex;
            align-items: center;
            cursor: pointer;
            margin-bottom: 0.5rem;
            user-select: none;
        }
        
        .year-header:hover {
            opacity: 0.8;
        }
        
        .year-header-left {
            display: flex;
            align-items: center;
        }
        
        .year-toggle {
            display: inline-block;
            margin-right: 0.5rem;
            transition: transform 0.2s ease;
            font-size: 0.85rem;
            color: var(--disabled-text);
            font-weight: bold;
        }
        
        .year-toggle.collapsed {
            transform: rotate(-90deg);
        }
        
        .year-title {
            margin: 0;
            font-size: 1.17rem;
            font-weight: bold;
            color: var(--text-color);
        }
        
        .year-view-link {
            font-size: 0.9rem;
            color: var(--primary);
            text-decoration: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
            margin-left: 0.5rem;
        }
        
        .year-view-link.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .year-add-link {
            font-size: 0.9rem;
            color: var(--primary);
            text-decoration: none;
            opacity: 1;
            transition: opacity 0.2s ease;
            pointer-events: auto;
            margin-left: 0.5rem;
            cursor: pointer;
        }

        .year-add-link.hidden {
            display: none;
        }
        
        .year-view-link:hover {
            text-decoration: underline;
        }

        /* Instances Table Styles */
        .instances-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5rem;
        }

        .year-header-row {
            border: none;
        }

        .year-header-cell {
            border: none;
            padding: 0;
            background: transparent;
        }

        .year-content-row {
            transition: max-height 0.3s ease, opacity 0.3s ease;
            border-bottom: 1px solid var(--border-color);
        }

        .year-content-row.collapsed {
            display: none;
        }

        .instance-date-cell,
        .instance-location-cell {
            padding: 8px 12px;
            vertical-align: middle;
        }

        .instance-date-cell a,
        .instance-location-cell a {
            color: var(--primary);
            text-decoration: none;
        }

        .instance-date-cell a:hover,
        .instance-location-cell a:hover {
            text-decoration: underline;
        }

        .instance-time-cell {
            padding: 8px 12px;
            vertical-align: middle;
            text-align: right;
            white-space: nowrap;
            color: var(--text-color);
        }

        /* Active Session Instance Highlighting */
        .session-instance-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 4px 8px;
            margin: -4px -8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .session-instance-link.active-now {
            background-color: #fffbcc;
        }

        [data-theme="dark"] .session-instance-link.active-now {
            background-color: #4a4520;
        }

        .active-now-badge {
            background-color: #28a745;
            color: white;
            border-radius: 3px;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
        }

        /* Tune list status box styles */
        .tune-list-box-not-on-list {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        /* Want to Learn - Yellow */
        .tune-list-box-want-to-learn {
            background-color: #fef3cd;
            border: 1px solid #f0ad4e;
            color: #856404;
        }

        /* Learning - Blue */
        .tune-list-box-learning {
            background-color: #d1ecf1;
            border: 1px solid #5bc0de;
            color: #0c5460;
        }

        /* Learned - Green */
        .tune-list-box-learned {
            background-color: #d4edda;
            border: 1px solid #5cb85c;
            color: #155724;
        }

        .tune-list-select {
            border: 1px solid currentColor;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .tune-list-button {
            padding: 6px 12px;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 13px;
            margin-left: 8px;
        }

        .tune-list-button-add {
            background-color: #dc3545;
            margin-left: 0;
            margin-right: 0;
        }

        .tune-list-button-heard {
            background-color: #5cb85c;
        }

        .tune-list-button:hover {
            opacity: 0.9;
        }

        .heard-count-line {
            display: flex;
            align-items: center;
        }

        /* Dark mode styles for tune list boxes */
        [data-theme="dark"] .tune-list-box-not-on-list {
            background-color: #4a1f1f;
            border-color: #6a2d2d;
            color: #f8a5a5;
        }

        [data-theme="dark"] .tune-list-box-want-to-learn {
            background-color: #4a3f1f;
            border-color: #f0ad4e;
            color: #ffd97d;
        }

        [data-theme="dark"] .tune-list-box-learning {
            background-color: #1f3a4a;
            border-color: #5bc0de;
            color: #7dd3e8;
        }

        [data-theme="dark"] .tune-list-box-learned {
            background-color: #1e4620;
            border-color: #5cb85c;
            color: #7dda8b;
        }

        /* Modal button group and button styles (matching my_tunes) */
        .modal-button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 12px;
        }

        .modal-cancel-btn {
            padding: 6px 16px;
            background-color: #1e3a5f;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            flex: 1;
            max-width: 120px;
        }

        .modal-cancel-btn:hover {
            background-color: #152b47;
        }

        .modal-save-btn {
            padding: 6px 16px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            flex: 1;
            max-width: 120px;
        }

        .modal-save-btn:hover:not(:disabled) {
            background-color: var(--primary-dark, #0056b3);
        }

        .modal-save-btn:disabled {
            background-color: var(--secondary, #6c757d);
            cursor: not-allowed;
            opacity: 0.5;
        }

        [data-theme="dark"] .modal-save-btn:disabled {
            background-color: #555;
        }

        /* People tab styles */
        .people-container {
            width: 100%;
            margin: 0;
            padding: 20px;
        }

        /* Mobile: zero padding for people container */
        @media (max-width: 768px) {
            .people-container {
                padding: 0 !important;
                margin-left: 0 !important;
                margin-right: 0 !important;
            }
        }

        .people-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            padding: 0 8px;
            align-items: center;
        }

        @media (max-width: 768px) {
            .people-controls {
                padding: 8px;
            }
        }

        .people-search-box {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .people-search-box:focus {
            outline: none;
            border-color: var(--primary);
        }

        .people-filter-btn {
            padding: 8px 16px;
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
            white-space: nowrap;
            min-width: 100px;
        }

        .people-filter-btn:hover {
            background-color: var(--hover-bg);
        }

        .people-add-btn {
            padding: 8px 16px;
            background-color: var(--primary);
            color: white;
            border: 1px solid var(--primary);
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s, opacity 0.2s;
            white-space: nowrap;
        }

        .people-add-btn:hover {
            opacity: 0.9;
        }

        .people-list {
            display: block;
            margin-bottom: 30px;
        }

        .person-row {
            background-color: var(--bg-color);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 8px;
            transition: background-color 0.1s;
            cursor: pointer;
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 12px;
            align-items: center;
        }

        .person-row:first-child {
            border-top: 1px solid var(--border-color);
        }

        .person-row:hover {
            background-color: var(--hover-bg);
        }

        .person-icon {
            font-size: 24px;
            width: 32px;
            text-align: center;
        }

        .person-icon.has-account {
            color: var(--primary);
        }

        .person-icon.no-account {
            color: #999;
        }

        .person-info {
            display: flex;
            flex-direction: row;
            align-items: baseline;
            gap: 8px;
            min-width: 0;
        }

        .person-name {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-color);
            margin: 0;
            flex-shrink: 0;
        }

        .person-instruments {
            font-size: 13px;
            color: var(--secondary-text, #6c757d);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-shrink: 1;
        }

        .person-meta {
            display: flex;
            gap: 8px;
            align-items: center;
            font-size: 11px;
        }

        .person-attendance-badge {
            padding: 3px 6px;
            background-color: var(--secondary-text, #6c757d);
            color: white;
            border-radius: 3px;
            white-space: nowrap;
        }

        @media (max-width: 768px) {
            .person-row {
                border-radius: 0;
                border-left: none;
                border-right: none;
                border-top: none;
                padding: 12px 8px;
                margin: 0;
            }

            .person-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }

            .person-name {
                font-size: 18px;
            }

            .person-instruments {
                font-size: 12px;
                white-space: normal;
            }

            .person-icon {
                font-size: 28px;
                width: 36px;
            }
        }

        /* Person detail modal styles (reuse tune detail modal patterns) */
        #person-detail-modal .modal-dialog {
            /* Same as tune detail modal */
        }

        #person-detail-content {
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: auto;
        }

        .person-detail-title {
            margin: 0 32px 12px 0;
            color: var(--text-color);
            font-size: 22px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .person-detail-location {
            color: var(--text-muted, #6c757d);
            font-size: 14px;
            margin-bottom: 16px;
        }

        .person-detail-section {
            margin-bottom: 20px;
        }

        .person-detail-section h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-color);
        }

        .person-detail-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .person-detail-list li {
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .person-detail-list li:last-child {
            border-bottom: none;
        }

        .person-detail-link {
            color: var(--primary);
            text-decoration: none;
        }

        .person-detail-link:hover {
            text-decoration: underline;
        }

        .person-instruments-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .person-instrument-badge {
            font-size: 12px;
            padding: 4px 8px;
            background-color: var(--hover-bg, #f8f9fa);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 3px;
        }

        .attendance-table {
            width: 100%;
            margin-top: 12px;
        }

        .attendance-table th {
            text-align: left;
            padding: 8px;
            background-color: var(--hover-bg, #f8f9fa);
            border-bottom: 2px solid var(--border-color);
            font-weight: 600;
            font-size: 14px;
        }

        .attendance-table td {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .attendance-table tr:last-child td {
            border-bottom: none;
        }

        @media (max-width: 768px) {
            #person-detail-modal .modal-dialog {
                width: 100%;
                max-width: 100%;
                height: calc(100vh - 40px);
                margin: 0;
                margin-top: 40px;
                border-radius: 0;
                position: fixed;
                right: 0;
                top: 0;
                transform: translateX(100%);
                transition: transform 0.3s ease-out;
                box-shadow: -4px 0 12px rgba(0,0,0,0.2);
                padding-left: 16px;
                padding-right: 16px;
                box-sizing: border-box;
            }

            #person-detail-modal.show .modal-dialog {
                transform: translateX(0);
            }

            #person-detail-content {
                padding: 16px 0;
            }
        }

        /* Add person modal styles */
        #add-person-modal .modal-dialog {
            max-width: 500px;
            width: 90%;
        }

        .add-person-form-group {
            margin-bottom: 16px;
        }

        .add-person-form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 14px;
            color: var(--text-color);
        }

        .add-person-form-group input[type="text"] {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            background-color: var(--bg-color);
            color: var(--text-color);
            box-sizing: border-box;
        }

        .add-person-form-group input[type="text"]:focus {
            outline: none;
            border-color: var(--primary);
        }

        .instruments-checkboxes {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--bg-color);
        }

        .instrument-checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .instrument-checkbox-item input[type="checkbox"] {
            cursor: pointer;
        }

        .instrument-checkbox-item label {
            cursor: pointer;
            font-size: 13px;
            margin: 0;
            font-weight: normal;
        }

        .add-person-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .add-person-btn-cancel {
            padding: 8px 16px;
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .add-person-btn-cancel:hover {
            background-color: var(--hover-bg);
        }

        .add-person-btn-save {
            padding: 8px 16px;
            background-color: var(--primary);
            color: white;
            border: 1px solid var(--primary);
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .add-person-btn-save:hover {
            opacity: 0.9;
        }

        .add-person-btn-save:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .instruments-checkboxes {
                grid-template-columns: 1fr;
            }
        }

        /* Search person modal styles */
        #search-person-modal .modal-dialog {
            max-width: 600px;
            width: 90%;
        }

        .search-person-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
            background-color: var(--bg-color);
            color: var(--text-color);
            box-sizing: border-box;
            margin-bottom: 16px;
        }

        .search-person-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .search-results-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 16px;
        }

        .search-result-row {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.1s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .search-result-row:last-child {
            border-bottom: none;
        }

        .search-result-row:hover {
            background-color: var(--hover-bg);
        }

        .search-result-content {
            flex: 1;
            min-width: 0;
        }

        .search-result-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .search-result-name {
            font-weight: 500;
            font-size: 16px;
            color: var(--text-color);
            margin-bottom: 4px;
        }

        .search-result-details {
            font-size: 13px;
            color: var(--secondary-text, #6c757d);
        }

        .search-result-instruments {
            font-size: 12px;
            color: var(--secondary-text, #6c757d);
            margin-top: 4px;
        }

        .search-no-results {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-muted, #6c757d);
        }

        .search-person-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
    </style>
{% endblock %}

{% block content %}
<div class="landing-page" style="display: block;">

    <div style="padding: 10px 10px 5px 10px;">
        <h1 class="session-title-heading">{{ session.name }} <a href="/sessions" style="color: var(--border-color, #dee2e6); text-decoration: none; margin-left: 10px; font-size: 0.6em; transition: color 0.2s ease;" onmouseover="this.style.color='var(--primary, #007bff)'" onmouseout="this.style.color='var(--border-color, #dee2e6)'">⮐</a>{% if is_session_admin %}<a href="/admin/sessions/{{ session.path }}" class="add-link">Admin</a>{% endif %}</h1>

        <div class="session-details">
            {% if session.location_name and session.location_name != session.name %}
            <p><strong>Location:</strong> {{ session.location_name }}</p>
            {% endif %}

            <p>{% if session.unlisted_address %}(unlisted address), {% else %}{% if session.location_street %}{{ session.location_street }}, {% endif %}{% endif %}{{ session.city }}, {{ session.state }}, {{ session.country }}{% if session.location_phone %} • {{ session.location_phone }}{% endif %}{% if session.location_website %} • <a href="{{ session.location_website }}" target="_blank">Web</a>{% endif %}{% if session.thesession_id %} • <a href="https://thesession.org/sessions/{{ session.thesession_id }}" target="_blank">thesession.org</a>{% endif %}</p>

            {% if session.recurrence_readable %}
            <p><strong>Schedule:</strong> {{ session.recurrence_readable }}</p>
            {% endif %}

            {% if session.comments %}
            <p><strong>About this session:</strong> {{ session.comments }}</p>
            {% endif %}
        </div>

        <div id="message-container">
            {% with messages = get_flashed_messages() %}
                {% if messages %}
                    <div class="message success">
                        {% for message in messages %}
                            <p>{{ message }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}
        </div>
    </div>

    <!-- Tabbed Interface -->
    <div class="tabs-container">
        <div class="tab-buttons">
            {% if session.session_type == 'festival' %}
            <button class="tab-button active" data-tab="logs">Sessions</button>
            <button class="tab-button" data-tab="tunes">Tunes</button>
            {% else %}
            <button class="tab-button active" data-tab="tunes">Tunes</button>
            <button class="tab-button" data-tab="logs">Logs</button>
            {% endif %}
            {% if is_logged_in and is_session_member %}
            <button class="tab-button" data-tab="people">People</button>
            {% endif %}
        </div>

        <!-- Tunes Tab Content -->
        <div class="tab-content {% if session.session_type != 'festival' %}active{% endif %}" id="tunes-tab">
            <div class="tunes-container">
                <div class="filters-container">
                    <div class="filter-row">
                        <div class="filter-group">
                            <input type="text" id="tune-search" class="filter-input" placeholder="Search" autocomplete="off">
                        </div>
                        <div class="filter-group">
                            <select id="type-filter" class="filter-select" title="Tune type">
                                <option value="">All Types</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="results-count">
                    <span id="results-count-text"></span>
                    <div class="sort-controls">
                        <span class="sort-label">Sort by:</span>
                        <button id="sort-toggle" class="sort-toggle" title="Toggle sort order">
                            <span id="sort-icon">👂</span>
                            <span id="sort-text" class="sort-toggle-text"></span>
                            <span id="sort-arrow"></span>
                        </button>
                    </div>
                </div>

                <div class="tunes-list" id="tunes-list">
                    <!-- Tune rows will be inserted here by JavaScript -->
                </div>
            </div>

            <!-- Tune Detail Modal -->
            <div id="tune-detail-modal" class="modal-overlay">
                <div class="modal-dialog">
                    <div id="tune-detail-content">
                        <!-- Content will be inserted by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs Tab Content -->
        <div class="tab-content {% if session.session_type == 'festival' %}active{% endif %}" id="logs-tab" style="padding-left: 10px;">
            {% if session.session_type == 'festival' %}
                {# Festival view: group by day, show location and time #}
                {% if instances_by_day %}
                <div class="past-instances">
                    <table class="instances-table">
                    {% for day in sorted_days %}
                        <tbody class="year-section">
                            <tr class="year-header-row">
                                <td colspan="2" class="year-header-cell">
                                    <div class="year-header" data-year="{{ day }}">
                                        <div class="year-header-left">
                                            <span class="year-toggle" data-year="{{ day }}">▼</span>
                                            <h3 class="year-title">{{ day.strftime('%A, %B %d, %Y') }}</h3>
                                            {% if loop.first and is_logged_in %}<span class="year-add-link" id="add-session-btn" data-year="{{ day }}">Add</span>{% endif %}
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% for instance in instances_by_day[day] %}
                                {% set location = instance.location_override or session.location_name %}
                                {% set time_str = '' %}
                                {% if instance.start_time and instance.end_time %}
                                    {% set start_hr = instance.start_time.hour %}
                                    {% set start_min = '%02d'|format(instance.start_time.minute) %}
                                    {% set start_period = 'pm' if start_hr >= 12 else 'am' %}
                                    {% set start_12hr = start_hr - 12 if start_hr > 12 else (12 if start_hr == 0 else start_hr) %}
                                    {% set end_hr = instance.end_time.hour %}
                                    {% set end_min = '%02d'|format(instance.end_time.minute) %}
                                    {% set end_period = 'pm' if end_hr >= 12 else 'am' %}
                                    {% set end_12hr = end_hr - 12 if end_hr > 12 else (12 if end_hr == 0 else end_hr) %}
                                    {% set time_str = '%d:%s%s-%d:%s%s'|format(start_12hr, start_min, start_period, end_12hr, end_min, end_period) %}
                                {% elif instance.start_time %}
                                    {% set start_hr = instance.start_time.hour %}
                                    {% set start_min = '%02d'|format(instance.start_time.minute) %}
                                    {% set start_period = 'pm' if start_hr >= 12 else 'am' %}
                                    {% set start_12hr = start_hr - 12 if start_hr > 12 else (12 if start_hr == 0 else start_hr) %}
                                    {% set time_str = '%d:%s%s - ?'|format(start_12hr, start_min, start_period) %}
                                {% endif %}
                                <tr class="year-content-row" data-year="{{ day }}">
                                    <td class="instance-location-cell">
                                        <a href="/sessions/{{ session.path }}/{{ instance | instance_url_id }}" data-instance-id="{{ instance.session_instance_id }}">{{ location }}</a>
                                    </td>
                                    <td class="instance-time-cell">{{ time_str }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    {% endfor %}
                    </table>
                </div>
                {% else %}
                <div class="past-instances">
                    <p><a href="#" id="add-first-session-btn" style="color: var(--primary); text-decoration: none;">Add your first session</a></p>
                </div>
                {% endif %}
            {% else %}
                {# Regular session view: group by year, show date #}
                {% if instances_by_year %}
                <div class="past-instances">
            {% if sorted_years|length > 1 %}
                <table class="instances-table">
                {% for year in sorted_years %}
                    <tbody class="year-section">
                        <tr class="year-header-row">
                            <td class="year-header-cell">
                                <div class="year-header" data-year="{{ year }}">
                                    <div class="year-header-left">
                                        <span class="year-toggle" data-year="{{ year }}">▼</span>
                                        <h3 class="year-title">{{ year }}</h3>
                                        {% if loop.first and is_logged_in %}<span class="year-add-link" id="add-session-btn" data-year="{{ year }}">Add</span>{% endif %}
                                        <a href="#" class="year-view-link" data-year="{{ year }}">view {{ instances_by_year[year]|length }} log{{ 's' if instances_by_year[year]|length != 1 else '' }}</a>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% for instance in instances_by_year[year] %}
                            <tr class="year-content-row" data-year="{{ year }}">
                                <td class="instance-date-cell">
                                    <a href="/sessions/{{ session.path }}/{{ instance | instance_url_id }}" data-instance-id="{{ instance.session_instance_id }}">{{ instance.date }}</a>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                {% endfor %}
                </table>
            {% else %}
                {% if is_logged_in %}<div style="text-align: right; margin-bottom: 10px;"><span class="add-link" id="add-session-btn" style="opacity: 1; cursor: pointer;">Add</span></div>{% endif %}
                <table class="instances-table">
                    <tbody>
                    {% for year in sorted_years %}
                        {% for instance in instances_by_year[year] %}
                            <tr>
                                <td class="instance-date-cell">
                                    <a href="/sessions/{{ session.path }}/{{ instance | instance_url_id }}" data-instance-id="{{ instance.session_instance_id }}">{{ instance.date }}</a>
                                </td>
                            </tr>
                        {% endfor %}
                    {% endfor %}
                    </tbody>
                </table>
            {% endif %}
        </div>
        {% else %}
        <div class="past-instances">
            <p><a href="#" id="add-first-session-btn" style="color: var(--primary); text-decoration: none;">Add your first session log</a></p>
        </div>
        {% endif %}
            {% endif %}
        </div>

        <!-- People Tab Content -->
        {% if is_logged_in and is_session_member %}
        <div class="tab-content" id="people-tab">
            <div class="people-container">
                <div class="people-controls">
                    <input type="text" id="people-search-box" class="people-search-box" placeholder="Search people...">
                    {% if session.session_type != 'festival' %}
                    <button id="people-filter-btn" class="people-filter-btn" onclick="togglePeopleFilter()">Regulars</button>
                    {% endif %}
                    <button class="people-add-btn" onclick="openAddPersonModal()">Add</button>
                </div>
                <div class="people-list" id="people-list">
                    <div style="padding: 40px 20px; text-align: center; color: var(--text-muted, #6c757d);">
                        <i class="loading-dots">Loading people...</i>
                    </div>
                </div>
            </div>

            <!-- Person Detail Modal -->
            <div id="person-detail-modal" class="modal-overlay">
                <div class="modal-dialog">
                    <div id="person-detail-content">
                        <!-- Content will be inserted by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Search Person Modal -->
            <div id="search-person-modal" class="modal-overlay">
                <div class="modal-dialog">
                    <div style="padding: 20px;">
                        <button class="modal-close-btn" onclick="closeSearchPersonModal()" title="Close">&times;</button>
                        <h2 style="margin: 0 32px 20px 0; color: var(--text-color); font-size: 20px; font-weight: 600;">Add Person to Session</h2>

                        <input type="text" id="search-person-input" class="search-person-input" placeholder="Search by name..." autocomplete="off">

                        <div class="search-results-container" id="search-results-container">
                            <div class="search-no-results">
                                Type to search for existing people
                            </div>
                        </div>

                        <div class="search-person-actions">
                            <button class="add-person-btn-cancel" onclick="closeSearchPersonModal()">Cancel</button>
                            <button class="add-person-btn-save" onclick="openCreatePersonModal()">None Of These</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add Person Modal -->
            <div id="add-person-modal" class="modal-overlay">
                <div class="modal-dialog">
                    <div style="padding: 20px;">
                        <button class="modal-close-btn" onclick="closeAddPersonModal()" title="Close">&times;</button>
                        <h2 style="margin: 0 32px 20px 0; color: var(--text-color); font-size: 20px; font-weight: 600;">Add Person to Session</h2>

                        <div class="add-person-form-group">
                            <label for="add-person-first-name">First Name *</label>
                            <input type="text" id="add-person-first-name" required>
                        </div>

                        <div class="add-person-form-group">
                            <label for="add-person-last-name">Last Name *</label>
                            <input type="text" id="add-person-last-name" required>
                        </div>

                        <div class="add-person-form-group">
                            <label>Instruments</label>
                            <div class="instruments-checkboxes" id="add-person-instruments">
                                <div class="instrument-checkbox-item">
                                    <input type="checkbox" id="inst-banjo" value="banjo">
                                    <label for="inst-banjo">Banjo</label>
                                </div>
                                <div class="instrument-checkbox-item">
                                    <input type="checkbox" id="inst-bodhran" value="bodhrán">
                                    <label for="inst-bodhran">Bodhrán</label>
                                </div>
                                <div class="instrument-checkbox-item">
                                    <input type="checkbox" id="inst-bouzouki" value="bouzouki">
                                    <label for="inst-bouzouki">Bouzouki</label>
                                </div>
                                <div class="instrument-checkbox-item">
                                    <input type="checkbox" id="inst-accordion" value="button accordion">
                                    <label for="inst-accordion">Button Accordion</label>
                                </div>
                                <div class="instrument-checkbox-item">
                                    <input type="checkbox" id="inst-concertina" value="concertina">
                                    <label for="inst-concertina">Concertina</label>
                                </div>
                                <div class="instrument-checkbox-item">
                                    <input type="checkbox" id="inst-fiddle" value="fiddle">
                                    <label for="inst-fiddle">Fiddle</label>
                                </div>
                                <div class="instrument-checkbox-item">
                                    <input type="checkbox" id="inst-flute" value="flute">
                                    <label for="inst-flute">Flute</label>
                                </div>
                                <div class="instrument-checkbox-item">
                                    <input type="checkbox" id="inst-guitar" value="guitar">
                                    <label for="inst-guitar">Guitar</label>
                                </div>
                                <div class="instrument-checkbox-item">
                                    <input type="checkbox" id="inst-harp" value="harp">
                                    <label for="inst-harp">Harp</label>
                                </div>
                                <div class="instrument-checkbox-item">
                                    <input type="checkbox" id="inst-mandolin" value="mandolin">
                                    <label for="inst-mandolin">Mandolin</label>
                                </div>
                                <div class="instrument-checkbox-item">
                                    <input type="checkbox" id="inst-piano" value="piano">
                                    <label for="inst-piano">Piano</label>
                                </div>
                                <div class="instrument-checkbox-item">
                                    <input type="checkbox" id="inst-whistle" value="tin whistle">
                                    <label for="inst-whistle">Tin Whistle</label>
                                </div>
                                <div class="instrument-checkbox-item">
                                    <input type="checkbox" id="inst-pipes" value="uilleann pipes">
                                    <label for="inst-pipes">Uilleann Pipes</label>
                                </div>
                            </div>
                        </div>

                        <div class="add-person-form-group">
                            <label for="add-person-thesession">TheSession.org ID or URL (optional)</label>
                            <input type="text" id="add-person-thesession" placeholder="e.g. 12345 or https://thesession.org/members/12345">
                        </div>

                        {% if session.session_type != 'festival' %}
                        <div class="add-person-form-group">
                            <div class="instrument-checkbox-item">
                                <input type="checkbox" id="add-person-is-regular">
                                <label for="add-person-is-regular">Regular?</label>
                            </div>
                        </div>
                        {% endif %}

                        <div class="add-person-actions">
                            <button class="add-person-btn-cancel" onclick="closeAddPersonModal()">Cancel</button>
                            <button class="add-person-btn-save" onclick="saveNewPerson()">Add Person</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Add Session Instance Modal -->
    <div id="add-session-instance-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Session Instance</h3>
            </div>
            <div class="modal-body">
                <label for="session-date-input">Session Date:</label>
                <input type="date" id="session-date-input" required>

                <div style="margin-top: 16px; display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <label for="session-start-time-input">Start Time:</label>
                        <input type="time" id="session-start-time-input">
                    </div>
                    <div>
                        <label for="session-end-time-input">End Time:</label>
                        <input type="time" id="session-end-time-input">
                    </div>
                </div>

                <label for="session-location-input" style="margin-top: 16px;">Location:</label>
                <input type="text" id="session-location-input" placeholder="The usual: {{ session.location_name }}">

                <label for="session-comments-input" style="margin-top: 16px;">Comments:</label>
                <textarea id="session-comments-input" placeholder="Notes about this session" rows="3" style="resize: vertical;"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="add-session-cancel-btn">Cancel</button>
                <button type="button" class="btn-primary" id="add-session-confirm-btn">Add Session</button>
            </div>
        </div>
    </div>


<!-- end landing page -->
</div>

</div>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/dist/modalManager.js"></script>
<script>
    const sessionPath = '{{ session.path }}';
    const isLoggedIn = {{ 'true' if is_logged_in else 'false' }};
    const sessionType = "{{ session.session_type }}";
    const todayInSessionTz = '{{ today_in_session_tz }}';

    async function showAddSessionModal() {
        // Prepare form fields (page-specific business logic)
        const dateInput = document.getElementById('session-date-input');
        const startTimeInput = document.getElementById('session-start-time-input');
        const endTimeInput = document.getElementById('session-end-time-input');
        const locationInput = document.getElementById('session-location-input');
        const commentsInput = document.getElementById('session-comments-input');

        // Set defaults while we fetch the suggestion
        dateInput.value = new Date().toISOString().split('T')[0];
        startTimeInput.value = '';
        endTimeInput.value = '';
        locationInput.value = '';
        commentsInput.value = '';

        // Show modal using ModalManager
        ModalManager.showModal('add-session-instance-modal', {
            autoFocus: false
        });

        // Fetch the next suggested session instance from the API
        try {
            const response = await fetch(`/api/sessions/${sessionPath}/next_instance_suggestion`);
            const data = await response.json();

            if (data.success) {
                // Update form with suggested values
                dateInput.value = data.date || dateInput.value;
                startTimeInput.value = data.start_time || '';
                endTimeInput.value = data.end_time || '';
            }
        } catch (error) {
            console.error('Failed to get next session suggestion:', error);
            // Keep the default values if API call fails
        }
    }
    
    function hideAddSessionModal() {
        ModalManager.hideModal('add-session-instance-modal');
    }
    
    function addSessionInstance() {
        const dateInput = document.getElementById('session-date-input');
        const startTimeInput = document.getElementById('session-start-time-input');
        const endTimeInput = document.getElementById('session-end-time-input');
        const locationInput = document.getElementById('session-location-input');
        const commentsInput = document.getElementById('session-comments-input');

        const date = dateInput.value.trim();
        const startTime = startTimeInput.value.trim();
        const endTime = endTimeInput.value.trim();
        const location = locationInput.value.trim();
        const comments = commentsInput.value.trim();

        if (!date) {
            showMessage('Please enter a session date', 'error');
            return;
        }

        // Prepare request data
        const requestData = {
            date: date
        };

        // Only include start_time if it's provided
        if (startTime) {
            requestData.start_time = startTime;
        }

        // Only include end_time if it's provided
        if (endTime) {
            requestData.end_time = endTime;
        }

        // Only include location if it's provided
        if (location) {
            requestData.location = location;
        }

        // Only include comments if provided
        if (comments) {
            requestData.comments = comments;
        }
        
        // Call API to create the session instance
        fetch(`/api/sessions/${sessionPath}/add_instance`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage(data.message);
                hideAddSessionModal();
                // Redirect to the new session instance with edit mode parameter
                // Use session_instance_id for unambiguous URL
                const instanceId = data.session_instance_id || date;
                window.location.href = `/sessions/${sessionPath}/${instanceId}?edit=true`;
            } else {
                showMessage(data.message, 'error');
            }
        })
        .catch(error => {
            showMessage('Failed to add session instance', 'error');
            console.error('Error:', error);
        });
    }
    

    
    // Close modals on escape key
    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
            // Check if tune detail modal is open
            const tuneModal = document.getElementById('tune-detail-modal');
            if (tuneModal && tuneModal.style.display === 'flex') {
                closeTuneDetailModal();
                return;
            }

            // Otherwise check for add session modal
            hideAddSessionModal();
        }
    });
    
    // Close modal when clicking outside
    document.getElementById('add-session-instance-modal').addEventListener('click', (event) => {
        if (event.target === event.currentTarget) {
            hideAddSessionModal();
        }
    });
    
    // Year section toggle functionality
    function toggleYearSection(year) {
        const toggle = document.querySelector(`.year-toggle[data-year="${year}"]`);
        const contentRows = document.querySelectorAll(`.year-content-row[data-year="${year}"]`);
        const viewLink = document.querySelector(`.year-view-link[data-year="${year}"]`);
        const addLink = document.querySelector(`.year-add-link[data-year="${year}"]`);

        if (!toggle || contentRows.length === 0) return;

        const isCollapsed = contentRows[0].classList.contains('collapsed');

        if (isCollapsed) {
            // Expand
            contentRows.forEach(row => row.classList.remove('collapsed'));
            toggle.classList.remove('collapsed');
            if (viewLink) viewLink.classList.remove('visible');
            if (addLink) addLink.classList.remove('hidden');
        } else {
            // Collapse
            contentRows.forEach(row => row.classList.add('collapsed'));
            toggle.classList.add('collapsed');
            if (viewLink) viewLink.classList.add('visible');
            if (addLink) addLink.classList.add('hidden');
        }
    }
    
    function expandYearSection(year) {
        const toggle = document.querySelector(`.year-toggle[data-year="${year}"]`);
        const contentRows = document.querySelectorAll(`.year-content-row[data-year="${year}"]`);
        const viewLink = document.querySelector(`.year-view-link[data-year="${year}"]`);
        const addLink = document.querySelector(`.year-add-link[data-year="${year}"]`);

        if (!toggle || contentRows.length === 0) return;

        contentRows.forEach(row => row.classList.remove('collapsed'));
        toggle.classList.remove('collapsed');
        if (viewLink) viewLink.classList.remove('visible');
        if (addLink) addLink.classList.remove('hidden');
    }

    // Tab switching functionality
    function switchTab(tabName, updateURL = true) {
        // Update tab buttons
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`.tab-button[data-tab="${tabName}"]`).classList.add('active');

        // Update tab content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(`${tabName}-tab`).classList.add('active');

        // Update URL query string
        if (updateURL) {
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.set('tab', tabName);
            const newURL = window.location.pathname + '?' + urlParams.toString();
            window.history.replaceState({}, '', newURL);
        }
    }

    // Tunes tab functionality
    const allTunes = {{ tunes|tojson }};
    let filteredTunes = [];
    let currentFilters = {
        search: '',
        type: ''
    };
    let modalShowTime = 0;
    let isInitializing = true; // Flag to prevent URL updates during initialization

    // Sort mode cycle states (with icons and text labels)
    const sortModes = [
        { id: 'alpha-asc', label: 'Alphabetical', icon: '', arrow: '↓', sortFn: (a, b) => (a[1] || '').localeCompare(b[1] || '') },
        { id: 'alpha-desc', label: 'Alphabetical', icon: '', arrow: '↑', sortFn: (a, b) => (b[1] || '').localeCompare(a[1] || '') },
        { id: 'session-desc', label: 'Popularity At This Session', icon: '👂', arrow: '', sortFn: (a, b) => (b[3] || 0) - (a[3] || 0) },
        { id: 'session-asc', label: 'Popularity At This Session', icon: '👂', arrow: '↑', sortFn: (a, b) => (a[3] || 0) - (b[3] || 0) },
        { id: 'tunebooks-desc', label: 'Popularity Everywhere', icon: '#', arrow: '', sortFn: (a, b) => (b[4] || 0) - (a[4] || 0) },
        { id: 'tunebooks-asc', label: 'Popularity Everywhere', icon: '#', arrow: '↑', sortFn: (a, b) => (a[4] || 0) - (b[4] || 0) }
    ];
    let currentSortModeIndex = 2; // Start with session popularity descending

    // Initialize tunes tab
    function initializeTunesTab() {
        console.log('Initializing tunes tab with', allTunes.length, 'tunes');
        populateTuneTypes();
        loadStateFromURL();
        setupTunesEventListeners();
        updateSortDisplay();
        applyFilters();
        isInitializing = false; // Allow URL updates after initialization
    }

    // Load filter and sort state from URL query string
    function loadStateFromURL() {
        const urlParams = new URLSearchParams(window.location.search);

        // Load search filter
        const searchParam = urlParams.get('search');
        if (searchParam) {
            currentFilters.search = searchParam.toLowerCase().trim();
            document.getElementById('tune-search').value = searchParam;
        }

        // Load type filter
        const typeParam = urlParams.get('type');
        if (typeParam) {
            currentFilters.type = typeParam;
            document.getElementById('type-filter').value = typeParam;
        }

        // Load sort mode
        const sortParam = urlParams.get('sort');
        if (sortParam) {
            const sortIndex = sortModes.findIndex(mode => mode.id === sortParam);
            if (sortIndex !== -1) {
                currentSortModeIndex = sortIndex;
            }
        }
    }

    // Update URL with current filter and sort state
    function updateURL() {
        if (isInitializing) return; // Don't update URL during initialization

        const urlParams = new URLSearchParams(window.location.search);

        // Preserve tune parameter if present
        const tuneParam = urlParams.get('tune');

        // Update search parameter
        if (currentFilters.search) {
            urlParams.set('search', currentFilters.search);
        } else {
            urlParams.delete('search');
        }

        // Update type parameter
        if (currentFilters.type) {
            urlParams.set('type', currentFilters.type);
        } else {
            urlParams.delete('type');
        }

        // Update sort parameter (only if not default)
        const currentSort = sortModes[currentSortModeIndex].id;
        if (currentSortModeIndex !== 2) { // 2 is the default (session-desc)
            urlParams.set('sort', currentSort);
        } else {
            urlParams.delete('sort');
        }

        // Restore tune parameter if it was present
        if (tuneParam) {
            urlParams.set('tune', tuneParam);
        }

        // Update the URL without reloading the page
        const newURL = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
        window.history.replaceState({}, '', newURL);
    }

    function updateSortDisplay() {
        const mode = sortModes[currentSortModeIndex];
        const icon = document.getElementById('sort-icon');
        const text = document.getElementById('sort-text');
        const arrow = document.getElementById('sort-arrow');
        icon.textContent = mode.icon;
        text.textContent = mode.label;
        arrow.textContent = mode.arrow;
    }

    function populateTuneTypes() {
        // Extract unique tune types from the data
        const types = [...new Set(allTunes.map(tune => tune[2]).filter(Boolean))];
        types.sort();

        const typeFilter = document.getElementById('type-filter');
        types.forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = type.charAt(0).toUpperCase() + type.slice(1);
            typeFilter.appendChild(option);
        });
    }

    function setupTunesEventListeners() {
        // Search input with debounce
        let searchTimeout;
        document.getElementById('tune-search').addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentFilters.search = e.target.value.toLowerCase().trim();
                applyFilters();
                updateURL();
            }, 300);
        });

        // Type filter
        document.getElementById('type-filter').addEventListener('change', function(e) {
            currentFilters.type = e.target.value;
            applyFilters();
            updateURL();
        });

        // Sort toggle button
        document.getElementById('sort-toggle').addEventListener('click', cycleSortMode);

        // Modal overlay click handler
        const modalOverlay = document.getElementById('tune-detail-modal');
        modalOverlay.addEventListener('click', function(event) {
            const timeSinceShown = Date.now() - modalShowTime;
            if (timeSinceShown < 500) {
                return;
            }

            if (event.target === event.currentTarget && event.target.classList.contains('modal-overlay')) {
                closeTuneDetailModal();
            }
        });
    }

    function cycleSortMode() {
        currentSortModeIndex = (currentSortModeIndex + 1) % sortModes.length;
        updateSortDisplay();
        applyFilters();
        updateURL();
    }

    function applyFilters() {
        // Filter tunes based on search and type
        filteredTunes = allTunes.filter(tune => {
            // Search filter
            if (currentFilters.search) {
                const tuneName = (tune[1] || '').toLowerCase();
                if (!tuneName.includes(currentFilters.search)) {
                    return false;
                }
            }

            // Type filter
            if (currentFilters.type && tune[2] !== currentFilters.type) {
                return false;
            }

            return true;
        });

        // Apply sorting
        const sortMode = sortModes[currentSortModeIndex];
        if (sortMode && sortMode.sortFn) {
            filteredTunes.sort(sortMode.sortFn);
        }

        renderTunes();
    }

    function renderTunes() {
        const list = document.getElementById('tunes-list');
        const resultsCountText = document.getElementById('results-count-text');

        // Update results count
        const total = allTunes.length;
        const filtered = filteredTunes.length;
        if (filtered < total) {
            resultsCountText.textContent = `Showing ${filtered} of ${total} tunes`;
        } else {
            resultsCountText.textContent = `${total} tune${total !== 1 ? 's' : ''}`;
        }

        // Render tune rows or show "no results" message with add button
        if (filtered === 0 && currentFilters.search) {
            const addTuneButton = isLoggedIn
                ? `<a href="/sessions/${sessionPath}/tunes/add?q=${encodeURIComponent(currentFilters.search)}"
                       class="btn btn-primary"
                       style="padding: 12px 24px; background-color: var(--primary); color: white; text-decoration: none; border-radius: 4px; display: inline-block;">
                        Add Tune
                    </a>`
                : '';
            list.innerHTML = `
                <div style="padding: 40px 20px; text-align: center; color: var(--text-muted, #6c757d);">
                    <p style="margin-bottom: 20px;">No tunes found matching "${escapeHtml(currentFilters.search)}"</p>
                    ${addTuneButton}
                </div>
            `;
        } else {
            list.innerHTML = filteredTunes.map(tune => createTuneRow(tune)).join('');
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function createTuneRow(tune) {
        // tune is [tune_id, tune_name, tune_type, times_played, tunebook_count, setting_id]
        const tuneId = tune[0];
        const tuneName = tune[1] || 'Unknown';
        const tuneType = tune[2] || '';
        const timesPlayed = tune[3] || 0;
        const tunebookCount = tune[4] || 0;
        const settingId = tune[5];

        // Determine what to show based on sort mode
        const sortMode = sortModes[currentSortModeIndex];
        const isSessionMode = sortMode.id.startsWith('session-');
        const isTunebooksMode = sortMode.id.startsWith('tunebooks-');

        let countBadge = '';
        let typeBadge = '';

        if (isSessionMode) {
            countBadge = `<span class="tune-count-badge">${timesPlayed}</span>`;
            typeBadge = tuneType ? `<span class="tune-type">${tuneType}</span>` : '';
        } else if (isTunebooksMode) {
            countBadge = `<span class="tune-count-badge">${tunebookCount}</span>`;
            typeBadge = tuneType ? `<span class="tune-type">${tuneType}</span>` : '';
        } else {
            // Alphabetical sort - show tune type only
            typeBadge = tuneType ? `<span class="tune-type">${tuneType}</span>` : '';
        }

        return `
            <div class="tune-row" onclick="showTuneDetail(${tuneId}, '${tuneName.replace(/'/g, "\\'")}', '${tuneType}', ${timesPlayed}, ${tunebookCount}, ${settingId || 'null'})">
                <div class="tune-row-header">
                    <h3 class="tune-name">${tuneName}</h3>
                </div>
                <div class="tune-meta">
                    ${typeBadge}
                    ${countBadge}
                </div>
            </div>
        `;
    }

    function showTuneDetail(tuneId, tuneName, tuneType, timesPlayed, tunebookCount, settingId) {
        const modal = document.getElementById('tune-detail-modal');
        const modalContent = document.getElementById('tune-detail-content');

        // Update URL with tune parameter
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('tune', tuneId);
        const newURL = window.location.pathname + '?' + urlParams.toString();
        window.history.replaceState({}, '', newURL);

        // Show modal immediately with basic info
        displayTuneDetailModalBasic(tuneId, tuneName, tuneType, timesPlayed, tunebookCount, settingId);

        // Fetch full details from the API
        const apiUrl = `/api/sessions/${sessionPath}/tunes/${tuneId}`;
        console.log('Fetching tune details from:', apiUrl);

        fetch(apiUrl)
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('API response:', data);
                if (data.success) {
                    displayTuneDetailModalFull(data.session_tune);
                } else {
                    console.error('Failed to load tune details:', data.message || 'Unknown error');
                }
            })
            .catch(error => {
                console.error('Error loading tune details:', error);
            });
    }

    function displayTuneDetailModalBasic(tuneId, tuneName, tuneType, timesPlayed, tunebookCount, settingId) {
        const modal = document.getElementById('tune-detail-modal');
        const modalContent = document.getElementById('tune-detail-content');

        // Build thesession.org link
        const thesessionUrl = settingId
            ? `https://thesession.org/tunes/${tuneId}#setting${settingId}`
            : `https://thesession.org/tunes/${tuneId}`;
        const thesessionLinkIcon = `<a href="${thesessionUrl}" target="_blank" class="thesession-link-icon" title="View on TheSession.org" onclick="event.stopPropagation();">🔗</a>`;

        // Display name - will be updated with alias if available
        const displayName = tuneName || 'Unknown';

        modalContent.innerHTML = `
            <button class="modal-close-btn" onclick="closeTuneDetailModal()" title="Close">&times;</button>
            <h2 class="modal-tune-title">${displayName} ${thesessionLinkIcon}</h2>
            <div class="modal-info-line"><strong>Type:</strong> ${tuneType || 'Unknown'}</div>
            <div class="modal-info-line"><strong>We also call it:</strong> <span class="loading-dots">...</span></div>
            <div class="modal-info-line"><strong>Our Setting:</strong> <span class="loading-dots">...</span></div>
            <div class="modal-info-line"><strong>Our Key:</strong> <span class="loading-dots">...</span></div>
            <div class="modal-info-line"><strong>TheSession.org Popularity:</strong> ${tunebookCount || 0} tunebooks <span class="loading-dots">...</span></div>
            <div class="modal-info-line"><strong>Play History:</strong> Total times played in this session: ${timesPlayed}</div>
        `;

        // Show modal
        modal.style.display = 'flex';

        // Add 'show' class after a small delay to trigger slide-in animation
        setTimeout(() => {
            modal.classList.add('show');
        }, 10);

        // Record the time when modal is shown
        modalShowTime = Date.now();
    }

    function displayTuneDetailModalFull(sessionTune) {
        const modalContent = document.getElementById('tune-detail-content');

        // Build display name (alias takes precedence if it exists)
        const displayName = sessionTune.alias || sessionTune.tune_name || 'Unknown';

        // Build thesession.org link with setting if available
        const thesessionUrl = sessionTune.setting_id
            ? `https://thesession.org/tunes/${sessionTune.tune_id}#setting${sessionTune.setting_id}`
            : `https://thesession.org/tunes/${sessionTune.tune_id}`;
        const thesessionLinkIcon = `<a href="${thesessionUrl}" target="_blank" class="thesession-link-icon" title="View on TheSession.org" onclick="event.stopPropagation();">🔗</a>`;

        // Build aliases input (comma-delimited)
        const aliasesValue = sessionTune.aliases && sessionTune.aliases.length > 0
            ? sessionTune.aliases.join(', ')
            : '';

        // Build setting ID input value
        const settingIdValue = sessionTune.setting_id || '';

        // Build key input value
        const keyValue = sessionTune.key || '';

        // Build popularity display with refresh icon and cached date
        const tunebookCount = sessionTune.tunebook_count || 0;
        const cachedDate = sessionTune.tunebook_count_cached_date || '';
        const cachedDateId = 'cached-date-display';
        const cachedDateDisplay = cachedDate
            ? `<span id="${cachedDateId}" style="margin-left: 10px; color: var(--disabled-text); font-style: italic; font-size: 0.8em;">Last Updated: ${cachedDate}</span>`
            : `<span id="${cachedDateId}" style="margin-left: 10px; color: var(--disabled-text); font-style: italic; font-size: 0.8em; display: none;"></span>`;
        const popularityDisplay = `
            <span id="tunebook-count">${tunebookCount} tunebook${tunebookCount !== 1 ? 's' : ''}</span>
            <button id="refresh-tunebook" onclick="refreshTunebookCount(${sessionTune.tune_id})" style="margin-left: 10px; padding: 4px 8px; font-size: 0.9em; cursor: pointer; background-color: var(--light); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 3px; line-height: 1;" title="Refresh popularity count">↻</button>
            ${cachedDateDisplay}
        `;

        // Build play history instances list
        const playCount = sessionTune.times_played || 0;
        let playInstancesHtml = '';
        if (sessionTune.play_instances && sessionTune.play_instances.length > 0) {
            playInstancesHtml = `
                <ul style="list-style: none; padding: 0; margin-top: 10px;">
                    ${sessionTune.play_instances.map(instance => {
                        const dateStr = instance.date || 'Unknown date';
                        const positionStr = instance.position_in_set ? `#${instance.position_in_set}` : '';
                        let overridesHtml = '';
                        const overrides = [];
                        if (instance.name_override) overrides.push(`Name: "${instance.name_override}"`);
                        if (instance.key_override) overrides.push(`Key: ${instance.key_override}`);
                        if (instance.setting_id_override) overrides.push(`Setting: #${instance.setting_id_override}`);
                        if (overrides.length > 0) {
                            overridesHtml = `<div style="font-style: italic; color: #856404; font-size: 0.9em; margin-top: 4px;">${overrides.join(' • ')}</div>`;
                        }
                        return `
                            <li style="margin: 8px 0; padding: 10px; background-color: var(--hover-bg, #f8f9fa); border-radius: 4px;">
                                <div style="font-weight: bold; color: var(--primary, #007bff);">
                                    <a href="/sessions/${sessionPath}/${dateStr}?tune=${sessionTune.tune_id}" style="color: var(--primary);">${dateStr}</a>
                                </div>
                                <div style="font-size: 0.9em; color: var(--disabled-text, #666); margin-top: 4px;">
                                    Position in set: ${positionStr}
                                    ${overridesHtml}
                                </div>
                            </li>
                        `;
                    }).join('')}
                </ul>
            `;
        } else {
            playInstancesHtml = `<p style="color: var(--disabled-text); font-style: italic; margin-top: 10px;">No instances recorded yet.</p>`;
        }

        modalContent.innerHTML = `
            <button class="modal-close-btn" onclick="closeTuneDetailModal()" title="Close">&times;</button>
            <div class="modal-info-section">
                <h2 class="modal-tune-title">${displayName} ${thesessionLinkIcon}</h2>
                <div class="modal-info-line">
                    <strong>Type:</strong> <span class="tune-type">${sessionTune.tune_type || 'Unknown'}</span>
                </div>
                <div id="tune-list-status-container"></div>
                ${isLoggedIn ? `
                <div class="modal-info-line">
                    <strong>We also call it:</strong><br>
                    <input type="text" id="aliases-input" value="${aliasesValue}" style="width: 100%; padding: 6px 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px; background-color: var(--bg-color); color: var(--text-color); margin-top: 6px;" placeholder="Comma-separated aliases">
                </div>
                <div class="modal-info-line">
                    <strong>Our Setting:</strong><br>
                    <input type="text" id="setting-id-input" value="${settingIdValue}" style="width: 100%; padding: 6px 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px; background-color: var(--bg-color); color: var(--text-color); margin-top: 6px;" placeholder="Setting ID (number)">
                </div>
                <div class="modal-info-line">
                    <strong>Our Key:</strong><br>
                    <input type="text" id="key-input" value="${keyValue}" style="width: 100%; padding: 6px 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px; background-color: var(--bg-color); color: var(--text-color); margin-top: 6px;" placeholder="Key (e.g., D, G, Am)">
                </div>
                <div class="modal-button-group" style="margin-top: 12px;">
                    <button class="modal-cancel-btn" onclick="closeTuneDetailModal()">Cancel</button>
                    <button id="save-tune-details-btn" class="modal-save-btn" onclick="saveTuneDetails(${sessionTune.tune_id})">Save</button>
                </div>
                ` : `
                <div class="modal-info-line">
                    <strong>We also call it:</strong> ${aliasesValue || '(none)'}
                </div>
                <div class="modal-info-line">
                    <strong>Our Setting:</strong> ${settingIdValue ? '#' + settingIdValue : '(none)'}
                </div>
                <div class="modal-info-line">
                    <strong>Our Key:</strong> ${keyValue || '(none)'}
                </div>
                `}
                <div class="modal-info-line"><strong>TheSession.org Popularity:</strong> ${popularityDisplay}</div>
            </div>
            <div class="modal-play-history">
                <div class="modal-info-line">
                    <strong>Play History</strong><br>
                    <div style="margin-top: 6px;">Total times played in this session: ${playCount}</div>
                    ${playInstancesHtml}
                </div>
            </div>
        `;

        // Display tune list status if user is logged in and we have the data
        if (isLoggedIn && sessionTune.person_tune_status) {
            renderTuneListStatus(
                sessionTune.tune_id,
                sessionTune.person_tune_status.on_list,
                sessionTune.person_tune_status.on_list ? {
                    learn_status: sessionTune.person_tune_status.learn_status,
                    heard_count: sessionTune.person_tune_status.heard_count
                } : null
            );
        }
    }

    function fetchAndDisplayTuneListStatus(tuneId) {
        fetch(`/api/person/tunes/${tuneId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderTuneListStatus(tuneId, data.on_list, data.tune_status);
                }
            })
            .catch(error => {
                console.error('Error fetching tune list status:', error);
            });
    }

    function renderTuneListStatus(tuneId, onList, tuneStatus) {
        const container = document.getElementById('tune-list-status-container');
        if (!container) return;

        if (onList && tuneStatus) {
            // Tune IS on the list - color by status
            const learnStatus = tuneStatus.learn_status;
            const heardCount = tuneStatus.heard_count;
            const showHeardSection = learnStatus !== 'learned';
            const pluralS = heardCount !== 1 ? 's' : '';
            const statusClass = learnStatus.replace(' ', '-'); // "want to learn" -> "want-to-learn"

            container.innerHTML = `
                <div class="modal-info-line tune-list-box tune-list-box-${statusClass}" style="padding: 10px 12px; border-radius: 4px; margin-bottom: 12px;">
                    <div style="margin-bottom: ${showHeardSection ? '8px' : '0'};">
                        This tune is on your list, as
                        <select id="tune-status-select" onchange="updateTuneStatus(${tuneId})" class="tune-list-select" style="padding: 4px 8px; border-radius: 3px; margin: 0 2px;">
                            <option value="want to learn" ${learnStatus === 'want to learn' ? 'selected' : ''}>Want To Learn</option>
                            <option value="learning" ${learnStatus === 'learning' ? 'selected' : ''}>Learning</option>
                            <option value="learned" ${learnStatus === 'learned' ? 'selected' : ''}>Learned</option>
                        </select>
                    </div>
                    ${showHeardSection ? `
                    <div class="heard-count-line">
                        You've heard it&nbsp;<span id="heard-count">${heardCount}</span>&nbsp;time${pluralS}
                        <button onclick="incrementHeardCount(${tuneId})" class="tune-list-button tune-list-button-heard">
                            I heard it again!
                        </button>
                    </div>
                    ` : ''}
                </div>
            `;
        } else {
            // Tune is NOT on the list - show red state
            container.innerHTML = `
                <div class="modal-info-line tune-list-box tune-list-box-not-on-list" style="padding: 10px 12px; border-radius: 4px; margin-bottom: 12px;">
                    <div style="margin-bottom: 8px;">
                        This tune isn't on your list!
                    </div>
                    <div>
                        <button onclick="addTuneToList(${tuneId})" class="tune-list-button tune-list-button-add">
                            Add It
                        </button>
                        <span style="margin: 0 4px;">to</span>
                        <select id="add-status-select" class="tune-list-select" style="padding: 4px 8px; border-radius: 3px;">
                            <option value="want to learn" selected>Want To Learn</option>
                            <option value="learning">Learning</option>
                            <option value="learned">Learned</option>
                        </select>
                    </div>
                </div>
            `;
        }
    }

    function addTuneToList(tuneId) {
        const statusSelect = document.getElementById('add-status-select');
        const learnStatus = statusSelect ? statusSelect.value : 'want to learn';

        fetch('/api/person/tunes', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                tune_id: tuneId,
                learn_status: learnStatus,
                heard_count: 1
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Re-fetch and render the updated status
                fetchAndDisplayTuneListStatus(tuneId);
            } else {
                console.error('Failed to add tune:', data.error);
                alert('Failed to add tune to list');
            }
        })
        .catch(error => {
            console.error('Error adding tune:', error);
            alert('Error adding tune to list');
        });
    }

    function updateTuneStatus(tuneId) {
        const statusSelect = document.getElementById('tune-status-select');
        const learnStatus = statusSelect ? statusSelect.value : 'want to learn';

        fetch(`/api/person/tunes/${tuneId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                learn_status: learnStatus
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show toast message
                showToast('Status updated');
                // Re-fetch and render to update the heard count visibility
                fetchAndDisplayTuneListStatus(tuneId);
            } else {
                console.error('Failed to update status:', data.error);
                alert('Failed to update status');
            }
        })
        .catch(error => {
            console.error('Error updating status:', error);
            alert('Error updating status');
        });
    }

    function incrementHeardCount(tuneId) {
        fetch(`/api/person/tunes/${tuneId}/increment_heard`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show toast message
                showToast(data.message);

                // Update the heard count display
                const heardCountSpan = document.getElementById('heard-count');
                if (heardCountSpan) {
                    heardCountSpan.textContent = data.new_count;
                }

                // Close modal after 1 second
                setTimeout(() => {
                    closeTuneDetailModal();
                }, 1000);
            } else {
                console.error('Failed to increment count:', data.error);
                alert('Failed to increment heard count');
            }
        })
        .catch(error => {
            console.error('Error incrementing count:', error);
            alert('Error incrementing heard count');
        });
    }

    function showToast(message) {
        // Create toast element
        const toast = document.createElement('div');
        toast.textContent = message;
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #28a745;
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 10002;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        `;
        document.body.appendChild(toast);

        // Remove toast after 2 seconds
        setTimeout(() => {
            toast.remove();
        }, 2000);
    }

    function refreshTunebookCount(tuneId) {
        const button = document.getElementById('refresh-tunebook');
        const countSpan = document.getElementById('tunebook-count');
        const dateSpan = document.getElementById('cached-date-display');

        // Disable button and show loading state
        button.disabled = true;
        const originalButtonText = button.textContent;
        button.textContent = '⟳';

        // Make API call
        fetch(`/api/sessions/${sessionPath}/tunes/${tuneId}/refresh_tunebook_count`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the display with new count
                const newCount = data.new_count;
                const suffix = newCount === 1 ? '' : 's';
                countSpan.textContent = `${newCount} tunebook${suffix}`;

                // Update the cached date display
                if (data.cached_date && dateSpan) {
                    dateSpan.textContent = `Last Updated: ${data.cached_date}`;
                    dateSpan.style.display = '';
                } else if (dateSpan) {
                    dateSpan.style.display = 'none';
                }

                // Show a temporary success message
                if (data.old_count !== data.new_count) {
                    button.textContent = '✓';
                    button.style.backgroundColor = '#28a745';
                    button.style.color = 'white';
                } else {
                    button.textContent = '−';
                    button.style.backgroundColor = '#6c757d';
                    button.style.color = 'white';
                }
            } else {
                // Show error message
                button.textContent = '✗';
                button.style.backgroundColor = '#dc3545';
                button.style.color = 'white';
                console.error('Error:', data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            button.textContent = '✗';
            button.style.backgroundColor = '#dc3545';
            button.style.color = 'white';
        })
        .finally(() => {
            // Reset button after 2 seconds
            setTimeout(() => {
                button.disabled = false;
                button.textContent = originalButtonText;
                button.style.backgroundColor = '';
                button.style.color = '';
            }, 2000);
        });
    }

    function saveTuneDetails(tuneId) {
        const aliasesInput = document.getElementById('aliases-input');
        const settingIdInput = document.getElementById('setting-id-input');
        const keyInput = document.getElementById('key-input');
        const saveButton = document.getElementById('save-tune-details-btn');

        // Get values
        const aliases = aliasesInput.value.trim();
        const settingId = settingIdInput.value.trim();
        const key = keyInput.value.trim();

        // Disable button and show saving state
        saveButton.disabled = true;
        saveButton.textContent = 'Saving...';

        // Make API call to save the tune details
        fetch(`/api/sessions/${sessionPath}/tunes/${tuneId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                aliases: aliases,
                setting_id: settingId,
                key: key
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                saveButton.textContent = 'Saved!';
                saveButton.style.backgroundColor = '#28a745';

                // Update the tune list if needed (refresh setting_id in memory)
                const tuneIndex = allTunes.findIndex(t => t[0] === tuneId);
                if (tuneIndex !== -1) {
                    allTunes[tuneIndex][5] = settingId ? parseInt(settingId) : null;
                }

                setTimeout(() => {
                    saveButton.disabled = false;
                    saveButton.textContent = 'Save';
                    saveButton.style.backgroundColor = '';
                }, 1500);
            } else {
                saveButton.textContent = 'Error';
                saveButton.style.backgroundColor = '#dc3545';
                console.error('Error saving tune details:', data.message);

                setTimeout(() => {
                    saveButton.disabled = false;
                    saveButton.textContent = 'Save';
                    saveButton.style.backgroundColor = '';
                }, 2000);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            saveButton.textContent = 'Error';
            saveButton.style.backgroundColor = '#dc3545';

            setTimeout(() => {
                saveButton.disabled = false;
                saveButton.textContent = 'Save';
                saveButton.style.backgroundColor = '';
            }, 2000);
        });
    }

    function closeTuneDetailModal() {
        const modal = document.getElementById('tune-detail-modal');

        // Remove tune parameter from URL
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.delete('tune');
        const newURL = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
        window.history.replaceState({}, '', newURL);

        // Remove 'show' class to trigger slide-out animation
        modal.classList.remove('show');

        // Wait for animation to complete before hiding
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }

    // Active Session Instance Highlighting
    const sessionId = {{ session.session_id }};

    function highlightActiveInstances() {
        fetch(`/api/session/${sessionId}/active_instance`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.active_instance_ids && data.active_instance_ids.length > 0) {
                    const activeInstanceIds = data.active_instance_ids;

                    // Find all session instance links with data-instance-id attribute
                    const links = document.querySelectorAll('.year-content-row a[data-instance-id], .instances-table a[data-instance-id]');

                    links.forEach(link => {
                        const instanceId = parseInt(link.getAttribute('data-instance-id'));

                        // Check if this instance ID is in the active list
                        if (activeInstanceIds.includes(instanceId)) {
                            highlightLink(link);
                        }
                    });
                }
            })
            .catch(error => {
                console.error('Error fetching active instances:', error);
            });
    }

    function highlightLink(linkElement) {
        // Wrap the link content with the highlighting class
        const originalText = linkElement.textContent;
        linkElement.innerHTML = '';

        const wrapper = document.createElement('span');
        wrapper.className = 'session-instance-link active-now';

        const textSpan = document.createElement('span');
        textSpan.textContent = originalText;

        const badge = document.createElement('span');
        badge.className = 'active-now-badge';
        badge.textContent = 'Active Now';

        wrapper.appendChild(textSpan);
        wrapper.appendChild(badge);
        linkElement.appendChild(wrapper);
    }

    // Show initial flash messages and setup event listeners when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        // Setup tab switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', function() {
                switchTab(this.getAttribute('data-tab'));
            });
        });

        // Check URL parameters
        const urlParams = new URLSearchParams(window.location.search);

        // Check for tab parameter and switch to it if present
        const tabParam = urlParams.get('tab');
        if (tabParam) {
            const tabButton = document.querySelector(`.tab-button[data-tab="${tabParam}"]`);
            if (tabButton) {
                switchTab(tabParam, false); // Don't update URL since we're reading from it
            }
        }

        // Initialize tunes tab on page load since it's the default tab
        initializeTunesTab();

        // Highlight active session instances
        highlightActiveInstances();

        // Check for tune parameter and open tune modal if present
        const tuneId = urlParams.get('tune');
        if (tuneId) {
            // Find the tune in the allTunes array
            const tuneIdNum = parseInt(tuneId);
            const tune = allTunes.find(t => t[0] === tuneIdNum);
            if (tune) {
                // Show the tune detail modal
                setTimeout(() => {
                    showTuneDetail(tune[0], tune[1], tune[2], tune[3], tune[4], tune[5]);
                }, 100);
            }
        }

        // Event listeners for buttons and modals
        const addSessionBtn = document.getElementById('add-session-btn');
        if (addSessionBtn) {
            addSessionBtn.addEventListener('click', showAddSessionModal);
        }
        
        const addFirstSessionBtn = document.getElementById('add-first-session-btn');
        if (addFirstSessionBtn) {
            addFirstSessionBtn.addEventListener('click', showAddSessionModal);
        }
        
        document.getElementById('add-session-cancel-btn').addEventListener('click', hideAddSessionModal);
        document.getElementById('add-session-confirm-btn').addEventListener('click', addSessionInstance);
        
        
        // Handle enter key in date input (only for add session instance modal)
        document.getElementById('session-date-input').addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                const addModal = document.getElementById('add-session-instance-modal');
                if (addModal.style.display === 'flex') {
                    addSessionInstance();
                }
            }
        });
        
        // Setup year section toggle functionality
        document.querySelectorAll('.year-header').forEach(header => {
            header.addEventListener('click', function(e) {
                e.preventDefault();
                const year = this.getAttribute('data-year');
                toggleYearSection(year);
            });
        });
        
        // Setup view links
        document.querySelectorAll('.year-view-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const year = this.getAttribute('data-year');
                expandYearSection(year);
            });
        });
        
        // Collapse all years/days except the one to show by default
        const yearHeaders = document.querySelectorAll('.year-header');
        if (yearHeaders.length > 1) {
            // Get all years/days
            const years = Array.from(yearHeaders).map(header => header.getAttribute('data-year'));

            // For festivals, check if today is one of the days
            let defaultOpen = years[0]; // Default to latest/first
            if (sessionType === 'festival' && todayInSessionTz) {
                // Check if today matches any of the festival days
                const todayMatches = years.find(day => day === todayInSessionTz);
                if (todayMatches) {
                    defaultOpen = todayMatches;
                }
            }

            // Collapse all except the defaultOpen
            years.forEach(year => {
                if (year !== defaultOpen) {
                    const contentRows = document.querySelectorAll(`.year-content-row[data-year="${year}"]`);
                    const toggle = document.querySelector(`.year-toggle[data-year="${year}"]`);
                    const viewLink = document.querySelector(`.year-view-link[data-year="${year}"]`);
                    const addLink = document.querySelector(`.year-add-link[data-year="${year}"]`);

                    if (contentRows.length > 0 && toggle) {
                        contentRows.forEach(row => row.classList.add('collapsed'));
                        toggle.classList.add('collapsed');
                        if (viewLink) viewLink.classList.add('visible');
                        if (addLink) addLink.classList.add('hidden');
                    }
                }
            });
        }
        
        // Show initial flash messages if any
        const existingMessage = document.querySelector('.message');
        if (existingMessage) {
            setTimeout(() => {
                existingMessage.classList.add('show');
            }, 10);
        }

        // Initialize people tab if user is a session member
        {% if is_logged_in and is_session_member %}
        initializePeopleTab();
        {% endif %}
    });

    // People tab functionality
    let peopleData = [];
    let personModalShowTime = 0;
    // Default to 'all' for festivals, 'regulars' for regular sessions
    let currentPeopleFilter = sessionType === 'festival' ? 'all' : 'regulars';
    const currentUserId = {{ current_user.person_id if current_user.is_authenticated else 'null' }};

    function initializePeopleTab() {
        // Add click listener to people tab button
        const peopleTabButton = document.querySelector('.tab-button[data-tab="people"]');
        if (peopleTabButton) {
            peopleTabButton.addEventListener('click', function() {
                // Load people data if not already loaded
                if (peopleData.length === 0) {
                    fetchPeople();
                }
            });
        }

        // Add search box listener
        const searchBox = document.getElementById('people-search-box');
        if (searchBox) {
            searchBox.addEventListener('input', function() {
                renderPeople();
            });
        }

        // Check if people tab is already active on page load (e.g., from querystring)
        const peopleTab = document.getElementById('people-tab');
        if (peopleTab && peopleTab.classList.contains('active')) {
            // Tab is already active, fetch data immediately
            fetchPeople();
        }
    }

    function togglePeopleFilter() {
        // Toggle between 'regulars' and 'all'
        currentPeopleFilter = currentPeopleFilter === 'regulars' ? 'all' : 'regulars';

        // Update button text
        const filterBtn = document.getElementById('people-filter-btn');
        if (filterBtn) {
            filterBtn.textContent = currentPeopleFilter === 'regulars' ? 'Regulars' : 'All';
        }

        renderPeople();
    }

    let searchTimeout = null;

    function openAddPersonModal() {
        // Open search modal first
        const modal = document.getElementById('search-person-modal');
        if (!modal) return;

        // Clear search input and results
        const searchInput = document.getElementById('search-person-input');
        if (searchInput) {
            searchInput.value = '';
        }

        const resultsContainer = document.getElementById('search-results-container');
        if (resultsContainer) {
            resultsContainer.innerHTML = '<div class="search-no-results">Type to search for existing people</div>';
        }

        modal.style.display = 'flex';
        setTimeout(() => {
            modal.classList.add('show');
            if (searchInput) {
                searchInput.focus();
            }
        }, 10);

        // Set up search input listeners
        if (searchInput && !searchInput.dataset.listenerAttached) {
            searchInput.dataset.listenerAttached = 'true';

            // Search on Enter key
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    performPersonSearch();
                }
            });

            // Search on input with 1 second debounce
            searchInput.addEventListener('input', () => {
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }
                searchTimeout = setTimeout(() => {
                    performPersonSearch();
                }, 1000);
            });
        }
    }

    function closeSearchPersonModal() {
        const modal = document.getElementById('search-person-modal');
        if (!modal) return;

        modal.classList.remove('show');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }

    function openCreatePersonModal() {
        // Close search modal and open create modal
        closeSearchPersonModal();

        setTimeout(() => {
            const modal = document.getElementById('add-person-modal');
            if (!modal) return;

            // Clear form
            document.getElementById('add-person-first-name').value = '';
            document.getElementById('add-person-last-name').value = '';
            document.getElementById('add-person-thesession').value = '';
            document.querySelectorAll('#add-person-instruments input[type="checkbox"]').forEach(cb => cb.checked = false);

            // Clear is-regular checkbox if it exists (non-festival mode)
            const isRegularCheckbox = document.getElementById('add-person-is-regular');
            if (isRegularCheckbox) {
                isRegularCheckbox.checked = false;
            }

            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
        }, 350);
    }

    function performPersonSearch() {
        const searchInput = document.getElementById('search-person-input');
        const resultsContainer = document.getElementById('search-results-container');

        if (!searchInput || !resultsContainer) return;

        const query = searchInput.value.trim();

        if (query.length === 0) {
            resultsContainer.innerHTML = '<div class="search-no-results">Type to search for existing people</div>';
            return;
        }

        if (query.length < 2) {
            resultsContainer.innerHTML = '<div class="search-no-results">Type at least 2 characters to search</div>';
            return;
        }

        // Show loading state
        resultsContainer.innerHTML = '<div class="search-no-results">Searching...</div>';

        // Call API to search people
        fetch(`/api/sessions/${sessionPath}/people/search?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displaySearchResults(data.people);
                } else {
                    resultsContainer.innerHTML = `<div class="search-no-results">Error: ${data.message}</div>`;
                }
            })
            .catch(error => {
                console.error('Search error:', error);
                resultsContainer.innerHTML = '<div class="search-no-results">Error searching people</div>';
            });
    }

    function displaySearchResults(people) {
        const resultsContainer = document.getElementById('search-results-container');
        if (!resultsContainer) return;

        if (people.length === 0) {
            resultsContainer.innerHTML = '<div class="search-no-results">No matching people found</div>';
            return;
        }

        resultsContainer.innerHTML = people.map(person => {
            const locationParts = [];
            if (person.city) locationParts.push(person.city);
            if (person.state) locationParts.push(person.state);
            if (person.country) locationParts.push(person.country);
            const location = locationParts.length > 0 ? locationParts.join(', ') : '';

            const instruments = person.instruments && person.instruments.length > 0
                ? person.instruments.join(', ')
                : '';

            return `
                <div class="search-result-row" data-person-id="${person.person_id}" onclick="addExistingPersonToSession(${person.person_id}, '${escapeHtml(person.first_name)}', '${escapeHtml(person.last_name)}')">
                    <div class="search-result-content">
                        <div class="search-result-name">${escapeHtml(person.first_name)} ${escapeHtml(person.last_name)}</div>
                        ${location ? `<div class="search-result-details">${escapeHtml(location)}</div>` : ''}
                        ${instruments ? `<div class="search-result-instruments">${escapeHtml(instruments)}</div>` : ''}
                    </div>
                </div>
            `;
        }).join('');
    }

    function addExistingPersonToSession(personId, firstName, lastName) {
        // Find the clicked row
        const row = document.querySelector(`.search-result-row[data-person-id="${personId}"]`);

        // Add spinner to row
        if (row && !row.querySelector('.search-result-spinner')) {
            const spinner = document.createElement('div');
            spinner.className = 'search-result-spinner';
            row.appendChild(spinner);
        }

        // Determine is_regular value
        let isRegular = sessionType === 'festival' ? true : false;

        // Call API to add existing person to session
        fetch(`/api/sessions/${sessionPath}/people/add-existing`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                person_id: personId,
                is_regular: isRegular
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                // Close search modal (spinner will be removed when modal is destroyed)
                closeSearchPersonModal();

                // Reload people data
                peopleData = [];
                fetchPeople();
            } else {
                // Remove spinner on error
                if (row) {
                    const spinner = row.querySelector('.search-result-spinner');
                    if (spinner) spinner.remove();
                }
                alert('Failed to add person: ' + (result.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error adding person:', error);
            // Remove spinner on error
            if (row) {
                const spinner = row.querySelector('.search-result-spinner');
                if (spinner) spinner.remove();
            }
            alert('Error adding person');
        });
    }

    function closeAddPersonModal() {
        const modal = document.getElementById('add-person-modal');
        if (!modal) return;

        modal.classList.remove('show');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }

    function parseTheSessionId(input) {
        if (!input || input.trim() === '') return null;

        input = input.trim();

        // If it's just a number, return it
        if (/^\d+$/.test(input)) {
            return parseInt(input);
        }

        // Try to extract from URL
        const urlMatch = input.match(/thesession\.org\/members\/(\d+)/);
        if (urlMatch) {
            return parseInt(urlMatch[1]);
        }

        return null;
    }

    function saveNewPerson() {
        const firstName = document.getElementById('add-person-first-name').value.trim();
        const lastName = document.getElementById('add-person-last-name').value.trim();
        const thesessionInput = document.getElementById('add-person-thesession').value.trim();

        // Validate required fields
        if (!firstName || !lastName) {
            alert('First name and last name are required');
            return;
        }

        // Get selected instruments
        const instruments = [];
        document.querySelectorAll('#add-person-instruments input[type="checkbox"]:checked').forEach(cb => {
            instruments.push(cb.value);
        });

        // Parse TheSession.org ID
        const thesessionId = parseTheSessionId(thesessionInput);

        // Determine is_regular value
        let isRegular;
        if (sessionType === 'festival') {
            // In festival mode, always set as regular
            isRegular = true;
        } else {
            // In non-festival mode, use checkbox value
            const isRegularCheckbox = document.getElementById('add-person-is-regular');
            isRegular = isRegularCheckbox ? isRegularCheckbox.checked : false;
        }

        // Disable save button
        const saveBtn = document.querySelector('.add-person-btn-save');
        if (saveBtn) {
            saveBtn.disabled = true;
            saveBtn.textContent = 'Adding...';
        }

        // Prepare request data
        const data = {
            first_name: firstName,
            last_name: lastName,
            instruments: instruments,
            thesession_user_id: thesessionId,
            is_regular: isRegular
        };

        // Call API to add person
        fetch(`/api/sessions/${sessionPath}/people/add`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                // Close modal
                closeAddPersonModal();

                // Reload people data
                peopleData = [];
                fetchPeople();
            } else {
                alert('Failed to add person: ' + (result.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error adding person:', error);
            alert('Error adding person');
        })
        .finally(() => {
            // Re-enable save button
            if (saveBtn) {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Add Person';
            }
        });
    }

    function fetchPeople() {
        const peopleList = document.getElementById('people-list');
        if (!peopleList) return;

        fetch(`/api/sessions/${sessionPath}/people`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    peopleData = data.people;
                    renderPeople();
                } else {
                    peopleList.innerHTML = `
                        <div style="padding: 40px 20px; text-align: center; color: var(--text-muted, #6c757d);">
                            <p>Failed to load people: ${data.message || 'Unknown error'}</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error loading people:', error);
                peopleList.innerHTML = `
                    <div style="padding: 40px 20px; text-align: center; color: var(--text-muted, #6c757d);">
                        <p>Error loading people</p>
                    </div>
                `;
            });
    }

    function renderPeople() {
        const peopleList = document.getElementById('people-list');
        if (!peopleList) return;

        // Get search query
        const searchBox = document.getElementById('people-search-box');
        const searchQuery = searchBox ? searchBox.value.toLowerCase().trim() : '';

        // Filter people
        let filteredPeople = peopleData;

        // Filter by regulars/all
        if (currentPeopleFilter === 'regulars') {
            filteredPeople = filteredPeople.filter(person => person.is_regular);
        }

        // Filter by search query
        if (searchQuery) {
            filteredPeople = filteredPeople.filter(person => {
                const fullName = `${person.first_name} ${person.last_name}`.toLowerCase();
                const instruments = person.instruments ? person.instruments.join(' ').toLowerCase() : '';
                return fullName.includes(searchQuery) || instruments.includes(searchQuery);
            });
        }

        if (filteredPeople.length === 0) {
            const message = searchQuery
                ? 'No people found matching your search'
                : (currentPeopleFilter === 'regulars' ? 'No regulars in this session yet' : 'No people in this session yet');
            peopleList.innerHTML = `
                <div style="padding: 40px 20px; text-align: center; color: var(--text-muted, #6c757d);">
                    <p>${message}</p>
                </div>
            `;
            return;
        }

        peopleList.innerHTML = filteredPeople.map(person => createPersonRow(person)).join('');
    }

    function createPersonRow(person) {
        const displayName = `${person.first_name} ${person.last_name}`;
        const iconClass = person.has_user_account ? 'has-account' : 'no-account';
        const instrumentsText = person.instruments && person.instruments.length > 0
            ? person.instruments.join(', ')
            : 'No instruments listed';
        const attendanceCount = person.attendance_count || 0;

        return `
            <div class="person-row" onclick="showPersonDetail(${person.person_id})">
                <div class="person-icon ${iconClass}">
                    <i class="fa fa-user-circle"></i>
                </div>
                <div class="person-info">
                    <div class="person-name">${escapeHtml(displayName)}</div>
                    <div class="person-instruments">${escapeHtml(instrumentsText)}</div>
                </div>
                <div class="person-meta">
                    <span class="person-attendance-badge">${attendanceCount}</span>
                </div>
            </div>
        `;
    }

    function showPersonDetail(personId) {
        const modal = document.getElementById('person-detail-modal');
        const modalContent = document.getElementById('person-detail-content');

        if (!modal || !modalContent) return;

        // Show modal immediately with loading state
        modalContent.innerHTML = `
            <button class="modal-close-btn" onclick="closePersonDetailModal()" title="Close">&times;</button>
            <div style="padding: 40px 20px; text-align: center;">
                <i class="loading-dots">Loading...</i>
            </div>
        `;
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('show'), 10);
        personModalShowTime = Date.now();

        // Fetch person details
        fetch(`/api/sessions/${sessionPath}/people/${personId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayPersonDetail(data.person);
                } else {
                    modalContent.innerHTML = `
                        <button class="modal-close-btn" onclick="closePersonDetailModal()" title="Close">&times;</button>
                        <div style="padding: 40px 20px; text-align: center; color: var(--text-muted);">
                            <p>Failed to load person details</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error loading person details:', error);
                modalContent.innerHTML = `
                    <button class="modal-close-btn" onclick="closePersonDetailModal()" title="Close">&times;</button>
                    <div style="padding: 40px 20px; text-align: center; color: var(--text-muted);">
                        <p>Error loading person details</p>
                    </div>
                `;
            });
    }

    function displayPersonDetail(person) {
        const modalContent = document.getElementById('person-detail-content');
        if (!modalContent) return;

        const displayName = `${person.first_name} ${person.last_name}`;

        // Build location string (combine intelligently)
        const locationParts = [];
        if (person.city) locationParts.push(person.city);
        if (person.state) locationParts.push(person.state);
        if (person.country) locationParts.push(person.country);
        const locationString = locationParts.length > 0 ? locationParts.join(', ') : 'No location specified';

        // Build TheSession.org link
        const thesessionLink = person.thesession_user_id
            ? `<a href="https://thesession.org/members/${person.thesession_user_id}" target="_blank" class="person-detail-link">View on TheSession.org</a>`
            : '<span style="color: var(--text-muted);">Not linked</span>';

        // Build instruments list
        const instrumentsHtml = person.instruments && person.instruments.length > 0
            ? `<div class="person-instruments-list">${person.instruments.map(inst =>
                `<span class="person-instrument-badge">${escapeHtml(inst)}</span>`
              ).join('')}</div>`
            : '<span style="color: var(--text-muted);">No instruments listed</span>';

        // Build "View my profile" link if it's the current user
        const profileLink = person.person_id === currentUserId
            ? '<div style="margin-bottom: 16px;"><a href="/me" class="person-detail-link">View my profile</a></div>'
            : '';

        // Build "Common Tunes?" link if viewing another user with an account
        const commonTunesLink = person.has_user_account && person.person_id !== currentUserId
            ? '<div style="margin-bottom: 16px;"><a href="/me/and/' + person.person_id + '" class="person-detail-link">Common Tunes?</a></div>'
            : '';

        // Build attendance table
        const attendanceTableHtml = person.attended_instances && person.attended_instances.length > 0
            ? `
                <table class="attendance-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${person.attended_instances.map(instance => `
                            <tr>
                                <td>
                                    <a href="/sessions/${sessionPath}/${instance.date}" class="person-detail-link">
                                        ${instance.date}
                                    </a>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `
            : '<p style="color: var(--text-muted); margin-top: 12px;">No sessions attended yet</p>';

        modalContent.innerHTML = `
            <button class="modal-close-btn" onclick="closePersonDetailModal()" title="Close">&times;</button>
            <h2 class="person-detail-title">${escapeHtml(displayName)}</h2>
            ${profileLink}
            ${commonTunesLink}
            <div class="person-detail-location">${escapeHtml(locationString)}</div>
            <div class="person-detail-section">
                <h3>TheSession.org</h3>
                ${thesessionLink}
            </div>
            <div class="person-detail-section">
                <h3>Instruments</h3>
                ${instrumentsHtml}
            </div>
            <div class="person-detail-section">
                <h3>Sessions Attended</h3>
                ${attendanceTableHtml}
            </div>
        `;
    }

    function closePersonDetailModal() {
        const modal = document.getElementById('person-detail-modal');
        if (!modal) return;

        modal.classList.remove('show');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }

    // Close modals on escape key
    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
            // Check if add person modal is open first
            const addPersonModal = document.getElementById('add-person-modal');
            if (addPersonModal && addPersonModal.style.display === 'flex') {
                closeAddPersonModal();
                return;
            }

            // Check if search person modal is open
            const searchPersonModal = document.getElementById('search-person-modal');
            if (searchPersonModal && searchPersonModal.style.display === 'flex') {
                closeSearchPersonModal();
                return;
            }

            // Check if person detail modal is open
            const personModal = document.getElementById('person-detail-modal');
            if (personModal && personModal.style.display === 'flex') {
                closePersonDetailModal();
                return;
            }
        }
    });

    // Close modals when clicking outside
    const personModal = document.getElementById('person-detail-modal');
    if (personModal) {
        personModal.addEventListener('click', function(event) {
            const timeSinceShown = Date.now() - personModalShowTime;
            if (timeSinceShown < 500) return;

            if (event.target === event.currentTarget && event.target.classList.contains('modal-overlay')) {
                closePersonDetailModal();
            }
        });
    }

    const addPersonModal = document.getElementById('add-person-modal');
    if (addPersonModal) {
        addPersonModal.addEventListener('click', function(event) {
            if (event.target === event.currentTarget && event.target.classList.contains('modal-overlay')) {
                closeAddPersonModal();
            }
        });
    }

    const searchPersonModal = document.getElementById('search-person-modal');
    if (searchPersonModal) {
        searchPersonModal.addEventListener('click', function(event) {
            if (event.target === event.currentTarget && event.target.classList.contains('modal-overlay')) {
                closeSearchPersonModal();
            }
        });
    }
</script>
{% endblock %}