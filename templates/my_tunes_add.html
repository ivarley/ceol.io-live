{% extends "base.html" %}
{% from 'components/tune_search_input.html' import tune_search_input %}

{% block title %}Add Tune - My Tunes{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/my_tunes_mobile.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/tune-search.css') }}">
<style>
    .add-tune-container {
        max-width: 600px;
        margin: 40px auto;
        padding: 20px;
    }

    .page-header {
        margin-bottom: 5px;
    }

    .page-header h1 {
        margin-bottom: 10px;
    }

    .back-link {
        color: var(--primary);
        text-decoration: none;
        font-size: 14px;
        display: inline-block;
        margin-bottom: 20px;
    }

    .back-link:hover {
        text-decoration: underline;
    }

    .form-container {
        background-color: var(--bg-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 30px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--text-color);
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 14px;
        background-color: var(--bg-color);
        color: var(--text-color);
        box-sizing: border-box;
    }

    .form-group textarea {
        resize: vertical;
        min-height: 80px;
    }

    .form-group .help-text {
        font-size: 13px;
        color: var(--text-muted, #6c757d);
        margin-top: 5px;
    }

    .form-actions {
        display: flex;
        gap: 10px;
        margin-top: 30px;
    }

    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        text-align: center;
        transition: all 0.2s;
    }

    .btn-primary {
        background-color: var(--primary);
        color: white;
    }

    .btn-primary:hover:not(:disabled) {
        background-color: var(--primary-dark, #0056b3);
    }

    .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-secondary {
        background-color: var(--secondary, #6c757d);
        color: white;
    }

    .btn-secondary:hover {
        background-color: var(--secondary-dark, #5a6268);
        text-decoration: none;
        color: white;
    }

    .error-message {
        background-color: #f8d7da;
        color: #721c24;
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 20px;
        border: 1px solid #f5c6cb;
    }

    .success-message {
        background-color: #d4edda;
        color: #155724;
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 20px;
        border: 1px solid #c3e6cb;
    }

    /* Mobile optimizations */
    @media (max-width: 768px) {
        .add-tune-container {
            padding: 15px;
            margin: 20px auto;
        }

        .form-container {
            padding: 20px;
        }

        .form-actions {
            flex-direction: column;
        }

        .btn {
            width: 100%;
        }
    }

    /* Dark mode adjustments */
    [data-theme="dark"] .error-message {
        background-color: #5a1f1f;
        color: #f8d7da;
        border-color: #721c24;
    }

    [data-theme="dark"] .success-message {
        background-color: #1f4a2f;
        color: #d4edda;
        border-color: #155724;
    }
</style>
{% endblock %}

{% block content %}
<div class="add-tune-container">
    <a href="/my-tunes" class="back-link">‚Üê Back to My Tunes</a>
    
    <div class="page-header">
        <h1>Add Tune to Collection</h1>
        <p>Search for a tune from our database to add to your personal collection</p>
    </div>

    <div id="message-container"></div>

    <div class="form-container">
        <form id="add-tune-form">
            {{ tune_search_input(
                placeholder="Start typing a tune name...",
                help_text="Type to search for tunes in our database. Select a tune from the dropdown to add it.",
                label="Search for Tune",
                required=True
            ) }}

            <div class="form-group">
                <label for="learn-status">Initial Learning Status</label>
                <select id="learn-status" name="learn_status">
                    <option value="want to learn" selected>Want to Learn</option>
                    <option value="learning">Learning</option>
                    <option value="learned">Learned</option>
                </select>
                <div class="help-text">
                    Choose the initial status for this tune in your collection
                </div>
            </div>

            <div class="form-group">
                <label for="setting-id">Setting (Optional)</label>
                <input
                    type="text"
                    id="setting-id"
                    name="setting_id"
                    placeholder="e.g., 123 or paste URL"
                >
                <div class="help-text">
                    If you play a specific setting of the tune, enter the URL or setting ID here
                </div>
                <div id="setting-id-error" class="error-message" style="display: none; margin-top: 5px;"></div>
            </div>

            <div class="form-group">
                <label for="notes">Notes (Optional)</label>
                <textarea
                    id="notes"
                    name="notes"
                    placeholder="Add any notes about this tune..."
                ></textarea>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary" id="submit-btn" disabled>
                    Add to My Tunes
                </button>
                <a href="/my-tunes" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>

<script>
// Helper functions for API calls
function fetchWithRetry(url, options = {}) {
    return fetch(url, options);
}

function handleApiError(error, response = null) {
    if (response) {
        if (response.status === 401) {
            return { message: 'Please log in again', action: () => window.location.href = '/login' };
        }
        if (response.status === 404) {
            return { message: 'Not found', retryable: false };
        }
        if (response.status >= 500) {
            return { message: 'Server error. Please try again.', retryable: true };
        }
        return { message: 'An error occurred. Please try again.', retryable: true };
    }
    return { message: error?.message || 'An error occurred', retryable: true };
}

// Note: There are TWO showLoading functions in this file
// 1. This full-page overlay version (used during form submission)
// 2. The autocomplete-specific version below (line ~456, used during search)
function showLoading(message = 'Loading...') {
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'loading-overlay';

    // Check if dark mode is active
    const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
    const bgColor = isDarkMode ? 'rgba(30, 30, 30, 0.95)' : 'rgba(255, 255, 255, 0.95)';
    const textColor = isDarkMode ? '#e0e0e0' : '#333';
    const spinnerBorderColor = isDarkMode ? '#444' : '#ddd';

    loadingDiv.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: ${bgColor}; z-index: 9999;
        display: flex; align-items: center; justify-content: center;
        flex-direction: column; gap: 15px;
    `;
    loadingDiv.innerHTML = `
        <div style="width: 40px; height: 40px; border: 4px solid ${spinnerBorderColor};
                    border-top-color: #007bff; border-radius: 50%;
                    animation: spin 0.8s linear infinite;"></div>
        <div style="color: ${textColor}; font-size: 16px;">${message}</div>
    `;
    const style = document.createElement('style');
    style.textContent = '@keyframes spin { to { transform: rotate(360deg); } }';
    document.head.appendChild(style);
    document.body.appendChild(loadingDiv);
    return {
        hide: () => {
            if (loadingDiv.parentNode) loadingDiv.parentNode.removeChild(loadingDiv);
            if (style.parentNode) style.parentNode.removeChild(style);
        }
    };
}

// Extract setting ID from thesession.org URL or plain number
// Handles formats:
// - Plain number: 123
// - Query param: ?setting=123 or &setting=123
// - Hash anchor: #setting123
// - Combined: ?setting=123#setting123
function extractSettingId(input) {
    if (!input || input.trim() === '') {
        return null;
    }

    const trimmed = input.trim();

    // If it's already just a number, return it
    if (/^\d+$/.test(trimmed)) {
        return parseInt(trimmed);
    }

    // Try to extract from URL query param format first: ?setting=123 or &setting=123
    // This is the authoritative source if present
    const queryMatch = trimmed.match(/[?&]setting=(\d+)/);
    if (queryMatch) {
        return parseInt(queryMatch[1]);
    }

    // Fall back to hash format: #setting123
    const hashMatch = trimmed.match(/#setting(\d+)/);
    if (hashMatch) {
        return parseInt(hashMatch[1]);
    }

    // Couldn't parse - return null
    return null;
}

// Validate that input is either empty, a number, or a valid thesession.org URL
function validateSettingId(input) {
    if (!input || input.trim() === '') {
        return { valid: true, settingId: null };
    }

    const trimmed = input.trim();

    // Check if it's just a number
    if (/^\d+$/.test(trimmed)) {
        return { valid: true, settingId: parseInt(trimmed) };
    }

    // Check if it's a valid thesession.org URL
    if (trimmed.includes('thesession.org')) {
        const settingId = extractSettingId(trimmed);
        if (settingId !== null) {
            return { valid: true, settingId: settingId };
        }
    }

    // Invalid input
    return { valid: false, settingId: null, error: 'Please enter a number or paste a valid TheSession.org URL' };
}

// Handle setting ID input with instant parsing and validation
function onSettingIdInput() {
    const input = document.getElementById('setting-id');
    const errorDiv = document.getElementById('setting-id-error');

    if (!input || !errorDiv) return;

    const value = input.value;
    const validation = validateSettingId(value);

    if (!validation.valid) {
        // Show error
        errorDiv.textContent = validation.error;
        errorDiv.style.display = 'block';
        input.style.borderColor = '#dc3545';
    } else {
        // Clear error
        errorDiv.style.display = 'none';
        input.style.borderColor = '';

        // If we extracted a setting ID from a URL, replace the input with just the number
        if (validation.settingId !== null && value !== validation.settingId.toString()) {
            input.value = validation.settingId.toString();
        }
    }
}

// DOM elements
const submitBtn = document.getElementById('submit-btn');
const addTuneForm = document.getElementById('add-tune-form');
const settingIdInput = document.getElementById('setting-id');

// Initialize tune search component
let tuneSearch;
document.addEventListener('DOMContentLoaded', function() {
    tuneSearch = new TuneSearchComponent({
        searchInputId: 'tune-search',
        autocompleteResultsId: 'autocomplete-results',
        hiddenInputId: 'selected-tune-id',
        noResultsMessage: 'No tunes found from existing sessions',
        tunebookCountStyle: 'text', // Show "X tunebooks" format
        onTuneSelected: (tune) => {
            // Enable submit button when tune is selected
            submitBtn.disabled = false;
        }
    });

    // Check for query parameter and extract setting ID if present
    const params = new URLSearchParams(window.location.search);
    if (params.has('q')) {
        const query = params.get('q').trim();
        if (query) {
            // Check if the query contains a setting ID (URL format)
            const settingId = extractSettingId(query);
            if (settingId && settingIdInput) {
                settingIdInput.value = settingId.toString();
            }
        }
    }
});

// Setup form event listeners
addTuneForm.addEventListener('submit', handleSubmit);
if (settingIdInput) {
    settingIdInput.addEventListener('input', onSettingIdInput);
}

function handleSubmit(e) {
    e.preventDefault();

    const selectedTuneId = tuneSearch.getSelectedTuneId();
    if (!selectedTuneId) {
        showMessage('Please select a tune from the search results', 'error');
        return;
    }

    // Check if offline
    if (!navigator.onLine) {
        showMessage('You are offline. Please check your connection.', 'error');
        return;
    }

    // Validate setting ID before proceeding
    const settingIdValue = document.getElementById('setting-id').value;
    const settingIdValidation = validateSettingId(settingIdValue);
    if (!settingIdValidation.valid) {
        showMessage(settingIdValidation.error, 'error');
        return;
    }

    const formData = {
        tune_id: selectedTuneId,
        learn_status: document.getElementById('learn-status').value,
        notes: document.getElementById('notes').value.trim() || null,
        setting_id: settingIdValidation.settingId
    };

    // If this is a tune from TheSession.org, include the tune details for insertion
    const theSessionTune = tuneSearch.getTheSessionTuneData();
    if (theSessionTune) {
        formData.new_tune = {
            tune_id: theSessionTune.tune_id,
            name: theSessionTune.name,
            tune_type: theSessionTune.tune_type,
            tunebook_count: theSessionTune.tunebook_count
        };
    }

    // Disable submit button
    submitBtn.disabled = true;
    submitBtn.textContent = 'Adding...';

    const loading = showLoading('Adding tune to your collection...');

    fetchWithRetry('/api/my-tunes', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                const errorInfo = handleApiError(null, response);
                throw new Error(data.error || errorInfo.message);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Redirect immediately without hiding loading overlay
            window.location.href = '/my-tunes?added=' + encodeURIComponent(tuneSearch.getValue());
        } else {
            loading.hide();
            throw new Error(data.error || 'Failed to add tune');
        }
    })
    .catch(error => {
        loading.hide();
        console.error('Error adding tune:', error);
        const errorInfo = handleApiError(error);
        showMessage(errorInfo.message, 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Add to My Tunes';
    });
}

function showMessage(message, type) {
    const container = document.getElementById('message-container');
    const className = type === 'error' ? 'error-message' : 'success-message';
    container.innerHTML = `<div class="${className}">${escapeHtml(message)}</div>`;
    container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function showError(message) {
    showMessage(message, 'error');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
<script src="{{ url_for('static', filename='js/components/TuneSearchComponent.js') }}"></script>
<script src="{{ url_for('static', filename='js/my_tunes_mobile.js') }}"></script>
{% endblock %}
