{% extends "base.html" %}

{% block extra_css %}
<style>
    .sessions-controls {
        margin-bottom: 1.5rem;
    }

    .search-and-toggle {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1rem;
        align-items: stretch;
    }

    .search-bar {
        flex: 1;
        padding: 0.75rem;
        font-size: 1.125rem;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background-color: var(--input-bg);
        color: var(--text-color);
    }

    .filter-toggle-button {
        padding: 0.75rem 1.5rem;
        border: 1px solid var(--border-color);
        background-color: var(--primary-color);
        color: white;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
        font-weight: 500;
    }

    .filter-toggle-button:hover {
        opacity: 0.9;
    }

    .session-count {
        margin-bottom: 1rem;
        color: var(--secondary-text);
    }

    .sessions-grid {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1.5rem;
    }

    .sessions-grid thead {
        background-color: var(--table-header-bg);
        border-bottom: 2px solid var(--border-color);
    }

    .sessions-grid th {
        padding: 0.75rem;
        text-align: left;
        font-weight: 600;
    }

    .sessions-grid tbody tr {
        border-bottom: 1px solid var(--border-color);
        transition: background-color 0.2s;
    }

    .sessions-grid tbody tr:hover {
        background-color: var(--hover-bg);
    }

    .sessions-grid td {
        padding: 0.75rem;
    }

    .sessions-grid a {
        color: var(--link-color);
        text-decoration: none;
    }

    .sessions-grid a:hover {
        text-decoration: underline;
    }

    .no-sessions {
        padding: 2rem;
        text-align: center;
        color: var(--secondary-text);
    }

    .today-action-btn {
        padding: 0.4rem 0.8rem;
        font-size: 0.85rem;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
        white-space: nowrap;
    }

    .btn-goto-today {
        background-color: #28a745;
        color: white;
    }

    .btn-goto-today:hover {
        background-color: #218838;
    }

    select.today-action-btn {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        padding-right: 24px;
        background-image: none;
        cursor: pointer;
    }

    .action-cell {
        text-align: right;
        white-space: nowrap;
    }

    .loading-message {
        padding: 2rem;
        text-align: center;
        color: var(--text-color);
        font-size: 1.1rem;
    }

    .loading-dots {
        font-weight: bold;
        animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
        0%, 100% {
            opacity: 0.3;
        }
        50% {
            opacity: 1;
        }
    }

    /* Mobile responsive fixes */
    @media (max-width: 576px) {
        .search-bar {
            min-width: 0;
            flex-shrink: 1;
        }

        .filter-toggle-button {
            flex-shrink: 0;
            padding: 0.75rem 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="landing-page" style="display: block;">

    <h1>Sessions</h1>

    <div class="sessions-controls">
        <div class="search-and-toggle">
            <input type="text" id="search-bar" class="search-bar" placeholder="Search by name or location...">
            <button class="filter-toggle-button" id="filter-toggle-button">
                {% if is_logged_in %}My Sessions{% else %}All Active{% endif %}
            </button>
        </div>

        <div class="session-count" id="session-count">Showing <span id="count-number">0</span> <span id="count-filter-type">active</span>.</div>
    </div>

    <div id="loading-message" class="loading-message">
        Loading<span class="loading-dots">...</span>
    </div>

    <table class="sessions-grid" id="sessions-table" style="display: none;">
        <thead>
            <tr>
                <th>Name</th>
                <th>Location</th>
                <th></th>
            </tr>
        </thead>
        <tbody id="sessions-tbody">
            <!-- Sessions will be populated by JavaScript -->
        </tbody>
    </table>
    <div id="no-results" class="no-sessions" style="display: none;">No sessions found.</div>

    <p style="font-size: 0.85rem; color: var(--secondary-text);">Don't see your session? <a href="/add-session">Add it!</a></p>

    <p><a href="/">← Back to home</a></p>
{% endblock %}

{% block extra_js %}
<script>
    let allSessions = [];
    let todayStr = '';
    const isLoggedIn = {{ 'true' if is_logged_in else 'false' }};

    // Define filter states based on login status
    const filterStates = isLoggedIn
        ? ['my', 'active', 'all', 'inactive']
        : ['active', 'all', 'inactive'];

    let currentFilterIndex = 0;
    let currentFilter = filterStates[currentFilterIndex];
    let searchTerm = '';

    const filterButtonLabels = {
        'my': 'My Sessions',
        'active': 'All Active',
        'all': 'All',
        'inactive': 'Inactive'
    };

    // Normalize smart quotes to straight quotes (for iOS keyboard compatibility)
    function normalizeQuotes(str) {
        return str
            .replace(/[\u2018\u2019]/g, "'")  // Smart single quotes → straight
            .replace(/[\u201C\u201D]/g, '"'); // Smart double quotes → straight
    }

    document.addEventListener('DOMContentLoaded', function() {
        loadSessionData();
        setupEventListeners();
    });

    async function loadSessionData() {
        try {
            const response = await fetch('/api/sessions/with-today-status');
            const data = await response.json();

            if (data.success) {
                allSessions = data.sessions;
                todayStr = data.today;

                // If user is logged in but has no sessions, default to "All Active" instead of "My Sessions"
                if (isLoggedIn && currentFilter === 'my') {
                    const userHasSessions = allSessions.some(s => s.user_is_member);
                    if (!userHasSessions) {
                        currentFilterIndex = 1; // 'active' is at index 1 for logged-in users
                        currentFilter = 'active';
                        document.getElementById('filter-toggle-button').textContent = filterButtonLabels[currentFilter];
                    }
                }

                // Hide loading message
                document.getElementById('loading-message').style.display = 'none';

                updateDisplay();
            } else {
                console.error('Failed to load sessions:', data.error);
                document.getElementById('loading-message').textContent = 'Error loading sessions';
            }
        } catch (error) {
            console.error('Error loading sessions:', error);
            document.getElementById('loading-message').textContent = 'Error loading sessions';
        }
    }

    function setupEventListeners() {
        // Toggle button - cycles through filter states
        document.getElementById('filter-toggle-button').addEventListener('click', function() {
            currentFilterIndex = (currentFilterIndex + 1) % filterStates.length;
            currentFilter = filterStates[currentFilterIndex];
            this.textContent = filterButtonLabels[currentFilter];
            updateDisplay();
        });

        // Search bar
        document.getElementById('search-bar').addEventListener('input', function(e) {
            searchTerm = normalizeQuotes(e.target.value.toLowerCase());
            updateDisplay();
        });
    }

    function filterSessions() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        return allSessions.filter(session => {
            // Apply status filter
            let passesStatusFilter = false;
            if (currentFilter === 'my') {
                passesStatusFilter = session.user_is_member;
            } else if (currentFilter === 'active') {
                if (!session.termination_date) {
                    passesStatusFilter = true;
                } else {
                    const terminationDate = new Date(session.termination_date);
                    passesStatusFilter = terminationDate > today;
                }
            } else if (currentFilter === 'all') {
                passesStatusFilter = true;
            } else if (currentFilter === 'inactive') {
                if (session.termination_date) {
                    const terminationDate = new Date(session.termination_date);
                    passesStatusFilter = terminationDate <= today;
                } else {
                    passesStatusFilter = false;
                }
            }

            if (!passesStatusFilter) return false;

            // Apply search filter
            if (searchTerm) {
                const location = [session.city, session.state, session.country]
                    .filter(x => x)
                    .join(', ')
                    .toLowerCase();
                const nameMatch = session.name.toLowerCase().includes(searchTerm);
                const locationMatch = location.includes(searchTerm);
                return nameMatch || locationMatch;
            }

            return true;
        });
    }

    function formatTimeRange(startTime, endTime) {
        if (!startTime) return '';

        function formatTime(timeStr) {
            if (!timeStr) return '';
            const parts = timeStr.split(':');
            let hour = parseInt(parts[0]);
            const minute = parts[1];
            const period = hour >= 12 ? 'pm' : 'am';
            hour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
            return `${hour}:${minute}${period}`;
        }

        const start = formatTime(startTime);
        if (endTime) {
            const end = formatTime(endTime);
            return `${start}-${end}`;
        }
        return start + ' - ?';
    }

    function updateDisplay() {
        const filteredSessions = filterSessions();
        const tbody = document.getElementById('sessions-tbody');
        const noResults = document.getElementById('no-results');
        const table = document.getElementById('sessions-table');

        // Update count
        const countNumber = document.getElementById('count-number');
        const countFilterType = document.getElementById('count-filter-type');
        countNumber.textContent = filteredSessions.length;

        const filterLabels = {
            'my': 'sessions in your list',
            'active': 'active sessions',
            'all': 'sessions',
            'inactive': 'inactive sessions'
        };
        countFilterType.textContent = filterLabels[currentFilter] || 'sessions';

        // Clear tbody
        tbody.innerHTML = '';

        if (filteredSessions.length === 0) {
            table.style.display = 'none';
            noResults.style.display = 'block';
        } else {
            table.style.display = 'table';
            noResults.style.display = 'none';

            filteredSessions.forEach(session => {
                const row = document.createElement('tr');

                const location = [session.city, session.state, session.country]
                    .filter(x => x)
                    .join(', ') || 'Unknown';

                // Determine what action to show
                let actionHTML = '';
                if (session.active_instances && session.active_instances.length > 0) {
                    // Has active instances - show "On Now" button
                    if (session.active_instances.length === 1) {
                        // Single active instance - jump directly to it
                        const instance = session.active_instances[0];
                        actionHTML = `<button class="today-action-btn btn-goto-today" onclick="window.location.href='/sessions/${session.path}/${instance.date}'">On Now</button>`;
                    } else {
                        // Multiple active instances - show dropdown
                        const dropdownId = `dropdown-${session.session_id}`;
                        let optionsHTML = '';
                        session.active_instances.forEach(instance => {
                            const timeStr = formatTimeRange(instance.start_time, instance.end_time);
                            const locationStr = instance.location_override || session.location_name || '';
                            const displayText = [timeStr, locationStr].filter(x => x).join(' @ ');
                            optionsHTML += `<option value="${instance.date}">${displayText}</option>`;
                        });
                        actionHTML = `
                            <select class="today-action-btn btn-goto-today" id="${dropdownId}" onchange="if(this.value) window.location.href='/sessions/${session.path}/' + this.value">
                                <option value="">On Now ...</option>
                                ${optionsHTML}
                            </select>
                        `;
                    }
                }
                // Otherwise no button - only show the session name link

                row.innerHTML = `
                    <td><a href="/sessions/${session.path}">${session.name}</a></td>
                    <td>${location}</td>
                    <td class="action-cell">${actionHTML}</td>
                `;
                tbody.appendChild(row);
            });
        }
    }
</script>
{% endblock %}