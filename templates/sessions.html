{% extends "base.html" %}

{% block extra_css %}
<style>
    .sessions-controls {
        margin-bottom: 1.5rem;
    }

    .search-and-toggle {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1rem;
        align-items: stretch;
    }

    .search-bar {
        flex: 1;
        padding: 0.75rem;
        font-size: 1rem;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background-color: var(--input-bg);
        color: var(--text-color);
    }

    .filter-toggle-button {
        padding: 0.75rem 1.5rem;
        border: 1px solid var(--border-color);
        background-color: var(--primary-color);
        color: white;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
        font-weight: 500;
    }

    .filter-toggle-button:hover {
        opacity: 0.9;
    }

    .session-count {
        margin-bottom: 1rem;
        color: var(--secondary-text);
    }

    .sessions-grid {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1.5rem;
    }

    .sessions-grid thead {
        background-color: var(--table-header-bg);
        border-bottom: 2px solid var(--border-color);
    }

    .sessions-grid th {
        padding: 0.75rem;
        text-align: left;
        font-weight: 600;
    }

    .sessions-grid tbody tr {
        border-bottom: 1px solid var(--border-color);
        transition: background-color 0.2s;
    }

    .sessions-grid tbody tr:hover {
        background-color: var(--hover-bg);
    }

    .sessions-grid td {
        padding: 0.75rem;
    }

    .sessions-grid a {
        color: var(--link-color);
        text-decoration: none;
    }

    .sessions-grid a:hover {
        text-decoration: underline;
    }

    .no-sessions {
        padding: 2rem;
        text-align: center;
        color: var(--secondary-text);
    }

    .today-action-btn {
        padding: 0.4rem 0.8rem;
        font-size: 0.85rem;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
        white-space: nowrap;
    }

    .btn-goto-today {
        background-color: #28a745;
        color: white;
    }

    .btn-goto-today:hover {
        background-color: #218838;
    }

    .btn-start-today {
        background-color: #007bff;
        color: white;
    }

    .btn-start-today:hover {
        background-color: #0069d9;
    }

    .action-cell {
        text-align: right;
        white-space: nowrap;
    }

    .loading-message {
        padding: 2rem;
        text-align: center;
        color: var(--text-color);
        font-size: 1.1rem;
    }

    .loading-dots {
        font-weight: bold;
        animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
        0%, 100% {
            opacity: 0.3;
        }
        50% {
            opacity: 1;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="landing-page" style="display: block;">

    <h1>Sessions</h1>

    <div class="sessions-controls">
        <div class="search-and-toggle">
            <input type="text" id="search-bar" class="search-bar" placeholder="Search by name or location...">
            <button class="filter-toggle-button" id="filter-toggle-button">
                {% if is_logged_in %}My Sessions{% else %}All Active{% endif %}
            </button>
        </div>

        <div class="session-count" id="session-count">Showing <span id="count-number">0</span> <span id="count-filter-type">active</span>.</div>
    </div>

    <div id="loading-message" class="loading-message">
        Loading<span class="loading-dots">...</span>
    </div>

    <table class="sessions-grid" id="sessions-table" style="display: none;">
        <thead>
            <tr>
                <th>Name</th>
                <th>Location</th>
                <th></th>
            </tr>
        </thead>
        <tbody id="sessions-tbody">
            <!-- Sessions will be populated by JavaScript -->
        </tbody>
    </table>
    <div id="no-results" class="no-sessions" style="display: none;">No sessions found.</div>

    <p><a href="/">‚Üê Back to home</a></p>
{% endblock %}

{% block extra_js %}
<script>
    let allSessions = [];
    let todayStr = '';
    const isLoggedIn = {{ 'true' if is_logged_in else 'false' }};

    // Define filter states based on login status
    const filterStates = isLoggedIn
        ? ['my', 'active', 'all', 'inactive']
        : ['active', 'all', 'inactive'];

    let currentFilterIndex = 0;
    let currentFilter = filterStates[currentFilterIndex];
    let searchTerm = '';

    const filterButtonLabels = {
        'my': 'My Sessions',
        'active': 'All Active',
        'all': 'All',
        'inactive': 'Inactive'
    };

    document.addEventListener('DOMContentLoaded', function() {
        loadSessionData();
        setupEventListeners();
    });

    async function loadSessionData() {
        try {
            const response = await fetch('/api/sessions/with-today-status');
            const data = await response.json();

            if (data.success) {
                allSessions = data.sessions;
                todayStr = data.today;

                // Hide loading message
                document.getElementById('loading-message').style.display = 'none';

                updateDisplay();
            } else {
                console.error('Failed to load sessions:', data.error);
                document.getElementById('loading-message').textContent = 'Error loading sessions';
            }
        } catch (error) {
            console.error('Error loading sessions:', error);
            document.getElementById('loading-message').textContent = 'Error loading sessions';
        }
    }

    function setupEventListeners() {
        // Toggle button - cycles through filter states
        document.getElementById('filter-toggle-button').addEventListener('click', function() {
            currentFilterIndex = (currentFilterIndex + 1) % filterStates.length;
            currentFilter = filterStates[currentFilterIndex];
            this.textContent = filterButtonLabels[currentFilter];
            updateDisplay();
        });

        // Search bar
        document.getElementById('search-bar').addEventListener('input', function(e) {
            searchTerm = e.target.value.toLowerCase();
            updateDisplay();
        });
    }

    function isScheduledToday(recurrence) {
        if (!recurrence) return false;

        const today = new Date();
        const dayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday, etc.
        const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        const todayName = dayNames[dayOfWeek];

        // Try to parse as JSON first
        try {
            const recurrenceData = JSON.parse(recurrence);
            if (recurrenceData.schedules && Array.isArray(recurrenceData.schedules)) {
                // Check if any schedule matches today
                return recurrenceData.schedules.some(schedule => {
                    if (schedule.weekday === todayName) {
                        // For weekly patterns, check if today matches the interval
                        if (schedule.type === 'weekly') {
                            // Without knowing the reference date, we can't determine every_n_weeks
                            // So we assume it's scheduled (conservative approach for UX)
                            return true;
                        }
                        // For monthly patterns, check if today matches the nth occurrence
                        else if (schedule.type === 'monthly_nth_weekday') {
                            const dayOfMonth = today.getDate();
                            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                            const firstWeekdayOfMonth = firstDayOfMonth.getDay();

                            // Calculate which occurrence this is
                            let occurrenceNum = Math.floor((dayOfMonth - 1 + firstWeekdayOfMonth) / 7) + 1;

                            // Check for last occurrence
                            const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                            const isLastOccurrence = dayOfMonth + 7 > lastDayOfMonth.getDate();

                            if (schedule.which) {
                                return schedule.which.includes(occurrenceNum) ||
                                       (isLastOccurrence && schedule.which.includes(-1));
                            }
                        }
                    }
                    return false;
                });
            }
        } catch (e) {
            // Not JSON, fall back to text parsing for legacy data
        }

        // Legacy text parsing
        const recurrenceLower = recurrence.toLowerCase();

        // Check for day of week mentions
        if (recurrenceLower.includes(todayName)) {
            return true;
        }

        // Check for "weekly" or "every week" (assume scheduled every week on same day)
        if (recurrenceLower.includes('weekly') || recurrenceLower.includes('every week')) {
            return true;
        }

        // For "monthly" or "biweekly", we can't determine without more info
        // For now, return false to be conservative
        return false;
    }

    function filterSessions() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        return allSessions.filter(session => {
            // Apply status filter
            let passesStatusFilter = false;
            if (currentFilter === 'my') {
                passesStatusFilter = session.user_is_member;
            } else if (currentFilter === 'active') {
                if (!session.termination_date) {
                    passesStatusFilter = true;
                } else {
                    const terminationDate = new Date(session.termination_date);
                    passesStatusFilter = terminationDate > today;
                }
            } else if (currentFilter === 'all') {
                passesStatusFilter = true;
            } else if (currentFilter === 'inactive') {
                if (session.termination_date) {
                    const terminationDate = new Date(session.termination_date);
                    passesStatusFilter = terminationDate <= today;
                } else {
                    passesStatusFilter = false;
                }
            }

            if (!passesStatusFilter) return false;

            // Apply search filter
            if (searchTerm) {
                const location = [session.city, session.state, session.country]
                    .filter(x => x)
                    .join(', ')
                    .toLowerCase();
                const nameMatch = session.name.toLowerCase().includes(searchTerm);
                const locationMatch = location.includes(searchTerm);
                return nameMatch || locationMatch;
            }

            return true;
        });
    }

    async function startTodaySession(sessionPath) {
        try {
            const response = await fetch(`/api/sessions/${sessionPath}/instances/today`, {
                method: 'POST'
            });
            const data = await response.json();

            if (data.success) {
                // Redirect to the session instance
                window.location.href = `/sessions/${sessionPath}/${data.date}`;
            } else {
                alert('Failed to create session: ' + (data.message || data.error));
            }
        } catch (error) {
            console.error('Error creating session:', error);
            alert('Error creating session. Please try again.');
        }
    }

    function updateDisplay() {
        const filteredSessions = filterSessions();
        const tbody = document.getElementById('sessions-tbody');
        const noResults = document.getElementById('no-results');
        const table = document.getElementById('sessions-table');

        // Update count
        const countNumber = document.getElementById('count-number');
        const countFilterType = document.getElementById('count-filter-type');
        countNumber.textContent = filteredSessions.length;

        const filterLabels = {
            'my': 'sessions in your list',
            'active': 'active sessions',
            'all': 'sessions',
            'inactive': 'inactive sessions'
        };
        countFilterType.textContent = filterLabels[currentFilter] || 'sessions';

        // Clear tbody
        tbody.innerHTML = '';

        if (filteredSessions.length === 0) {
            table.style.display = 'none';
            noResults.style.display = 'block';
        } else {
            table.style.display = 'table';
            noResults.style.display = 'none';

            filteredSessions.forEach(session => {
                const row = document.createElement('tr');

                const location = [session.city, session.state, session.country]
                    .filter(x => x)
                    .join(', ') || 'Unknown';

                // Determine what action to show
                let actionHTML = '';
                if (session.has_instance_today) {
                    // Has an instance today - show "Go to today's session"
                    actionHTML = `<button class="today-action-btn btn-goto-today" onclick="window.location.href='/sessions/${session.path}/${session.instance_date_today}'">Go to today's session</button>`;
                } else if (isScheduledToday(session.recurrence)) {
                    // Scheduled today but no instance - show "Start today's session"
                    actionHTML = `<button class="today-action-btn btn-start-today" onclick="startTodaySession('${session.path}')">Start today's session</button>`;
                }
                // Otherwise no button - regular link only

                row.innerHTML = `
                    <td><a href="/sessions/${session.path}">${session.name}</a></td>
                    <td>${location}</td>
                    <td class="action-cell">${actionHTML}</td>
                `;
                tbody.appendChild(row);
            });
        }
    }
</script>
{% endblock %}