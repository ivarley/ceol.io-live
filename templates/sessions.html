{% extends "base.html" %}

{% block extra_css %}
<style>
    .sessions-controls {
        margin-bottom: 1.5rem;
    }

    .search-and-toggle {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1rem;
        align-items: stretch;
    }

    .search-bar {
        flex: 1;
        padding: 0.75rem;
        font-size: 1rem;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background-color: var(--input-bg);
        color: var(--text-color);
    }

    .filter-toggle-button {
        padding: 0.75rem 1.5rem;
        border: 1px solid var(--border-color);
        background-color: var(--primary-color);
        color: white;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
        font-weight: 500;
    }

    .filter-toggle-button:hover {
        opacity: 0.9;
    }

    .session-count {
        margin-bottom: 1rem;
        color: var(--secondary-text);
    }

    .sessions-grid {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1.5rem;
    }

    .sessions-grid thead {
        background-color: var(--table-header-bg);
        border-bottom: 2px solid var(--border-color);
    }

    .sessions-grid th {
        padding: 0.75rem;
        text-align: left;
        font-weight: 600;
    }

    .sessions-grid tbody tr {
        border-bottom: 1px solid var(--border-color);
        transition: background-color 0.2s;
    }

    .sessions-grid tbody tr:hover {
        background-color: var(--hover-bg);
    }

    .sessions-grid td {
        padding: 0.75rem;
    }

    .sessions-grid a {
        color: var(--link-color);
        text-decoration: none;
    }

    .sessions-grid a:hover {
        text-decoration: underline;
    }

    .no-sessions {
        padding: 2rem;
        text-align: center;
        color: var(--secondary-text);
    }
</style>
{% endblock %}

{% block content %}
<div class="landing-page" style="display: block;">

    <h1>Sessions</h1>

    <div class="sessions-controls">
        <div class="search-and-toggle">
            <input type="text" id="search-bar" class="search-bar" placeholder="Search by name or location...">
            <button class="filter-toggle-button" id="filter-toggle-button">
                {% if is_logged_in %}My Sessions{% else %}All Active{% endif %}
            </button>
        </div>

        <div class="session-count" id="session-count">Showing <span id="count-number">0</span> <span id="count-filter-type">active</span>.</div>
    </div>

    {% if sessions %}
        <table class="sessions-grid" id="sessions-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Location</th>
                </tr>
            </thead>
            <tbody id="sessions-tbody">
                <!-- Sessions will be populated by JavaScript -->
            </tbody>
        </table>
        <div id="no-results" class="no-sessions" style="display: none;">No sessions found.</div>

        <!-- Hidden data storage -->
        <div style="display: none;">
            {% for session in sessions %}
            <div class="session-data"
                 data-id="{{ session[0] }}"
                 data-name="{{ session[1] }}"
                 data-path="{{ session[2] }}"
                 data-city="{{ session[3] or '' }}"
                 data-state="{{ session[4] or '' }}"
                 data-country="{{ session[5] or '' }}"
                 data-termination="{{ session[6] or '' }}"
                 data-is-member="{{ session[7] }}">
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="no-sessions">No sessions found.</div>
    {% endif %}

    <p><a href="/">‚Üê Back to home</a></p>
{% endblock %}

{% block extra_js %}
<script>
    let allSessions = [];
    const isLoggedIn = {{ 'true' if is_logged_in else 'false' }};

    // Define filter states based on login status
    const filterStates = isLoggedIn
        ? ['my', 'active', 'all', 'inactive']
        : ['active', 'all', 'inactive'];

    let currentFilterIndex = 0;
    let currentFilter = filterStates[currentFilterIndex];
    let searchTerm = '';

    const filterButtonLabels = {
        'my': 'My Sessions',
        'active': 'All Active',
        'all': 'All',
        'inactive': 'Inactive'
    };

    document.addEventListener('DOMContentLoaded', function() {
        loadSessionData();
        setupEventListeners();
        updateDisplay();
    });

    function loadSessionData() {
        const sessionElements = document.querySelectorAll('.session-data');
        allSessions = Array.from(sessionElements).map(el => ({
            id: parseInt(el.dataset.id),
            name: el.dataset.name,
            path: el.dataset.path,
            city: el.dataset.city,
            state: el.dataset.state,
            country: el.dataset.country,
            termination: el.dataset.termination,
            isMember: el.dataset.isMember === 'True'
        }));
    }

    function setupEventListeners() {
        // Toggle button - cycles through filter states
        document.getElementById('filter-toggle-button').addEventListener('click', function() {
            currentFilterIndex = (currentFilterIndex + 1) % filterStates.length;
            currentFilter = filterStates[currentFilterIndex];
            this.textContent = filterButtonLabels[currentFilter];
            updateDisplay();
        });

        // Search bar
        document.getElementById('search-bar').addEventListener('input', function(e) {
            searchTerm = e.target.value.toLowerCase();
            updateDisplay();
        });
    }

    function filterSessions() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        return allSessions.filter(session => {
            // Apply status filter
            let passesStatusFilter = false;
            if (currentFilter === 'my') {
                passesStatusFilter = session.isMember;
            } else if (currentFilter === 'active') {
                if (!session.termination) {
                    passesStatusFilter = true;
                } else {
                    const terminationDate = new Date(session.termination);
                    passesStatusFilter = terminationDate > today;
                }
            } else if (currentFilter === 'all') {
                passesStatusFilter = true;
            } else if (currentFilter === 'inactive') {
                if (session.termination) {
                    const terminationDate = new Date(session.termination);
                    passesStatusFilter = terminationDate <= today;
                } else {
                    passesStatusFilter = false;
                }
            }

            if (!passesStatusFilter) return false;

            // Apply search filter
            if (searchTerm) {
                const location = [session.city, session.state, session.country]
                    .filter(x => x)
                    .join(', ')
                    .toLowerCase();
                const nameMatch = session.name.toLowerCase().includes(searchTerm);
                const locationMatch = location.includes(searchTerm);
                return nameMatch || locationMatch;
            }

            return true;
        });
    }

    function updateDisplay() {
        const filteredSessions = filterSessions();
        const tbody = document.getElementById('sessions-tbody');
        const noResults = document.getElementById('no-results');
        const table = document.getElementById('sessions-table');

        // Update count
        const countNumber = document.getElementById('count-number');
        const countFilterType = document.getElementById('count-filter-type');
        countNumber.textContent = filteredSessions.length;

        const filterLabels = {
            'my': 'sessions in your list',
            'active': 'active sessions',
            'all': 'sessions',
            'inactive': 'inactive sessions'
        };
        countFilterType.textContent = filterLabels[currentFilter] || 'sessions';

        // Clear tbody
        tbody.innerHTML = '';

        if (filteredSessions.length === 0) {
            table.style.display = 'none';
            noResults.style.display = 'block';
        } else {
            table.style.display = 'table';
            noResults.style.display = 'none';

            filteredSessions.forEach(session => {
                const row = document.createElement('tr');

                const location = [session.city, session.state, session.country]
                    .filter(x => x)
                    .join(', ') || 'Unknown';

                row.innerHTML = `
                    <td><a href="/sessions/${session.path}">${session.name}</a></td>
                    <td>${location}</td>
                `;
                tbody.appendChild(row);
            });
        }
    }
</script>
{% endblock %}