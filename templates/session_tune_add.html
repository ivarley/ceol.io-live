{% extends "base.html" %}
{% from 'components/tune_search_input.html' import tune_search_input %}

{% block title %}Add Tune - {{ session_name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/tune-search.css') }}">
<style>
    /* Override parent container padding */
    .docs-content {
        padding: 0 !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
    }

    .add-tune-container {
        max-width: 600px;
        margin: 40px auto;
        padding: 20px;
    }

    .page-header {
        margin-bottom: 5px;
    }

    .page-header h1 {
        margin-bottom: 10px;
    }

    .back-link {
        color: var(--primary);
        text-decoration: none;
        font-size: 14px;
        display: inline-block;
        margin-bottom: 20px;
    }

    .back-link:hover {
        text-decoration: underline;
    }

    .form-container {
        background-color: var(--bg-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 30px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--text-color);
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 14px;
        background-color: var(--bg-color);
        color: var(--text-color);
        box-sizing: border-box;
    }

    .form-group .help-text {
        font-size: 13px;
        color: var(--text-muted, #6c757d);
        margin-top: 5px;
    }

    .form-actions {
        display: flex;
        gap: 10px;
        margin-top: 30px;
    }

    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        text-align: center;
        transition: all 0.2s;
    }

    .btn-primary {
        background-color: var(--primary);
        color: white;
    }

    .btn-primary:hover:not(:disabled) {
        background-color: var(--primary-dark, #0056b3);
    }

    .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-secondary {
        background-color: var(--secondary, #6c757d);
        color: white;
    }

    .btn-secondary:hover {
        background-color: var(--secondary-dark, #5a6268);
        text-decoration: none;
        color: white;
    }

    .error-message {
        background-color: #f8d7da;
        color: #721c24;
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 20px;
        border: 1px solid #f5c6cb;
    }

    .success-message {
        background-color: #d4edda;
        color: #155724;
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 20px;
        border: 1px solid #c3e6cb;
    }

    /* Mobile optimizations */
    @media (max-width: 768px) {
        .add-tune-container {
            padding: 15px;
            margin: 20px auto;
        }

        .form-container {
            padding: 20px;
        }

        .form-actions {
            flex-direction: column;
        }

        .btn {
            width: 100%;
        }
    }

    /* Dark mode adjustments */
    [data-theme="dark"] .error-message {
        background-color: #5a1f1f;
        color: #f8d7da;
        border-color: #721c24;
    }

    [data-theme="dark"] .success-message {
        background-color: #1f4a2f;
        color: #d4edda;
        border-color: #155724;
    }
</style>
{% endblock %}

{% block content %}
<div class="add-tune-container">
    <a href="/sessions/{{ session_path }}" class="back-link">‚Üê Back to {{ session_name }}</a>

    <div class="page-header">
        <h1>Add Tune to Session</h1>
        <p>Search for a tune to add to {{ session_name }}</p>
    </div>

    <div id="message-container"></div>

    <div class="form-container">
        <form id="add-tune-form">
            {{ tune_search_input(
                placeholder="Start typing a tune name, or paste tune ID/URL...",
                help_text="Type to search for tunes. You can also paste a TheSession.org URL or tune ID.",
                label="Search for Tune",
                required=True
            ) }}

            <div class="form-group">
                <label for="alias">We call this:</label>
                <input
                    type="text"
                    id="alias"
                    name="alias"
                    placeholder="Alternative name (optional)"
                >
                <div class="help-text">
                    If you call this tune by a different name in this session
                </div>
            </div>

            <div class="form-group">
                <label for="setting-id">We play this setting:</label>
                <input
                    type="text"
                    id="setting-id"
                    name="setting_id"
                    placeholder="Setting ID or URL (optional)"
                >
                <div class="help-text">
                    If you play a specific setting, enter the URL or setting ID here
                </div>
                <div id="setting-id-error" class="error-message" style="display: none; margin-top: 5px;"></div>
            </div>

            <div class="form-group">
                <label for="key">We play it in this key:</label>
                <select id="key" name="key">
                    <option value="">(not specified)</option>
                    <option value="Amajor">Amajor</option>
                    <option value="Aminor">Aminor</option>
                    <option value="Adorian">Adorian</option>
                    <option value="Amixolydian">Amixolydian</option>
                    <option value="Bminor">Bminor</option>
                    <option value="Cmajor">Cmajor</option>
                    <option value="Dmajor">Dmajor</option>
                    <option value="Dminor">Dminor</option>
                    <option value="Eminor">Eminor</option>
                    <option value="Fmajor">Fmajor</option>
                    <option value="Gmajor">Gmajor</option>
                    <option value="Dmixolydian">Dmixolydian</option>
                    <option value="Bmixolydian">Bmixolydian</option>
                    <option value="Edorian">Edorian</option>
                    <option value="Gdorian">Gdorian</option>
                    <option value="Gminor">Gminor</option>
                    <option value="Ddorian">Ddorian</option>
                    <option value="Cdorian">Cdorian</option>
                    <option value="Fdorian">Fdorian</option>
                    <option value="Gmixolydian">Gmixolydian</option>
                    <option value="Emajor">Emajor</option>
                    <option value="Bdorian">Bdorian</option>
                    <option value="Emixolydian">Emixolydian</option>
                </select>
                <div class="help-text">
                    The key your session typically plays this tune in
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary" id="submit-btn" disabled>
                    Add Tune
                </button>
                <a href="/sessions/{{ session_path }}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>

<script>
// Helper functions for API calls
function fetchWithRetry(url, options = {}) {
    return fetch(url, options);
}

function handleApiError(error, response = null) {
    if (response) {
        if (response.status === 401) {
            return { message: 'Please log in again', action: () => window.location.href = '/login' };
        }
        if (response.status === 404) {
            return { message: 'Not found', retryable: false };
        }
        if (response.status >= 500) {
            return { message: 'Server error. Please try again.', retryable: true };
        }
        return { message: 'An error occurred. Please try again.', retryable: true };
    }
    return { message: error?.message || 'An error occurred', retryable: true };
}

function showLoading(message = 'Loading...') {
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'loading-overlay';

    const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
    const bgColor = isDarkMode ? 'rgba(30, 30, 30, 0.95)' : 'rgba(255, 255, 255, 0.95)';
    const textColor = isDarkMode ? '#e0e0e0' : '#333';
    const spinnerBorderColor = isDarkMode ? '#444' : '#ddd';

    loadingDiv.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: ${bgColor}; z-index: 2800;
        display: flex; align-items: center; justify-content: center;
        flex-direction: column; gap: 15px;
    `;
    loadingDiv.innerHTML = `
        <div style="width: 40px; height: 40px; border: 4px solid ${spinnerBorderColor};
                    border-top-color: #007bff; border-radius: 50%;
                    animation: spin 0.8s linear infinite;"></div>
        <div style="color: ${textColor}; font-size: 16px;">${message}</div>
    `;
    const style = document.createElement('style');
    style.textContent = '@keyframes spin { to { transform: rotate(360deg); } }';
    document.head.appendChild(style);
    document.body.appendChild(loadingDiv);
    return {
        hide: () => {
            if (loadingDiv.parentNode) loadingDiv.parentNode.removeChild(loadingDiv);
            if (style.parentNode) style.parentNode.removeChild(style);
        }
    };
}

// Extract setting ID from thesession.org URL or plain number
function extractSettingId(input) {
    if (!input || input.trim() === '') {
        return null;
    }

    const trimmed = input.trim();

    // If it's already just a number, return it
    if (/^\d+$/.test(trimmed)) {
        return parseInt(trimmed);
    }

    // Try to extract from URL query param format first: ?setting=123 or &setting=123
    const queryMatch = trimmed.match(/[?&]setting=(\d+)/);
    if (queryMatch) {
        return parseInt(queryMatch[1]);
    }

    // Fall back to hash format: #setting123
    const hashMatch = trimmed.match(/#setting(\d+)/);
    if (hashMatch) {
        return parseInt(hashMatch[1]);
    }

    return null;
}

// Validate that input is either empty, a number, or a valid thesession.org URL
function validateSettingId(input) {
    if (!input || input.trim() === '') {
        return { valid: true, settingId: null };
    }

    const trimmed = input.trim();

    // Check if it's just a number
    if (/^\d+$/.test(trimmed)) {
        return { valid: true, settingId: parseInt(trimmed) };
    }

    // Check if it's a valid thesession.org URL
    if (trimmed.includes('thesession.org')) {
        const settingId = extractSettingId(trimmed);
        if (settingId !== null) {
            return { valid: true, settingId: settingId };
        }
    }

    return { valid: false, settingId: null, error: 'Please enter a number or paste a valid TheSession.org URL' };
}

// Handle setting ID input with instant parsing and validation
function onSettingIdInput() {
    const input = document.getElementById('setting-id');
    const errorDiv = document.getElementById('setting-id-error');

    if (!input || !errorDiv) return;

    const value = input.value;
    const validation = validateSettingId(value);

    if (!validation.valid) {
        errorDiv.textContent = validation.error;
        errorDiv.style.display = 'block';
        input.style.borderColor = '#dc3545';
    } else {
        errorDiv.style.display = 'none';
        input.style.borderColor = '';

        // If we extracted a setting ID from a URL, replace the input with just the number
        if (validation.settingId !== null && value !== validation.settingId.toString()) {
            input.value = validation.settingId.toString();
        }
    }
}

// DOM elements
const submitBtn = document.getElementById('submit-btn');
const addTuneForm = document.getElementById('add-tune-form');
const settingIdInput = document.getElementById('setting-id');

// Initialize tune search component
let tuneSearch;
document.addEventListener('DOMContentLoaded', function() {
    tuneSearch = new TuneSearchComponent({
        searchInputId: 'tune-search',
        autocompleteResultsId: 'autocomplete-results',
        hiddenInputId: 'selected-tune-id',
        noResultsMessage: 'No tunes found',
        tunebookCountStyle: 'badge', // Show badge format
        {% if session_id %}
        sessionId: {{ session_id }}, // Pass session_id for context
        {% endif %}
        {% if current_user and current_user.person_id %}
        personId: {{ current_user.person_id }}, // Also pass person_id for learn status display
        {% endif %}
        onTuneSelected: (tune) => {
            // Enable submit button when tune is selected
            submitBtn.disabled = false;
        },
        onTuneAlreadyAdded: (tune) => {
            // Tune already in session_tune - navigate with already parameter
            const sessionPath = '{{ session_path }}';
            window.location.href = `/sessions/${sessionPath}?show=${tune.tune_id}&already=1`;
        }
    });

    // Check for query parameter and extract setting ID if present
    const params = new URLSearchParams(window.location.search);
    if (params.has('q')) {
        const query = params.get('q').trim();
        if (query) {
            // Check if the query contains a setting ID (URL format)
            const settingId = extractSettingId(query);
            if (settingId && settingIdInput) {
                settingIdInput.value = settingId.toString();
            }
        }
    }
});

// Setup form event listeners
addTuneForm.addEventListener('submit', handleSubmit);
if (settingIdInput) {
    settingIdInput.addEventListener('input', onSettingIdInput);
}

/*
REMOVED: All search-related variables, functions, and event listeners
have been moved to TuneSearchComponent.js for reusability.

Removed code includes:
- State variables (searchTimeout, selectedTuneId, selectedIndex, etc.)
- Search functions (searchTunes, fetchTuneFromTheSession, searchTheSession, etc.)
- Autocomplete display functions (displayResults, showAutocompleteLoading, etc.)
- Selection functions (selectTune, selectTuneByIndex, hideAutocomplete, etc.)
- Helper functions (extractTuneId, normalizeTuneType)
- Event handlers (handleSearchInput, handleKeyDown, handleBlur, updateSelection)
*/


function handleSubmit(e) {
    e.preventDefault();

    const selectedTuneId = tuneSearch.getSelectedTuneId();
    if (!selectedTuneId) {
        showMessage('Please select a tune from the search results', 'error');
        return;
    }

    if (!navigator.onLine) {
        showMessage('You are offline. Please check your connection.', 'error');
        return;
    }

    // Validate setting ID before proceeding
    const settingIdValue = document.getElementById('setting-id').value;
    const settingIdValidation = validateSettingId(settingIdValue);
    if (!settingIdValidation.valid) {
        showMessage(settingIdValidation.error, 'error');
        return;
    }

    const formData = {
        tune_id: selectedTuneId,
        alias: document.getElementById('alias').value.trim() || null,
        setting_id: settingIdValidation.settingId,
        key: document.getElementById('key').value.trim() || null
    };

    // If this is a tune from TheSession.org, include the tune details for insertion
    const theSessionTune = tuneSearch.getTheSessionTuneData();
    if (theSessionTune) {
        formData.new_tune = {
            tune_id: theSessionTune.tune_id,
            name: theSessionTune.name,
            tune_type: theSessionTune.tune_type,
            tunebook_count: theSessionTune.tunebook_count
        };
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Adding...';

    const loading = showLoading('Adding tune to session...');
    const sessionPath = '{{ session_path }}';

    fetchWithRetry(`/api/sessions/${sessionPath}/tunes`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                const errorInfo = handleApiError(null, response);
                throw new Error(data.error || errorInfo.message);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            window.location.href = `/sessions/${sessionPath}?show=${selectedTuneId}&added=` + encodeURIComponent(tuneSearch.getValue());
        } else {
            loading.hide();
            throw new Error(data.error || 'Failed to add tune');
        }
    })
    .catch(error => {
        loading.hide();
        console.error('Error adding tune:', error);
        const errorInfo = handleApiError(error);
        showMessage(errorInfo.message, 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Add Tune';
    });
}

function showMessage(message, type) {
    const container = document.getElementById('message-container');
    const className = type === 'error' ? 'error-message' : 'success-message';
    container.innerHTML = `<div class="${className}">${escapeHtml(message)}</div>`;
    container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
<script src="{{ url_for('static', filename='js/components/TuneSearchComponent.js') }}"></script>
{% endblock %}
