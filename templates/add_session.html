{% extends "base.html" %}

{% block title %}Add Session{% endblock %}

{% block content %}
<article class="docs-article">
    <header class="docs-header">
        <h1 class="docs-heading">Add A New Session</h1>
        <section class="docs-intro">
            <p>To add your session to the site, you can:</p>
            <ul>
                <li>Search by name or location: <code>memphis</code> or <code>murphy's pub</code></li>
                <li>Paste the session ID (<code>6247</code>) or URL: <code>https://thesession.org/sessions/6247</code></li>
            </ul>
            <p>We'll pull all the details from TheSession.org. If you don't have your session on that site, you can <a href="https://thesession.org/sessions/add#step1" target="_blank">put it there first</a>, or <a href="#" onclick="openEmptySessionModal(); return false;">just add it here</a>.</p>
        </section>
    </header>
    <div class="docs-body">
        <section>
            <div class="alert alert-info" id="loadingSpinner" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i> Fetching session data from TheSession.org...
            </div>
            
            <div class="alert alert-danger" id="errorAlert" style="display: none;"></div>
            
            <form id="sessionUrlForm">
                <div class="mb-3">
                    <label for="sessionUrl" class="form-label">Session URL, ID, or search term:</label>
                    <input type="text" class="form-control" id="sessionUrl" placeholder="e.g. 'memphis' or a URL" required>
                </div>
                <button type="submit" class="btn btn-primary">Next</button>
            </form>
            
            <!-- Search Results Dropdown -->
            <div id="searchResults" style="display: none; margin-top: 20px;">
                <h4>Search Results:</h4>
                <div class="search-results-container">
                    <div id="searchResultsList"></div>
                    <button type="button" class="btn btn-secondary" id="newSearchBtn" style="margin-top: 10px;">Search again</button>
                </div>
            </div>
        </section>
    </div>
</article>

<!-- Session Details Modal -->
<div id="sessionModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3>Session Details</h3>
            <button type="button" onclick="closeSessionModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
        </div>
        <div class="modal-body">
            <form id="sessionDetailsForm">
                <div class="mb-3">
                    <label for="sessionName">Session Name:</label>
                    <input type="text" id="sessionName" required>
                </div>
                <div class="mb-3">
                    <label for="sessionPath">Path (URL slug):</label>
                    <input type="text" id="sessionPath" required>
                </div>
                <div class="mb-3">
                    <label for="locationName">Location Name:</label>
                    <input type="text" id="locationName">
                </div>
                <div class="mb-3">
                    <label for="locationPhone">Location Phone:</label>
                    <input type="text" id="locationPhone">
                </div>
                <div class="mb-3">
                    <label for="locationWebsite">Location Website:</label>
                    <input type="url" id="locationWebsite">
                </div>
                <div class="mb-3">
                    <label for="cityName">City:</label>
                    <input type="text" id="cityName" required>
                </div>
                <div class="mb-3">
                    <label for="stateName">State/Area:</label>
                    <input type="text" id="stateName" required>
                </div>
                <div class="mb-3">
                    <label for="countryName">Country:</label>
                    <input type="text" id="countryName" required>
                </div>
                <div class="mb-3">
                    <label for="inceptionDate">Inception Date:</label>
                    <input type="date" id="inceptionDate">
                </div>
                <div class="mb-3">
                    <label for="timezone">Timezone:</label>
                    <select id="timezone" class="form-control">
                        <option value="America/New_York">America/New_York (Eastern)</option>
                        <option value="America/Chicago">America/Chicago (Central)</option>
                        <option value="America/Denver">America/Denver (Mountain)</option>
                        <option value="America/Phoenix">America/Phoenix (Arizona)</option>
                        <option value="America/Los_Angeles">America/Los_Angeles (Pacific)</option>
                        <option value="America/Anchorage">America/Anchorage (Alaska)</option>
                        <option value="Pacific/Honolulu">Pacific/Honolulu (Hawaii)</option>
                        <option value="Europe/Dublin">Europe/Dublin (Ireland)</option>
                        <option value="Europe/London">Europe/London (UK)</option>
                        <option value="UTC">UTC</option>
                    </select>
                </div>

                <!-- Recurrence Section (collapsible) -->
                <div class="mb-3">
                    <label>Schedule:</label>
                    <div id="recurrence-section" class="recurrence-section">
                        <!-- Collapsed summary view -->
                        <div id="recurrence-summary" class="recurrence-summary" onclick="toggleRecurrenceEdit()">
                            <span id="recurrence-summary-text">No schedule set</span>
                            <span class="recurrence-toggle-icon">&#9662;</span>
                        </div>

                        <!-- Expanded edit view -->
                        <div id="recurrence-edit" class="recurrence-edit" style="display: none;">
                            <div class="mb-2">
                                <label class="form-label small">Pattern Type:</label>
                                <select id="recurrence-type" class="form-control" onchange="updateRecurrenceTypeUI()">
                                    <option value="">No schedule</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly_nth_weekday">Monthly (Nth Weekday)</option>
                                </select>
                            </div>

                            <div id="recurrence-options" style="display: none;">
                                <div class="mb-2">
                                    <label class="form-label small">Day:</label>
                                    <div class="weekday-buttons">
                                        <button type="button" class="weekday-btn" data-weekday="monday" onclick="selectWeekday('monday')">Mon</button>
                                        <button type="button" class="weekday-btn" data-weekday="tuesday" onclick="selectWeekday('tuesday')">Tue</button>
                                        <button type="button" class="weekday-btn" data-weekday="wednesday" onclick="selectWeekday('wednesday')">Wed</button>
                                        <button type="button" class="weekday-btn" data-weekday="thursday" onclick="selectWeekday('thursday')">Thu</button>
                                        <button type="button" class="weekday-btn" data-weekday="friday" onclick="selectWeekday('friday')">Fri</button>
                                        <button type="button" class="weekday-btn" data-weekday="saturday" onclick="selectWeekday('saturday')">Sat</button>
                                        <button type="button" class="weekday-btn" data-weekday="sunday" onclick="selectWeekday('sunday')">Sun</button>
                                    </div>
                                </div>

                                <div id="weekly-options" style="display: none;">
                                    <div class="mb-2">
                                        <label class="form-label small">Frequency:</label>
                                        <select id="recurrence-frequency" class="form-control" onchange="updateRecurrenceSummary()">
                                            <option value="1">Every week</option>
                                            <option value="2">Every 2 weeks</option>
                                            <option value="3">Every 3 weeks</option>
                                            <option value="4">Every 4 weeks</option>
                                        </select>
                                    </div>
                                </div>

                                <div id="monthly-options" style="display: none;">
                                    <div class="mb-2">
                                        <label class="form-label small">Which occurrences:</label>
                                        <div class="nth-checkboxes">
                                            <label><input type="checkbox" class="nth-checkbox" value="1" onchange="updateRecurrenceSummary()"> 1st</label>
                                            <label><input type="checkbox" class="nth-checkbox" value="2" onchange="updateRecurrenceSummary()"> 2nd</label>
                                            <label><input type="checkbox" class="nth-checkbox" value="3" onchange="updateRecurrenceSummary()"> 3rd</label>
                                            <label><input type="checkbox" class="nth-checkbox" value="4" onchange="updateRecurrenceSummary()"> 4th</label>
                                            <label><input type="checkbox" class="nth-checkbox" value="-1" onchange="updateRecurrenceSummary()"> Last</label>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-6">
                                        <label class="form-label small">Start:</label>
                                        <input type="time" id="recurrence-start" class="form-control" value="19:00" onchange="updateRecurrenceSummary()">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small">End:</label>
                                        <input type="time" id="recurrence-end" class="form-control" value="22:00" onchange="updateRecurrenceSummary()">
                                    </div>
                                </div>
                            </div>

                            <button type="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="toggleRecurrenceEdit()">Done</button>
                        </div>

                        <!-- Unparsed recurrence notice -->
                        <div id="recurrence-unparsed" class="recurrence-unparsed" style="display: none;"></div>
                    </div>
                </div>

                <!-- Add Current User Section -->
                <div class="mb-3">
                    <div class="add-user-control">
                        <label class="checkbox-label">
                            <input type="checkbox" id="addCurrentUser" checked>
                            Add me as
                        </label>
                        <select id="addCurrentUserRole" class="form-control form-control-inline">
                            <option value="member">a member</option>
                            <option value="regular">a regular</option>
                            <option value="admin" selected>an admin</option>
                        </select>
                    </div>
                </div>

                <input type="hidden" id="thesessionId">
                <input type="hidden" id="recurrenceJSON">
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeSessionModal()">Cancel</button>
            <button type="button" class="btn btn-primary" id="saveSessionBtn">Save</button>
        </div>
    </div>
</div>

<!-- Existing Session Confirmation Modal -->
<div id="existingSessionModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3>Session Already Exists</h3>
            <button type="button" onclick="closeExistingSessionModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
        </div>
        <div class="modal-body">
            <p id="existingSessionMessage">This session is already in ceol.io; click here to view.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeExistingSessionModal()">Cancel</button>
            <button type="button" class="btn btn-primary" id="goToExistingBtn">Go</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Fix code elements for dark mode */
    code {
        background-color: var(--hover-bg);
        color: var(--text-color);
        padding: 0.2em 0.4em;
        border-radius: 3px;
        border: 1px solid var(--border-color);
    }
    
    /* Fix form controls for dark mode */
    .form-control {
        background-color: var(--bg-color);
        color: var(--text-color);
        border: 1px solid var(--border-color);
    }
    
    .form-control:focus {
        background-color: var(--bg-color);
        color: var(--text-color);
        border-color: var(--primary);
        box-shadow: 0 0 0 0.2rem var(--dropdown-shadow);
    }
    
    .form-control::placeholder {
        color: var(--disabled-text);
        opacity: 1;
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: var(--dropdown-shadow);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1900;
    }

    .modal-content {
        background-color: var(--bg-color);
        border-radius: 8px;
        padding: 0;
        box-shadow: 0 4px 20px var(--dropdown-shadow);
        max-height: 90vh;
        overflow-y: auto;
        max-width: 500px;
        width: 90%;
    }

    .modal-header {
        background-color: var(--light);
        padding: 16px 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 8px 8px 0 0;
    }

    .modal-header h3 {
        margin: 0;
        color: var(--text-color);
        font-size: 1.5rem;
    }

    .modal-body {
        padding: 20px;
    }

    .modal-body label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: var(--text-color);
    }

    .modal-body input[type="date"],
    .modal-body input[type="text"],
    .modal-body input[type="url"],
    .modal-body select {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        margin-bottom: 15px;
        font-size: 14px;
        background-color: var(--input-bg);
        color: var(--text-color);
    }

    .modal-footer {
        background-color: var(--light);
        padding: 12px 20px;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        border-radius: 0 0 8px 8px;
    }

    .modal-footer button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }

    .modal-footer .btn-primary {
        background-color: var(--primary);
        color: white;
    }

    .modal-footer .btn-secondary {
        background-color: var(--secondary);
        color: white;
    }

    .modal-footer button:hover {
        opacity: 0.9;
    }

    .modal-body input:focus {
        background-color: var(--input-bg);
        color: var(--text-color);
        border-color: var(--primary);
        outline: 0;
        box-shadow: 0 0 0 0.2rem var(--dropdown-shadow);
    }

    .search-results-container {
        background-color: var(--light);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 15px;
    }

    .search-result-item {
        padding: 10px;
        margin-bottom: 8px;
        background-color: var(--bg-color);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .search-result-item:hover {
        background-color: var(--hover-bg);
    }

    .search-result-item:last-child {
        margin-bottom: 0;
    }

    .search-result-item.existing {
        background-color: var(--warning-bg, #fff3cd);
        border-color: var(--warning-border, #ffeaa7);
    }

    .search-result-item.existing:hover {
        background-color: var(--warning-hover, #ffeaa7);
    }

    .existing-indicator {
        color: var(--warning-text, #856404);
        font-size: 12px;
        font-style: italic;
        margin-top: 4px;
    }

    /* Recurrence section styles */
    .recurrence-section {
        border: 1px solid var(--border-color);
        border-radius: 4px;
        overflow: hidden;
    }

    .recurrence-summary {
        padding: 10px 12px;
        background-color: var(--input-bg);
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: var(--text-color);
    }

    .recurrence-summary:hover {
        background-color: var(--hover-bg);
    }

    .recurrence-toggle-icon {
        font-size: 12px;
        transition: transform 0.2s;
    }

    .recurrence-section.expanded .recurrence-toggle-icon {
        transform: rotate(180deg);
    }

    .recurrence-edit {
        padding: 12px;
        background-color: var(--bg-color);
        border-top: 1px solid var(--border-color);
    }

    .weekday-buttons {
        display: flex;
        gap: 4px;
        flex-wrap: wrap;
    }

    .weekday-btn {
        padding: 6px 10px;
        border: 1px solid var(--border-color);
        background-color: var(--input-bg);
        color: var(--text-color);
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        min-width: 40px;
    }

    .weekday-btn:hover {
        background-color: var(--hover-bg);
    }

    .weekday-btn.active {
        background-color: var(--primary);
        border-color: var(--primary);
        color: white;
    }

    .nth-checkboxes {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .nth-checkboxes label {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 13px;
        margin-bottom: 0;
        cursor: pointer;
    }

    .recurrence-edit .form-label.small {
        font-size: 12px;
        margin-bottom: 4px;
        color: var(--secondary-text);
    }

    .recurrence-edit .row {
        margin-top: 10px;
    }

    .recurrence-edit input[type="time"] {
        margin-bottom: 0;
    }

    /* Form validation styling */
    .modal-body input.is-invalid,
    .modal-body select.is-invalid {
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }

    .modal-body .field-error {
        color: #dc3545;
        font-size: 12px;
        margin-top: -12px;
        margin-bottom: 12px;
    }

    .recurrence-unparsed {
        padding: 8px 12px;
        font-size: 12px;
        font-style: italic;
        color: var(--secondary-text);
        border-top: 1px solid var(--border-color);
    }

    /* Add current user control */
    .add-user-control {
        display: flex;
        align-items: center;
        gap: 6px;
        flex-wrap: wrap;
    }

    .add-user-control .checkbox-label {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 0;
        font-weight: normal;
        cursor: pointer;
    }

    .add-user-control .checkbox-label input[type="checkbox"] {
        width: 16px;
        height: 16px;
        margin: 0;
        cursor: pointer;
    }

    .add-user-control .form-control-inline {
        width: auto;
        display: inline-block;
        padding: 4px 8px;
        margin-bottom: 0;
        font-size: 14px;
    }

    .add-user-control select:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="/static/js/dist/modalManager.js"></script>
<script>
// Handle "Add current user" checkbox toggle
document.getElementById('addCurrentUser').addEventListener('change', function() {
    document.getElementById('addCurrentUserRole').disabled = !this.checked;
});

// Check query string for acu parameter
(function() {
    const urlParams = new URLSearchParams(window.location.search);
    const acuParam = urlParams.get('acu');
    if (acuParam === 'false') {
        document.getElementById('addCurrentUser').checked = false;
        document.getElementById('addCurrentUserRole').disabled = true;
    }
})();

document.getElementById('sessionUrlForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const input = document.getElementById('sessionUrl').value.trim();
    let sessionId = null;
    
    // Check if it's a full URL
    const urlPattern = /^https?:\/\/thesession\.org\/sessions\/(\d+)(?:\/.*)?$/i;
    const urlMatch = input.match(urlPattern);
    
    if (urlMatch) {
        sessionId = urlMatch[1];
    } else {
        // Check if it's just a number (session ID)
        const idPattern = /^\d+$/;
        if (idPattern.test(input)) {
            sessionId = input;
        } else {
            // If it's not a URL or ID, treat it as a search query
            searchSessions(input);
            return;
        }
    }
    
    // Check if this session ID is already in our database
    checkExistingSession(sessionId);
});

function showError(message) {
    const errorAlert = document.getElementById('errorAlert');
    errorAlert.innerHTML = message;
    errorAlert.style.display = 'block';
    
    // Hide after 5 seconds
    setTimeout(() => {
        errorAlert.style.display = 'none';
    }, 5000);
}

function showLoading(show) {
    document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
}

function checkExistingSession(sessionId) {
    showLoading(true);
    
    fetch('/api/check-existing-session', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ session_id: sessionId })
    })
    .then(response => response.json())
    .then(data => {
        showLoading(false);
        
        if (data.exists) {
            showError(`Session ${sessionId} is already in the database at: <a href="${data.session_path}" style="color: var(--primary); text-decoration: underline;">${data.session_path}</a>`);
        } else {
            // Session doesn't exist, proceed to fetch data from thesession.org
            fetchSessionData(sessionId);
        }
    })
    .catch(error => {
        showLoading(false);
        console.error('Error:', error);
        showError('Error checking existing session. Please try again.');
    });
}

function searchSessions(query) {
    showLoading(true);
    hideSearchResults();
    
    fetch('/api/search-sessions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ query: query })
    })
    .then(response => response.json())
    .then(data => {
        showLoading(false);
        
        if (data.success) {
            if (data.results.length === 0) {
                showError(`No sessions found for "${query}". Try a different search term.`);
            } else {
                showSearchResults(data.results, query);
            }
        } else {
            showError(data.message || 'Failed to search sessions');
        }
    })
    .catch(error => {
        showLoading(false);
        console.error('Error:', error);
        showError('Error searching sessions. Please try again.');
    });
}

function showSearchResults(results, query) {
    const searchResults = document.getElementById('searchResults');
    const searchResultsList = document.getElementById('searchResultsList');
    
    // Clear previous results
    searchResultsList.innerHTML = '';
    
    // Add search results
    results.forEach(result => {
        const resultItem = document.createElement('div');
        resultItem.className = result.exists_in_db ? 'search-result-item existing' : 'search-result-item';
        
        let innerHTML = `<strong>${result.name}</strong><br>${result.display_text}`;
        if (result.exists_in_db) {
            innerHTML += `<div class="existing-indicator">Already in ceol.io</div>`;
        }
        resultItem.innerHTML = innerHTML;
        
        resultItem.addEventListener('click', () => {
            if (result.exists_in_db) {
                showExistingSessionModal(result.session_path, result.name);
            } else {
                hideSearchResults();
                checkExistingSession(result.id);
            }
        });
        searchResultsList.appendChild(resultItem);
    });
    
    searchResults.style.display = 'block';
}

function hideSearchResults() {
    document.getElementById('searchResults').style.display = 'none';
}

function fetchSessionData(sessionId) {
    showLoading(true);
    
    fetch('/api/fetch-session-data', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ session_id: sessionId })
    })
    .then(response => response.json())
    .then(data => {
        showLoading(false);
        
        if (data.success) {
            populateModal(data.session_data);
        } else {
            showError(data.message || 'Failed to fetch session data');
        }
    })
    .catch(error => {
        showLoading(false);
        console.error('Error:', error);
        showError('Error fetching session data. Please try again.');
    });
}

function populateModal(sessionData) {
    // Populate the modal fields with the fetched data (page-specific business logic)
    document.getElementById('thesessionId').value = sessionData.id || '';
    document.getElementById('sessionName').value = sessionData.name || '';
    document.getElementById('sessionPath').value = generatePath(sessionData.city || '', sessionData.name || '');
    document.getElementById('locationName').value = sessionData.location_name || '';
    document.getElementById('locationPhone').value = sessionData.location_phone || '';
    document.getElementById('locationWebsite').value = sessionData.location_website || '';
    document.getElementById('cityName').value = sessionData.city || '';
    document.getElementById('stateName').value = sessionData.state || '';
    document.getElementById('countryName').value = sessionData.country || '';
    document.getElementById('inceptionDate').value = sessionData.inception_date || '';

    // Set timezone based on country and state
    const country = (sessionData.country || '').toLowerCase();
    const state = (sessionData.state || '').toLowerCase();
    let defaultTimezone = 'America/Chicago'; // Default

    if (country === 'ireland') {
        defaultTimezone = 'Europe/Dublin';
    } else if (country === 'united kingdom' || country === 'uk' || country === 'england' || country === 'scotland' || country === 'wales') {
        defaultTimezone = 'Europe/London';
    } else if (country === 'united states' || country === 'usa' || country === 'us') {
        // US state to timezone mapping (using primary timezone for split states)
        const stateTimezones = {
            // Eastern Time
            'connecticut': 'America/New_York', 'ct': 'America/New_York',
            'delaware': 'America/New_York', 'de': 'America/New_York',
            'florida': 'America/New_York', 'fl': 'America/New_York',
            'georgia': 'America/New_York', 'ga': 'America/New_York',
            'indiana': 'America/New_York', 'in': 'America/New_York',
            'kentucky': 'America/New_York', 'ky': 'America/New_York',
            'maine': 'America/New_York', 'me': 'America/New_York',
            'maryland': 'America/New_York', 'md': 'America/New_York',
            'massachusetts': 'America/New_York', 'ma': 'America/New_York',
            'michigan': 'America/New_York', 'mi': 'America/New_York',
            'new hampshire': 'America/New_York', 'nh': 'America/New_York',
            'new jersey': 'America/New_York', 'nj': 'America/New_York',
            'new york': 'America/New_York', 'ny': 'America/New_York',
            'north carolina': 'America/New_York', 'nc': 'America/New_York',
            'ohio': 'America/New_York', 'oh': 'America/New_York',
            'pennsylvania': 'America/New_York', 'pa': 'America/New_York',
            'rhode island': 'America/New_York', 'ri': 'America/New_York',
            'south carolina': 'America/New_York', 'sc': 'America/New_York',
            'tennessee': 'America/New_York', 'tn': 'America/New_York',
            'vermont': 'America/New_York', 'vt': 'America/New_York',
            'virginia': 'America/New_York', 'va': 'America/New_York',
            'west virginia': 'America/New_York', 'wv': 'America/New_York',
            'district of columbia': 'America/New_York', 'dc': 'America/New_York', 'washington dc': 'America/New_York',
            // Central Time
            'alabama': 'America/Chicago', 'al': 'America/Chicago',
            'arkansas': 'America/Chicago', 'ar': 'America/Chicago',
            'illinois': 'America/Chicago', 'il': 'America/Chicago',
            'iowa': 'America/Chicago', 'ia': 'America/Chicago',
            'kansas': 'America/Chicago', 'ks': 'America/Chicago',
            'louisiana': 'America/Chicago', 'la': 'America/Chicago',
            'minnesota': 'America/Chicago', 'mn': 'America/Chicago',
            'mississippi': 'America/Chicago', 'ms': 'America/Chicago',
            'missouri': 'America/Chicago', 'mo': 'America/Chicago',
            'nebraska': 'America/Chicago', 'ne': 'America/Chicago',
            'north dakota': 'America/Chicago', 'nd': 'America/Chicago',
            'oklahoma': 'America/Chicago', 'ok': 'America/Chicago',
            'south dakota': 'America/Chicago', 'sd': 'America/Chicago',
            'texas': 'America/Chicago', 'tx': 'America/Chicago',
            'wisconsin': 'America/Chicago', 'wi': 'America/Chicago',
            // Mountain Time
            'arizona': 'America/Phoenix', 'az': 'America/Phoenix', // No DST
            'colorado': 'America/Denver', 'co': 'America/Denver',
            'idaho': 'America/Denver', 'id': 'America/Denver',
            'montana': 'America/Denver', 'mt': 'America/Denver',
            'new mexico': 'America/Denver', 'nm': 'America/Denver',
            'utah': 'America/Denver', 'ut': 'America/Denver',
            'wyoming': 'America/Denver', 'wy': 'America/Denver',
            // Pacific Time
            'california': 'America/Los_Angeles', 'ca': 'America/Los_Angeles',
            'nevada': 'America/Los_Angeles', 'nv': 'America/Los_Angeles',
            'oregon': 'America/Los_Angeles', 'or': 'America/Los_Angeles',
            'washington': 'America/Los_Angeles', 'wa': 'America/Los_Angeles',
            // Alaska & Hawaii
            'alaska': 'America/Anchorage', 'ak': 'America/Anchorage',
            'hawaii': 'Pacific/Honolulu', 'hi': 'Pacific/Honolulu',
        };
        defaultTimezone = stateTimezones[state] || 'America/Chicago';
    }
    document.getElementById('timezone').value = defaultTimezone;

    // Parse and set recurrence from thesession.org data
    resetRecurrenceUI();
    const unparsedDiv = document.getElementById('recurrence-unparsed');
    unparsedDiv.style.display = 'none';
    unparsedDiv.textContent = '';

    if (sessionData.recurrence || sessionData.comments) {
        const parsed = parseTheSessionRecurrence(sessionData.recurrence, sessionData.comments);
        if (parsed) {
            setRecurrenceFromSchedule(parsed);
        } else if (sessionData.recurrence) {
            // Show the unparsed text so user knows what was in thesession.org
            const recurrenceText = Array.isArray(sessionData.recurrence)
                ? sessionData.recurrence.join(' ')
                : sessionData.recurrence;
            unparsedDiv.textContent = `Couldn't parse schedule from: "${recurrenceText}"`;
            unparsedDiv.style.display = 'block';
        }
    }
    updateRecurrenceSummary();

    // Show the modal using ModalManager (without autofocus)
    ModalManager.showModal('sessionModal', { autoFocus: false });
}

// ============ Recurrence Functions ============

function parseTheSessionRecurrence(text, comments) {
    // Parse thesession.org schedule text into our format
    // Common formats: "Every Tuesday @ 8pm", "Weekly on Thursdays", "First and third Mondays", or just "Tuesday"
    // Also checks comments for additional schedule details

    // Day patterns to look for (longer patterns first to avoid substring issues)
    const dayPatterns = [
        ['wednesday', 'wednesday'],
        ['thursdays', 'thursday'],
        ['thursday', 'thursday'],
        ['saturdays', 'saturday'],
        ['saturday', 'saturday'],
        ['tuesdays', 'tuesday'],
        ['tuesday', 'tuesday'],
        ['sundays', 'sunday'],
        ['sunday', 'sunday'],
        ['mondays', 'monday'],
        ['monday', 'monday'],
        ['fridays', 'friday'],
        ['friday', 'friday'],
        // Abbreviations (check after full names)
        ['thurs', 'thursday'],
        ['thur', 'thursday'],
        ['tues', 'tuesday'],
        ['wed', 'wednesday'],
        ['thu', 'thursday'],
        ['tue', 'tuesday'],
        ['mon', 'monday'],
        ['fri', 'friday'],
        ['sat', 'saturday'],
        ['sun', 'sunday']
    ];

    // Helper to find weekday in text
    function findWeekday(str) {
        const lower = str.toLowerCase();
        for (const [pattern, day] of dayPatterns) {
            if (lower.indexOf(pattern) !== -1) {
                return day;
            }
        }
        return null;
    }

    // Helper to parse time from text
    function parseTime(str) {
        // Match patterns like "8pm", "7:30pm", "2:00-4:00 pm", "7pm to 9pm", "from 8pm", "@ 8pm"
        // Pattern for "7pm to 9pm" or "7:00pm - 9:00pm" (am/pm after each time)
        const timeRangeWithBothAmPm = /(\d{1,2})(?::(\d{2}))?\s*(am|pm)\s*(?:-|to|–|until)\s*(\d{1,2})(?::(\d{2}))?\s*(am|pm)/i;
        // Pattern for "7 to 9pm" or "2:00-4:00 pm" (am/pm only at end)
        const timeRangeEndAmPm = /(\d{1,2})(?::(\d{2}))?\s*(?:-|to|–|until)\s*(\d{1,2})(?::(\d{2}))?\s*(am|pm)/i;
        const singleTimePattern = /(?:@|at|from|starts?|begins?)?\s*(\d{1,2})(?::(\d{2}))?\s*(am|pm)/i;

        let startTime = null;
        let endTime = null;

        // Try to match time range with am/pm on both times first (e.g., "7pm to 9pm")
        let rangeMatch = str.match(timeRangeWithBothAmPm);
        if (rangeMatch) {
            let startHours = parseInt(rangeMatch[1]);
            const startMins = rangeMatch[2] || '00';
            const startAmPm = rangeMatch[3]?.toLowerCase();
            let endHours = parseInt(rangeMatch[4]);
            const endMins = rangeMatch[5] || '00';
            const endAmPm = rangeMatch[6]?.toLowerCase();

            // Apply am/pm to each time
            if (startAmPm === 'pm' && startHours < 12) startHours += 12;
            if (startAmPm === 'am' && startHours === 12) startHours = 0;
            if (endAmPm === 'pm' && endHours < 12) endHours += 12;
            if (endAmPm === 'am' && endHours === 12) endHours = 0;

            startTime = `${startHours.toString().padStart(2, '0')}:${startMins}`;
            endTime = `${endHours.toString().padStart(2, '0')}:${endMins}`;
        } else {
            // Try range with am/pm only at end (e.g., "7 to 9pm")
            rangeMatch = str.match(timeRangeEndAmPm);
            if (rangeMatch) {
                let startHours = parseInt(rangeMatch[1]);
                const startMins = rangeMatch[2] || '00';
                let endHours = parseInt(rangeMatch[3]);
                const endMins = rangeMatch[4] || '00';
                const ampm = rangeMatch[5]?.toLowerCase();

                // Apply am/pm to both times intelligently
                if (ampm === 'pm') {
                    if (endHours < 12) endHours += 12;
                    // If start is less than end and end is PM, start is probably PM too
                    if (startHours < 12 && startHours <= endHours - 12) startHours += 12;
                } else if (ampm === 'am') {
                    if (startHours === 12) startHours = 0;
                    if (endHours === 12) endHours = 0;
                }

                startTime = `${startHours.toString().padStart(2, '0')}:${startMins}`;
                endTime = `${endHours.toString().padStart(2, '0')}:${endMins}`;
            } else {
                // Try single time
                const singleMatch = str.match(singleTimePattern);
                if (singleMatch) {
                    let hours = parseInt(singleMatch[1]);
                    const mins = singleMatch[2] || '00';
                    const ampm = singleMatch[3]?.toLowerCase();

                    if (ampm === 'pm' && hours < 12) hours += 12;
                    if (ampm === 'am' && hours === 12) hours = 0;

                    startTime = `${hours.toString().padStart(2, '0')}:${mins}`;
                    // Estimate end time as 3 hours after start
                    const endHours = (hours + 3) % 24;
                    endTime = `${endHours.toString().padStart(2, '0')}:${mins}`;
                }
            }
        }

        return { startTime, endTime };
    }

    // Helper to parse nth weekday patterns
    function parseNthPatterns(str) {
        const lower = str.toLowerCase();
        const nthMap = {
            'first': 1, '1st': 1,
            'second': 2, '2nd': 2,
            'third': 3, '3rd': 3,
            'fourth': 4, '4th': 4,
            'last': -1
        };

        const which = [];
        for (const [pattern, value] of Object.entries(nthMap)) {
            // Look for "every first", "first and third", "1st sunday", etc.
            const regex = new RegExp(`(every\\s+)?${pattern}\\b`, 'i');
            if (regex.test(lower)) {
                if (!which.includes(value)) which.push(value);
            }
        }
        return which;
    }

    // Helper to check for bi-weekly
    function isBiWeekly(str) {
        const lower = str.toLowerCase();
        return lower.includes('every other') || lower.includes('bi-weekly') || lower.includes('biweekly');
    }

    // Normalize input text
    let scheduleText = '';
    if (text) {
        if (Array.isArray(text)) {
            scheduleText = text.join(' ');
        } else if (typeof text === 'string') {
            scheduleText = text;
        }
    }

    // First, try to parse from the schedule field
    let weekday = findWeekday(scheduleText);
    let timeInfo = parseTime(scheduleText);
    let which = parseNthPatterns(scheduleText);
    let biWeekly = isBiWeekly(scheduleText);

    // If we have comments and need more info, search them
    if (comments && Array.isArray(comments) && comments.length > 0) {
        // First pass: find the most recent comment that mentions a weekday
        for (const comment of comments) {
            const content = comment.content || '';
            const commentWeekday = findWeekday(content);

            if (commentWeekday) {
                // Use comment weekday if we don't have one
                if (!weekday) {
                    weekday = commentWeekday;
                }

                // Only use this comment's details if weekday matches (or we didn't have one)
                if (commentWeekday === weekday || !findWeekday(scheduleText)) {
                    // Get time info from comment if we don't have it
                    if (!timeInfo.startTime) {
                        timeInfo = parseTime(content);
                    }

                    // Get nth patterns from comment if we don't have them
                    if (which.length === 0) {
                        which = parseNthPatterns(content);
                    }

                    // Check bi-weekly
                    if (!biWeekly) {
                        biWeekly = isBiWeekly(content);
                    }
                }

                // Stop after finding the first (most recent) comment with a weekday
                break;
            }
        }

        // Second pass: if we still need time info, find any comment with time
        if (!timeInfo.startTime) {
            for (const comment of comments) {
                const content = comment.content || '';
                const commentTimeInfo = parseTime(content);
                if (commentTimeInfo.startTime) {
                    timeInfo = commentTimeInfo;
                    break;
                }
            }
        }

        // Third pass: if we still need nth patterns, find any comment with them
        if (which.length === 0) {
            for (const comment of comments) {
                const content = comment.content || '';
                const commentWhich = parseNthPatterns(content);
                if (commentWhich.length > 0) {
                    which = commentWhich;
                    break;
                }
            }
        }
    }

    // If we still don't have a weekday, we can't create a schedule
    if (!weekday) return null;

    // Default times if not found
    const startTime = timeInfo.startTime || '19:00';
    const endTime = timeInfo.endTime || '22:00';

    // Determine pattern type
    if (which.length > 0) {
        return {
            type: 'monthly_nth_weekday',
            weekday: weekday,
            which: which,
            start_time: startTime,
            end_time: endTime
        };
    } else {
        return {
            type: 'weekly',
            weekday: weekday,
            every_n_weeks: biWeekly ? 2 : 1,
            start_time: startTime,
            end_time: endTime
        };
    }
}

function resetRecurrenceUI() {
    // Reset all recurrence controls to default state
    document.getElementById('recurrence-type').value = '';
    document.getElementById('recurrence-options').style.display = 'none';
    document.getElementById('weekly-options').style.display = 'none';
    document.getElementById('monthly-options').style.display = 'none';
    document.getElementById('recurrence-frequency').value = '1';
    document.getElementById('recurrence-start').value = '19:00';
    document.getElementById('recurrence-end').value = '22:00';

    // Clear weekday selection
    document.querySelectorAll('.weekday-btn').forEach(btn => btn.classList.remove('active'));

    // Clear nth checkboxes
    document.querySelectorAll('.nth-checkbox').forEach(cb => cb.checked = false);

    // Collapse the edit section
    document.getElementById('recurrence-edit').style.display = 'none';
    document.getElementById('recurrence-section').classList.remove('expanded');

    // Clear hidden field
    document.getElementById('recurrenceJSON').value = '';
}

function setRecurrenceFromSchedule(schedule) {
    // Set UI from a schedule object
    document.getElementById('recurrence-type').value = schedule.type;
    updateRecurrenceTypeUI();

    // Set weekday
    if (schedule.weekday) {
        selectWeekday(schedule.weekday);
    }

    // Set times
    if (schedule.start_time) {
        document.getElementById('recurrence-start').value = schedule.start_time;
    }
    if (schedule.end_time) {
        document.getElementById('recurrence-end').value = schedule.end_time;
    }

    // Set type-specific options
    if (schedule.type === 'weekly' && schedule.every_n_weeks) {
        document.getElementById('recurrence-frequency').value = schedule.every_n_weeks.toString();
    } else if (schedule.type === 'monthly_nth_weekday' && schedule.which) {
        schedule.which.forEach(n => {
            const checkbox = document.querySelector(`.nth-checkbox[value="${n}"]`);
            if (checkbox) checkbox.checked = true;
        });
    }
}

function toggleRecurrenceEdit() {
    const editSection = document.getElementById('recurrence-edit');
    const section = document.getElementById('recurrence-section');

    if (editSection.style.display === 'none') {
        editSection.style.display = 'block';
        section.classList.add('expanded');
    } else {
        editSection.style.display = 'none';
        section.classList.remove('expanded');
        updateRecurrenceSummary();
    }
}

function updateRecurrenceTypeUI() {
    const type = document.getElementById('recurrence-type').value;
    const optionsDiv = document.getElementById('recurrence-options');
    const weeklyDiv = document.getElementById('weekly-options');
    const monthlyDiv = document.getElementById('monthly-options');

    if (!type) {
        optionsDiv.style.display = 'none';
    } else {
        optionsDiv.style.display = 'block';
        weeklyDiv.style.display = type === 'weekly' ? 'block' : 'none';
        monthlyDiv.style.display = type === 'monthly_nth_weekday' ? 'block' : 'none';
    }

    updateRecurrenceSummary();
}

function selectWeekday(day) {
    // Deselect all
    document.querySelectorAll('.weekday-btn').forEach(btn => btn.classList.remove('active'));
    // Select the clicked one
    const btn = document.querySelector(`.weekday-btn[data-weekday="${day}"]`);
    if (btn) btn.classList.add('active');
    updateRecurrenceSummary();
}

function getSelectedWeekday() {
    const activeBtn = document.querySelector('.weekday-btn.active');
    return activeBtn ? activeBtn.dataset.weekday : null;
}

function updateRecurrenceSummary() {
    const type = document.getElementById('recurrence-type').value;
    const summaryText = document.getElementById('recurrence-summary-text');

    if (!type) {
        summaryText.textContent = 'No schedule set';
        document.getElementById('recurrenceJSON').value = '';
        return;
    }

    const weekday = getSelectedWeekday();
    if (!weekday) {
        summaryText.textContent = 'Select a day...';
        document.getElementById('recurrenceJSON').value = '';
        return;
    }

    const startTime = document.getElementById('recurrence-start').value;
    const endTime = document.getElementById('recurrence-end').value;

    // Format times for display
    const formatTime = (time) => {
        const [hours, mins] = time.split(':');
        let h = parseInt(hours);
        const ampm = h >= 12 ? 'pm' : 'am';
        h = h % 12 || 12;
        return mins === '00' ? `${h}${ampm}` : `${h}:${mins}${ampm}`;
    };

    const dayCapitalized = weekday.charAt(0).toUpperCase() + weekday.slice(1);
    let summary = '';
    let schedule = {
        type: type,
        weekday: weekday,
        start_time: startTime,
        end_time: endTime
    };

    if (type === 'weekly') {
        const frequency = parseInt(document.getElementById('recurrence-frequency').value);
        schedule.every_n_weeks = frequency;

        if (frequency === 1) {
            summary = `${dayCapitalized}s`;
        } else if (frequency === 2) {
            summary = `Every other ${dayCapitalized}`;
        } else {
            summary = `Every ${frequency} weeks on ${dayCapitalized}`;
        }
    } else if (type === 'monthly_nth_weekday') {
        const checkedBoxes = document.querySelectorAll('.nth-checkbox:checked');
        const which = Array.from(checkedBoxes).map(cb => parseInt(cb.value));
        schedule.which = which;

        if (which.length === 0) {
            summaryText.textContent = 'Select which occurrences...';
            document.getElementById('recurrenceJSON').value = '';
            return;
        }

        const ordinals = { 1: '1st', 2: '2nd', 3: '3rd', 4: '4th', '-1': 'last' };
        const whichStr = which.map(n => ordinals[n]).join(' & ');
        summary = `${whichStr} ${dayCapitalized}`;
    }

    summary += ` from ${formatTime(startTime)}-${formatTime(endTime)}`;
    summaryText.textContent = summary;

    // Store as JSON
    const recurrenceJSON = JSON.stringify({ schedules: [schedule] });
    document.getElementById('recurrenceJSON').value = recurrenceJSON;
}

function closeSessionModal() {
    ModalManager.hideModal('sessionModal');
}

function openEmptySessionModal() {
    // Clear all form fields
    document.getElementById('thesessionId').value = '';
    document.getElementById('sessionName').value = '';
    document.getElementById('sessionPath').value = '';
    document.getElementById('locationName').value = '';
    document.getElementById('locationPhone').value = '';
    document.getElementById('locationWebsite').value = '';
    document.getElementById('cityName').value = '';
    document.getElementById('stateName').value = '';
    document.getElementById('countryName').value = '';
    document.getElementById('inceptionDate').value = '';
    document.getElementById('timezone').value = 'America/Chicago'; // Default

    // Reset recurrence
    resetRecurrenceUI();
    const unparsedDiv = document.getElementById('recurrence-unparsed');
    unparsedDiv.style.display = 'none';
    unparsedDiv.textContent = '';
    updateRecurrenceSummary();

    // Show the modal
    ModalManager.showModal('sessionModal', { autoFocus: false });
}

function showExistingSessionModal(sessionPath, sessionName) {
    // Update modal content (page-specific business logic)
    document.getElementById('existingSessionMessage').textContent = 
        `"${sessionName}" is already in ceol.io; click "Go" to view it.`;
    
    // Store the session path for the Go button
    document.getElementById('goToExistingBtn').setAttribute('data-session-path', sessionPath);
    
    // Show modal using ModalManager
    ModalManager.showModal('existingSessionModal');
}

function closeExistingSessionModal() {
    ModalManager.hideModal('existingSessionModal');
}

function generatePath(city, sessionName) {
    // Generate URL-friendly components
    const cleanCity = city.toLowerCase()
        .replace(/[^a-z0-9\s-]/g, '') // Remove special characters
        .replace(/\s+/g, '-') // Replace spaces with hyphens
        .replace(/-+/g, '-') // Replace multiple hyphens with single
        .replace(/^-|-$/g, ''); // Remove leading/trailing hyphens
    
    const cleanSessionName = sessionName.toLowerCase()
        .replace(/[^a-z0-9\s-]/g, '') // Remove special characters
        .replace(/\s+/g, '-') // Replace spaces with hyphens
        .replace(/-+/g, '-') // Replace multiple hyphens with single
        .replace(/^-|-$/g, ''); // Remove leading/trailing hyphens
    
    // Combine as city/session-name
    if (cleanCity && cleanSessionName) {
        return `${cleanCity}/${cleanSessionName}`;
    } else if (cleanSessionName) {
        return cleanSessionName;
    } else {
        return cleanCity;
    }
}

// Handle save button click
document.getElementById('saveSessionBtn').addEventListener('click', function() {
    const recurrenceJSON = document.getElementById('recurrenceJSON').value;
    const addCurrentUser = document.getElementById('addCurrentUser').checked;
    const formData = {
        thesession_id: document.getElementById('thesessionId').value,
        name: document.getElementById('sessionName').value.trim(),
        path: document.getElementById('sessionPath').value.trim(),
        location_name: document.getElementById('locationName').value.trim() || null,
        location_phone: document.getElementById('locationPhone').value.trim() || null,
        location_website: document.getElementById('locationWebsite').value.trim() || null,
        city: document.getElementById('cityName').value.trim(),
        state: document.getElementById('stateName').value.trim(),
        country: document.getElementById('countryName').value.trim(),
        inception_date: document.getElementById('inceptionDate').value || null,
        timezone: document.getElementById('timezone').value,
        recurrence: recurrenceJSON || null,
        add_current_user: addCurrentUser,
        add_current_user_role: addCurrentUser ? document.getElementById('addCurrentUserRole').value : null
    };

    // Validate required fields
    const requiredFields = [
        { id: 'sessionName', value: formData.name, label: 'Name' },
        { id: 'sessionPath', value: formData.path, label: 'Path' },
        { id: 'cityName', value: formData.city, label: 'City' },
        { id: 'stateName', value: formData.state, label: 'State' },
        { id: 'countryName', value: formData.country, label: 'Country' }
    ];

    // Clear previous validation states
    requiredFields.forEach(field => {
        document.getElementById(field.id).classList.remove('is-invalid');
    });

    // Check for missing fields
    const missingFields = requiredFields.filter(field => !field.value);

    if (missingFields.length > 0) {
        // Highlight missing fields
        missingFields.forEach(field => {
            document.getElementById(field.id).classList.add('is-invalid');
        });

        // Scroll to first invalid field
        const firstInvalid = document.getElementById(missingFields[0].id);
        firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
        firstInvalid.focus();

        const missingNames = missingFields.map(f => f.label).join(', ');
        showError(`Please fill in required fields: ${missingNames}`);
        return;
    }
    
    // Save the session
    fetch('/api/add-session', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal and redirect to the new session
            closeSessionModal();
            window.location.href = `/sessions/${formData.path}`;
        } else {
            showError(data.message || 'Failed to save session');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('Error saving session. Please try again.');
    });
});

// Close modal on escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeSessionModal();
        closeExistingSessionModal();
    }
});

// Handle "Search again" button
document.getElementById('newSearchBtn').addEventListener('click', function() {
    hideSearchResults();
    document.getElementById('sessionUrl').focus();
});

// Handle "Go" button in existing session modal
document.getElementById('goToExistingBtn').addEventListener('click', function() {
    const sessionPath = this.getAttribute('data-session-path');
    if (sessionPath) {
        window.location.href = sessionPath;
    }
});

// Handle "Cancel" button in existing session modal (returns to search results)
document.querySelector('#existingSessionModal .btn-secondary').addEventListener('click', function() {
    closeExistingSessionModal();
    // Search results should still be visible when modal closes
});

// Clear validation error when user starts typing in required fields
['sessionName', 'sessionPath', 'cityName', 'stateName', 'countryName'].forEach(fieldId => {
    document.getElementById(fieldId).addEventListener('input', function() {
        this.classList.remove('is-invalid');
    });
});
</script>
{% endblock %}