{% extends "base.html" %}

{% block title %}{{ person.first_name }} {{ person.last_name }} - {{ session.name }}{% endblock %}

{% block content %}
<div class="docs-content-inner">
    <div class="container">
        <article class="docs-article" id="section-1">
            <header class="docs-header">
                <h1 class="docs-heading">{{ person.first_name }} {{ person.last_name }}</h1>
                <section class="docs-intro">
                    <p>Player details for <strong>{{ session.name }}</strong>. 
                    {% if from_attendance and session_instance_date and session_instance_id %}
                        <a href="/sessions/{{ session_path }}/{{ session_instance_date }}#players">← Back to session on {{ session_instance_date }}</a>
                    {% else %}
                        <a href="/admin/sessions/{{ session_path }}/players">← Back to players list</a>
                    {% endif %}
                    </p>
                </section>
            </header>
            
            <!-- Person Information Section -->
            <section class="docs-section" id="person-info">
                <h2 class="section-heading">Person Information</h2>
                <div class="card">
                    <div class="card-body">
                        <form id="person-details-form">
                            <input type="hidden" id="person-id" value="{{ person.person_id }}">
                            <input type="hidden" id="session-path" value="{{ session_path }}">
                            <input type="hidden" id="has-user-account" value="{{ 'true' if person.username else 'false' }}">
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <dl class="row">
                                        <dt class="col-sm-4">Name:</dt>
                                        <dd class="col-sm-8">
                                            {% if person.username %}
                                                {{ person.first_name }} {{ person.last_name }}
                                            {% else %}
                                                <input type="text" class="form-control form-control-sm d-inline-block w-auto me-1" id="first-name" value="{{ person.first_name }}" style="width: 120px !important;">
                                                <input type="text" class="form-control form-control-sm d-inline-block w-auto" id="last-name" value="{{ person.last_name }}" style="width: 120px !important;">
                                            {% endif %}
                                        </dd>
                                        
                                        <dt class="col-sm-4">Email:</dt>
                                        <dd class="col-sm-8">
                                            {% if person.username %}
                                                {{ person.email or 'Not provided' }}
                                            {% else %}
                                                <input type="email" class="form-control form-control-sm" id="email" value="{{ person.email or '' }}" placeholder="Not provided">
                                            {% endif %}
                                        </dd>
                                        
                                        <dt class="col-sm-4">SMS Number:</dt>
                                        <dd class="col-sm-8">
                                            {% if person.username %}
                                                {{ person.sms_number or 'Not provided' }}
                                            {% else %}
                                                <input type="tel" class="form-control form-control-sm" id="sms-number" value="{{ person.sms_number or '' }}" placeholder="Not provided">
                                            {% endif %}
                                        </dd>
                                    </dl>
                                </div>
                                <div class="col-md-6">
                                    <dl class="row">
                                        <dt class="col-sm-4">City:</dt>
                                        <dd class="col-sm-8">
                                            {% if person.username %}
                                                {{ person.city or 'Not provided' }}
                                            {% else %}
                                                <input type="text" class="form-control form-control-sm" id="city" value="{{ person.city or '' }}" placeholder="Not provided">
                                            {% endif %}
                                        </dd>
                                        
                                        <dt class="col-sm-4">State:</dt>
                                        <dd class="col-sm-8">
                                            {% if person.username %}
                                                {{ person.state or 'Not provided' }}
                                            {% else %}
                                                <input type="text" class="form-control form-control-sm" id="state" value="{{ person.state or '' }}" placeholder="Not provided">
                                            {% endif %}
                                        </dd>
                                        
                                        <dt class="col-sm-4">Country:</dt>
                                        <dd class="col-sm-8">
                                            {% if person.username %}
                                                {{ person.country or 'Not provided' }}
                                            {% else %}
                                                <input type="text" class="form-control form-control-sm" id="country" value="{{ person.country or '' }}" placeholder="Not provided">
                                            {% endif %}
                                        </dd>
                                    </dl>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-12">
                                    <dl class="row">
                                        <dt class="col-sm-2">TheSession.org ID:</dt>
                                        <dd class="col-sm-10">
                                            {% if person.username %}
                                                {% if person.thesession_user_id %}
                                                    <a href="https://thesession.org/members/{{ person.thesession_user_id }}" target="_blank">
                                                        {{ person.thesession_user_id }}
                                                    </a>
                                                {% else %}
                                                    Not provided
                                                {% endif %}
                                            {% else %}
                                                <input type="number" class="form-control form-control-sm d-inline-block w-auto" id="thesession-user-id" value="{{ person.thesession_user_id or '' }}" placeholder="Not provided" style="width: 150px !important;">
                                                {% if person.thesession_user_id %}
                                                    <a href="https://thesession.org/members/{{ person.thesession_user_id }}" target="_blank" class="ms-2">View Profile</a>
                                                {% endif %}
                                            {% endif %}
                                        </dd>
                                    </dl>
                                </div>
                            </div>
                            
                            {% if person.username %}
                            <div class="row">
                                <div class="col-12">
                                    <dl class="row">
                                        <dt class="col-sm-2">User Account:</dt>
                                        <dd class="col-sm-10">
                                            <span class="badge bg-info">{{ person.username }}</span>
                                            {% if person.is_system_admin %}
                                            <span class="badge bg-warning">System Admin</span>
                                            {% endif %}
                                        </dd>
                                    </dl>
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if not person.username %}
                            <div class="row mt-3">
                                <div class="col-12">
                                    <button type="button" id="save-person-details" class="btn btn-primary btn-sm">Save Changes</button>
                                    <span class="text-muted ms-2 small">Note: This person can edit these details themselves if they create an account</span>
                                </div>
                            </div>
                            {% endif %}
                            
                            <div id="person-save-status" class="mt-3" style="display: none;"></div>
                        </form>
                    </div>
                </div>
            </section>
            
            <!-- Session Status Section -->
            <section class="docs-section" id="session-status">
                <h2 class="section-heading">Session Status</h2>
                <div class="card">
                    <div class="card-body">
                        <form id="session-status-form">
                            <input type="hidden" id="person-id" value="{{ person.person_id }}">
                            <input type="hidden" id="session-path" value="{{ session_path }}">
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="is-regular" {{ 'checked' if person.is_regular }}>
                                        <label class="form-check-label" for="is-regular">
                                            <strong>Regular Player</strong>
                                        </label>
                                        <div class="form-text">Mark as a regular attendee of this session</div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="status-badges">
                                        {% if person.is_admin %}
                                        <span class="badge bg-primary">Session Admin</span>
                                        {% endif %}
                                        
                                        {% if person.gets_email_reminder %}
                                        <span class="badge bg-success">Email Reminders</span>
                                        {% endif %}
                                        
                                        {% if person.gets_email_followup %}
                                        <span class="badge bg-info">Email Followups</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <div id="save-status" class="mt-3" style="display: none;"></div>
                        </form>
                    </div>
                </div>
            </section>
            
            <!-- Instruments Section -->
            <section class="docs-section" id="instruments">
                <h2 class="section-heading">Instruments</h2>
                <div class="card">
                    <div class="card-body">
                        {% if person.username %}
                            <!-- Person has user account - read only -->
                            <div class="row">
                                <div class="col-12">
                                    {% if person.instruments %}
                                        <div class="instrument-tags">
                                            {% for instrument in person.instruments %}
                                                <span class="badge bg-secondary me-1 mb-1">{{ instrument|title }}</span>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <p class="text-muted">No instruments specified.</p>
                                    {% endif %}
                                    <small class="text-muted">This person can edit their own instruments by logging into their account.</small>
                                </div>
                            </div>
                        {% else %}
                            <!-- Person doesn't have user account - editable -->
                            <div class="row">
                                <div class="col-12">
                                    <form id="instruments-form">
                                        <div class="mb-3">
                                            <label class="form-label"><strong>Instruments</strong></label>
                                            <div id="instruments-checkboxes" class="row">
                                                <!-- Standard instruments (matching attendance.js list, alphabetical) -->
                                                {% for instrument in ['banjo', 'bodhrán', 'bouzouki', 'button accordion', 'concertina', 'fiddle', 'flute', 'guitar', 'harp', 'mandolin', 'piano', 'piano accordion', 'tin whistle', 'uilleann pipes'] %}
                                                <div class="col-md-4 col-sm-6 mb-2">
                                                    <div class="form-check">
                                                        <input class="form-check-input instrument-checkbox" type="checkbox" 
                                                               id="instrument-{{ loop.index }}" value="{{ instrument }}" 
                                                               {% if instrument in person.instruments %}checked{% endif %}>
                                                        <label class="form-check-label" for="instrument-{{ loop.index }}">
                                                            {{ instrument|title }}
                                                        </label>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        
                                        <!-- Custom instruments section -->
                                        <div class="mb-3">
                                            <label class="form-label"><strong>Other Instruments</strong></label>
                                            <div id="custom-instruments">
                                                {% for instrument in person.instruments %}
                                                    {% if instrument not in ['banjo', 'bodhrán', 'bouzouki', 'button accordion', 'concertina', 'fiddle', 'flute', 'guitar', 'harp', 'mandolin', 'piano', 'piano accordion', 'tin whistle', 'uilleann pipes'] %}
                                                        <div class="input-group mb-2 custom-instrument-row">
                                                            <input type="text" class="form-control custom-instrument" value="{{ instrument|title }}" placeholder="Enter instrument name">
                                                            <button class="btn btn-outline-danger remove-custom-instrument" type="button">Remove</button>
                                                        </div>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                            <button type="button" id="add-custom-instrument" class="btn btn-outline-primary btn-sm">Add Other Instrument</button>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-12">
                                                <button type="button" id="save-instruments" class="btn btn-primary btn-sm">Save Instruments</button>
                                            </div>
                                        </div>
                                        
                                        <div id="instruments-save-status" class="mt-3" style="display: none;"></div>
                                    </form>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </section>
            
            <!-- Sessions Attended Section -->
            <section class="docs-section" id="sessions-attended">
                <h2 class="section-heading">Sessions Attended</h2>
                <div class="card">
                    <div class="card-body">
                        {% if attendance_history %}
                        <p class="text-muted mb-3">{{ attendance_history|length }} session{{ 's' if attendance_history|length != 1 else '' }} attended</p>
                        
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Time</th>
                                        <th>Status</th>
                                        <th>Comments</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for attendance in attendance_history %}
                                    <tr>
                                        <td>
                                            <a href="/sessions/{{ session_path }}/{{ attendance.date }}" target="_blank">
                                                {{ attendance.date }}
                                            </a>
                                        </td>
                                        <td>
                                            {% if attendance.start_time and attendance.end_time %}
                                                {{ attendance.start_time }} - {{ attendance.end_time }}
                                            {% elif attendance.start_time %}
                                                From {{ attendance.start_time }}
                                            {% else %}
                                                <span class="text-muted">Not specified</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if attendance.is_cancelled %}
                                                <span class="badge bg-danger">Cancelled</span>
                                            {% else %}
                                                <span class="badge bg-success">Attended</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ attendance.comments or '' }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="alert alert-info">
                            No sessions attended found for this person at this session.
                        </div>
                        {% endif %}
                    </div>
                </div>
            </section>
            
            <!-- Danger Zone Section -->
            <section class="docs-section" id="danger-zone">
                <h2 class="section-heading text-danger">Danger Zone</h2>
                <div class="card border-danger">
                    <div class="card-body">
                        <h5 class="card-title text-danger">Remove Player from Session</h5>
                        <p class="card-text text-muted">
                            This will remove {{ person.first_name }} {{ person.last_name }} from the session "{{ session.name }}". 
                            {% if not person.username %}
                            If this person is not associated with any other sessions and has no user account, the person record will also be deleted permanently.
                            {% endif %}
                        </p>
                        <button type="button" class="btn btn-outline-danger" id="delete-player-btn">
                            <i class="fas fa-trash-alt me-1"></i>Delete Player From This Session
                        </button>
                    </div>
                </div>
            </section>
        </article>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="delete-player-modal" tabindex="-1" aria-labelledby="delete-player-modal-label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="delete-player-modal-label">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Are you sure?</strong></p>
                <p>This will permanently remove <strong>{{ person.first_name }} {{ person.last_name }}</strong> from the session "<strong>{{ session.name }}</strong>".</p>
                {% if not person.username %}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> Since this person has no user account and may not be associated with other sessions, their entire person record could be deleted permanently.
                </div>
                {% endif %}
                <p class="text-muted">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">
                    <i class="fas fa-trash-alt me-1"></i>Delete Player
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.status-badges .badge {
    margin-right: 0.5rem;
    margin-bottom: 0.25rem;
}

.form-check-label {
    font-weight: 500;
}

.section-heading {
    color: var(--primary);
    border-bottom: 2px solid var(--border-color);
    padding-bottom: 0.5rem;
    margin-bottom: 1.5rem;
}

.card {
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background-color: var(--bg-color);
    margin-bottom: 2rem;
}

.card-body {
    padding: 1.5rem;
}

dl.row dt {
    font-weight: 600;
    color: var(--text-color);
}

dl.row dd {
    color: var(--text-color);
}

.table th {
    background-color: var(--light);
    border-bottom: 2px solid var(--border-color);
    font-weight: 600;
}

.table td {
    border-bottom: 1px solid var(--hover-bg);
}

.alert-success {
    background-color: var(--success-bg, #d4edda);
    border-color: var(--success-border, #c3e6cb);
    color: var(--success-text, #155724);
}

.alert-danger {
    background-color: var(--danger-bg, #f8d7da);
    border-color: var(--danger-border, #f5c6cb);
    color: var(--danger-text, #721c24);
}

.alert-info {
    background-color: var(--info-bg, #d1ecf1);
    border-color: var(--info-border, #bee5eb);
    color: var(--info-text, #0c5460);
}

/* Dark mode alert colors */
@media (prefers-color-scheme: dark) {
    .alert-success {
        background-color: rgba(40, 167, 69, 0.2);
        border-color: rgba(40, 167, 69, 0.4);
        color: #9df5a5;
    }
    
    .alert-danger {
        background-color: rgba(220, 53, 69, 0.2);
        border-color: rgba(220, 53, 69, 0.4);
        color: #f5a5a5;
    }
    
    .alert-info {
        background-color: rgba(23, 162, 184, 0.2);
        border-color: rgba(23, 162, 184, 0.4);
        color: #a5e1f5;
    }
}

/* Mobile optimizations */
@media (max-width: 768px) {
    /* Remove docs-content padding completely - mobile only */
    body .docs-content {
        padding: 0.5rem !important;
    }
    
    /* Remove docs-article padding - mobile only */
    body .docs-article {
        padding: 0.5rem !important;
    }
    
    /* Reduce container padding to minimal - mobile only */
    body .docs-content-inner .container {
        padding-left: 0.5rem !important;
        padding-right: 0.5rem !important;
        padding-top: 0 !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
    }
    
    /* Make heading smaller - mobile only */
    body .docs-article .docs-heading {
        font-size: 1.75rem !important;
        margin-bottom: 1rem !important;
    }
    
    /* Reduce section padding - mobile only */
    body .docs-section {
        padding: 1rem 0 !important;
    }
    
    .card-body {
        padding: 1rem;
    }
    
    dl.row dt {
        margin-bottom: 0.25rem;
    }
    
    dl.row dd {
        margin-bottom: 1rem;
    }
    
    .status-badges {
        margin-top: 1rem;
    }
}

/* Modal backdrop and display fixes for non-Bootstrap JS usage */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1055;
    width: 100%;
    height: 100%;
    overflow-x: hidden;
    overflow-y: auto;
    background-color: rgba(0, 0, 0, 0.5);
    display: none;
}

.modal.show {
    display: flex !important;
    align-items: center;
    justify-content: center;
}

.modal-dialog {
    position: relative;
    margin: 1.75rem auto;
    pointer-events: none;
    max-width: 500px;
}

.modal.show .modal-dialog {
    pointer-events: auto;
}

.modal-open {
    overflow: hidden;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const isRegularCheckbox = document.getElementById('is-regular');
    const saveStatus = document.getElementById('save-status');
    const savePersonDetailsBtn = document.getElementById('save-person-details');
    const personSaveStatus = document.getElementById('person-save-status');
    
    // Handle regular status changes
    if (isRegularCheckbox) {
        isRegularCheckbox.addEventListener('change', function() {
            const personId = document.getElementById('person-id').value;
            const sessionPath = document.getElementById('session-path').value;
            const isRegular = this.checked;
            
            // Show loading state
            saveStatus.style.display = 'block';
            saveStatus.innerHTML = '<div class="alert alert-info">Saving...</div>';
            
            // Make API call to update regular status
            fetch(`/api/admin/sessions/${sessionPath}/players/${personId}/regular`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    is_regular: isRegular
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    saveStatus.innerHTML = '<div class="alert alert-success">Regular status updated successfully!</div>';
                    setTimeout(() => {
                        saveStatus.style.display = 'none';
                    }, 3000);
                } else {
                    throw new Error(data.error || 'Failed to update regular status');
                }
            })
            .catch(error => {
                console.error('Error updating regular status:', error);
                saveStatus.innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
                // Revert checkbox state
                this.checked = !isRegular;
            });
        });
    }
    
    // Handle instruments functionality
    const addCustomInstrumentBtn = document.getElementById('add-custom-instrument');
    const saveInstrumentsBtn = document.getElementById('save-instruments');
    const instrumentsSaveStatus = document.getElementById('instruments-save-status');
    
    if (addCustomInstrumentBtn) {
        addCustomInstrumentBtn.addEventListener('click', function() {
            const customInstrumentsDiv = document.getElementById('custom-instruments');
            const newRow = document.createElement('div');
            newRow.className = 'input-group mb-2 custom-instrument-row';
            newRow.innerHTML = `
                <input type="text" class="form-control custom-instrument" placeholder="Enter instrument name">
                <button class="btn btn-outline-danger remove-custom-instrument" type="button">Remove</button>
            `;
            customInstrumentsDiv.appendChild(newRow);
            
            // Add event listener to the remove button
            newRow.querySelector('.remove-custom-instrument').addEventListener('click', function() {
                newRow.remove();
            });
        });
        
        // Add event listeners to existing remove buttons
        document.querySelectorAll('.remove-custom-instrument').forEach(function(btn) {
            btn.addEventListener('click', function() {
                btn.closest('.custom-instrument-row').remove();
            });
        });
    }
    
    if (saveInstrumentsBtn) {
        saveInstrumentsBtn.addEventListener('click', function() {
            const personId = document.getElementById('person-id').value;
            
            // Collect checked standard instruments
            const instruments = [];
            document.querySelectorAll('.instrument-checkbox:checked').forEach(function(checkbox) {
                instruments.push(checkbox.value);
            });
            
            // Collect custom instruments
            document.querySelectorAll('.custom-instrument').forEach(function(input) {
                const value = input.value.trim();
                if (value && !instruments.includes(value.toLowerCase())) {
                    instruments.push(value.toLowerCase());
                }
            });
            
            // Show loading state
            instrumentsSaveStatus.style.display = 'block';
            instrumentsSaveStatus.innerHTML = '<div class="alert alert-info">Saving instruments...</div>';
            
            // Make API call to update instruments
            fetch(`/api/person/${personId}/instruments`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    instruments: instruments
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    instrumentsSaveStatus.innerHTML = '<div class="alert alert-success">Instruments updated successfully!</div>';
                    setTimeout(() => {
                        instrumentsSaveStatus.style.display = 'none';
                    }, 3000);
                } else {
                    throw new Error(data.message || 'Failed to update instruments');
                }
            })
            .catch(error => {
                console.error('Error updating instruments:', error);
                instrumentsSaveStatus.innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
            });
        });
    }
    
    // Handle person details save
    if (savePersonDetailsBtn) {
        savePersonDetailsBtn.addEventListener('click', function() {
            const personId = document.getElementById('person-id').value;
            const sessionPath = document.getElementById('session-path').value;
            const hasUserAccount = document.getElementById('has-user-account').value === 'true';
            
            // Collect form data
            const formData = {};
            
            if (!hasUserAccount) {
                // Only include editable fields for users without accounts
                const firstName = document.getElementById('first-name')?.value;
                const lastName = document.getElementById('last-name')?.value;
                const email = document.getElementById('email')?.value;
                const smsNumber = document.getElementById('sms-number')?.value;
                const city = document.getElementById('city')?.value;
                const state = document.getElementById('state')?.value;
                const country = document.getElementById('country')?.value;
                const thesessionUserId = document.getElementById('thesession-user-id')?.value;
                
                if (firstName) formData.first_name = firstName;
                if (lastName) formData.last_name = lastName;
                if (email) formData.email = email;
                if (smsNumber) formData.sms_number = smsNumber;
                if (city) formData.city = city;
                if (state) formData.state = state;
                if (country) formData.country = country;
                if (thesessionUserId) formData.thesession_user_id = parseInt(thesessionUserId);
            }
            
            // Always include regular status if checkbox exists
            if (isRegularCheckbox) {
                formData.is_regular = isRegularCheckbox.checked;
            }
            
            // Show loading state
            personSaveStatus.style.display = 'block';
            personSaveStatus.innerHTML = '<div class="alert alert-info">Saving...</div>';
            
            // Make API call to update person details
            fetch(`/api/admin/sessions/${sessionPath}/players/${personId}/details`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    personSaveStatus.innerHTML = '<div class="alert alert-success">Person details updated successfully!</div>';
                    setTimeout(() => {
                        personSaveStatus.style.display = 'none';
                    }, 3000);
                } else {
                    throw new Error(data.error || 'Failed to update person details');
                }
            })
            .catch(error => {
                console.error('Error updating person details:', error);
                personSaveStatus.innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
            });
        });
    }
    
    // Handle delete player functionality
    const deletePlayerBtn = document.getElementById('delete-player-btn');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    const deleteModal = document.getElementById('delete-player-modal');
    
    if (deletePlayerBtn) {
        deletePlayerBtn.addEventListener('click', function() {
            deleteModal.style.display = 'block';
            deleteModal.classList.add('show');
            document.body.classList.add('modal-open');
        });
    }
    
    // Handle modal close buttons
    const closeModalBtns = deleteModal.querySelectorAll('[data-bs-dismiss="modal"], .btn-close');
    closeModalBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            deleteModal.style.display = 'none';
            deleteModal.classList.remove('show');
            document.body.classList.remove('modal-open');
        });
    });
    
    if (confirmDeleteBtn) {
        confirmDeleteBtn.addEventListener('click', async function() {
            const personId = document.getElementById('person-id').value;
            const sessionPath = document.getElementById('session-path').value;
            
            // Disable button and show loading state
            confirmDeleteBtn.disabled = true;
            confirmDeleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Deleting...';
            
            try {
                const response = await fetch(`/api/admin/sessions/${sessionPath}/players/${personId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Show success message and redirect
                    deleteModal.style.display = 'none';
                    deleteModal.classList.remove('show');
                    document.body.classList.remove('modal-open');
                    showMessage('Player successfully removed from session', 'success');
                    
                    // Redirect back to players list after a short delay
                    setTimeout(() => {
                        window.location.href = `/admin/sessions/${sessionPath}/players`;
                    }, 1500);
                } else {
                    throw new Error(data.message || 'Failed to delete player');
                }
            } catch (error) {
                console.error('Delete error:', error);
                showMessage('Error deleting player: ' + error.message, 'error');
                
                // Reset button
                confirmDeleteBtn.disabled = false;
                confirmDeleteBtn.innerHTML = '<i class="fas fa-trash-alt me-1"></i>Delete Player';
            }
        });
    }
    
    // Helper function to show messages (similar to base.html showMessage)
    function showMessage(message, type = 'success') {
        const container = getOrCreateMessageContainer();
        const messageDiv = document.createElement('div');
        
        // Remove Bootstrap classes that might cause transparency
        messageDiv.className = 'custom-alert';
        
        // Add completely solid background and better styling
        const alertType = type === 'error' ? 'danger' : type;
        const isDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        if (alertType === 'success') {
            if (isDarkMode) {
                messageDiv.style.backgroundColor = '#1e5128'; // Solid dark green
                messageDiv.style.borderColor = '#28a745';
                messageDiv.style.color = '#d4f7dc';
            } else {
                messageDiv.style.backgroundColor = '#d4edda'; // Solid light green
                messageDiv.style.borderColor = '#c3e6cb';
                messageDiv.style.color = '#155724';
            }
        } else if (alertType === 'danger') {
            if (isDarkMode) {
                messageDiv.style.backgroundColor = '#5a1a1a'; // Solid dark red
                messageDiv.style.borderColor = '#dc3545';
                messageDiv.style.color = '#f8d7da';
            } else {
                messageDiv.style.backgroundColor = '#f8d7da'; // Solid light red
                messageDiv.style.borderColor = '#f5c6cb';
                messageDiv.style.color = '#721c24';
            }
        }
        
        // Ensure completely solid styling
        messageDiv.style.opacity = '1';
        messageDiv.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.3)';
        messageDiv.style.border = '2px solid';
        messageDiv.style.borderRadius = '6px';
        messageDiv.style.padding = '1rem 1.5rem';
        messageDiv.style.fontWeight = '500';
        messageDiv.style.textAlign = 'center';
        
        // No close button - just the message
        messageDiv.textContent = message;
        
        container.innerHTML = '';
        container.appendChild(messageDiv);
        
        // Auto-hide after 4 seconds
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.parentNode.removeChild(messageDiv);
            }
        }, 4000);
    }
    
    function getOrCreateMessageContainer() {
        let container = document.getElementById('message-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'message-container';
            container.style.position = 'fixed';
            container.style.top = '20px';
            container.style.left = '50%';
            container.style.transform = 'translateX(-50%)';
            container.style.zIndex = '10000';
            container.style.minWidth = '300px';
            document.body.appendChild(container);
        }
        return container;
    }
});
</script>
{% endblock %}